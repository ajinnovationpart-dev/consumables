<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ì‹ ì²­ ë“±ë¡</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <?!= include('Stylesheet'); ?>
  <script>
    // ìµœìš°ì„  ë¡œê·¸ - HTML ë¡œë“œ ì‹œì‘
    console.log('ğŸ”µ NewRequestPage: HTML loaded, waiting for scripts...');
  </script>
</head>
<body>
  <script>
    // ë‘ ë²ˆì§¸ ë¡œê·¸ - Body ì‹œì‘
    console.log('ğŸ”µ NewRequestPage: Body loaded');
  </script>
  <!-- í—¤ë” -->
  <nav class="navbar navbar-dark bg-primary mb-3">
    <div class="container-fluid px-2">
      <span class="navbar-brand mb-0">ğŸ  ë¶€í’ˆë°œì£¼</span>
      <div class="d-flex align-items-center">
        <span class="text-white d-none d-md-inline me-2 small">
          ğŸ‘¤ <span id="headerUserName"></span> (<span id="headerUserTeam"></span>)
        </span>
        <button class="btn btn-sm btn-outline-light" onclick="goBack()">â† ë’¤ë¡œ</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid px-2 mt-2">
    <div class="d-flex align-items-center mb-3">
      <h2 class="h4 mb-0">ì‹ ì²­ ë“±ë¡</h2>
    </div>

    <form id="requestForm" onsubmit="handleSubmit(event)">
      <!-- ì‹ ì²­ì ì •ë³´ (ì½ê¸° ì „ìš©) -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">ğŸ“‹ ì‹ ì²­ì ì •ë³´ (ìë™ ì…ë ¥)</h5>
        </div>
        <div class="card-body">
          <div class="row g-2">
            <div class="col-12 col-md-4 mb-2 mb-md-3">
              <label class="form-label">ì´ë¦„</label>
              <input type="text" class="form-control" id="requesterName" readonly>
            </div>
            <div class="col-12 col-md-4 mb-2 mb-md-3">
              <label class="form-label">ì†Œì†íŒ€</label>
              <input type="text" class="form-control" id="requesterTeam" readonly>
            </div>
            <div class="col-12 col-md-4 mb-2 mb-md-3">
              <label class="form-label">ì§€ì—­</label>
              <input type="text" class="form-control" id="requesterRegion" readonly>
            </div>
          </div>
        </div>
      </div>

      <!-- ë¶€í’ˆ ì •ë³´ -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">ğŸ”§ ë¶€í’ˆ ì •ë³´</h5>
        </div>
        <div class="card-body">
          <div class="row g-2">
            <div class="col-12 col-md-6 mb-2 mb-md-3">
              <label class="form-label">
                í’ˆëª… <span class="text-danger">*</span>
              </label>
              <input type="text" 
                     class="form-control" 
                     id="itemName" 
                     placeholder="ì˜ˆ: ì—°ë£Œí•„í„°"
                     required>
              <div class="form-text small">ë°œì£¼í•  ë¶€í’ˆì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</div>
            </div>
            
            <div class="col-12 col-md-6 mb-2 mb-md-3">
              <label class="form-label">ê·œê²©</label>
              <input type="text" 
                     class="form-control" 
                     id="modelName" 
                     placeholder="ì˜ˆ: HD-123">
              <div class="form-text small">ë¶€í’ˆì˜ ê·œê²©ì„ ì…ë ¥í•˜ì„¸ìš”.</div>
            </div>
            
            <div class="col-12 col-md-4 mb-2 mb-md-3">
              <label class="form-label">
                ìˆ˜ëŸ‰ <span class="text-danger">*</span>
              </label>
              <input type="number" 
                     class="form-control" 
                     id="quantity" 
                     min="1" 
                     value="1"
                     required>
            </div>
            
            <div class="col-md-4 mb-3">
              <label class="form-label">
                ê´€ë¦¬ë²ˆí˜¸ <span class="text-danger">*</span>
              </label>
              <input type="text" 
                     class="form-control" 
                     id="assetNo" 
                     placeholder="ì˜ˆ: DS25C305"
                     required>
              <div class="form-text">ì¥ë¹„ì˜ ê´€ë¦¬ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>
            </div>
            
            <div class="col-md-4 mb-3">
              <label class="form-label">ì‹œë¦¬ì–¼ë²ˆí˜¸</label>
              <input type="text" 
                     class="form-control" 
                     id="serialNo" 
                     placeholder="ì˜ˆ: SN-12345">
            </div>
          </div>
        </div>
      </div>

      <!-- ìˆ˜ë ¹ ì •ë³´ -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">ğŸ“¦ ìˆ˜ë ¹ ì •ë³´</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">ë°°ì†¡ì§€</label>
              <select class="form-select" id="deliveryPlace">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ê¸°íƒ€">ê¸°íƒ€ (ì§ì ‘ ì…ë ¥)</option>
              </select>
            </div>
            
            <div class="col-md-6 mb-3" id="customDeliveryPlaceDiv" style="display:none;">
              <label class="form-label">ë°°ì†¡ì§€ ì§ì ‘ ì…ë ¥</label>
              <input type="text" 
                     class="form-control" 
                     id="customDeliveryPlace" 
                     placeholder="ë°°ì†¡ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            
            <div class="col-md-6 mb-3">
              <label class="form-label">ì „í™”ë²ˆí˜¸</label>
              <input type="tel" 
                     class="form-control" 
                     id="phone" 
                     placeholder="010-1234-5678"
                     pattern="[0-9]{3}-[0-9]{4}-[0-9]{4}">
              <div class="form-text">í˜•ì‹: 010-1234-5678</div>
            </div>
            
            <div class="col-md-6 mb-3">
              <label class="form-label">ì—…ì²´ëª…</label>
              <input type="text" 
                     class="form-control" 
                     id="company" 
                     placeholder="í˜‘ë ¥ ì—…ì²´ëª…">
            </div>
          </div>
        </div>
      </div>

      <!-- ì‚¬ì§„ ì²¨ë¶€ -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">ğŸ“· ì‚¬ì§„ ì²¨ë¶€ <span class="text-danger">*</span></h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <button type="button" class="btn btn-outline-primary me-2" onclick="capturePhoto()">
              ğŸ“· ì‚¬ì§„ ì´¬ì˜
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="selectFile()">
              ğŸ“ íŒŒì¼ ì„ íƒ
            </button>
            <input type="file" 
                   id="photoInput" 
                   accept="image/*" 
                   capture="environment"
                   style="display:none;"
                   onchange="handlePhotoSelect(event)"
                   required>
          </div>
          
          <div id="photoPreviewContainer" style="display:none;">
            <div class="position-relative d-inline-block">
              <img id="photoPreview" 
                   class="img-thumbnail" 
                   style="max-width: 300px; max-height: 300px;">
              <button type="button" 
                      class="btn btn-sm btn-danger position-absolute top-0 end-0"
                      onclick="removePhoto()">
                âœ•
              </button>
            </div>
            <p class="mt-2">
              <span id="photoFileName"></span> 
              (<span id="photoFileSize"></span>)
            </p>
          </div>
          
          <div class="alert alert-info mt-3">
            <small>
              ğŸ’¡ íŒ: ë¶€í’ˆ ë˜ëŠ” ì¥ë¹„ì˜ ì‚¬ì§„ì„ ì²¨ë¶€í•´ì£¼ì„¸ìš”. 
              ì‚¬ì§„ì€ 5MB ì´í•˜, JPG/PNG í˜•ì‹ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            </small>
          </div>
        </div>
      </div>

      <!-- ë¹„ê³  -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">ğŸ“ ë¹„ê³ </h5>
        </div>
        <div class="card-body">
          <textarea class="form-control" 
                    id="remarks" 
                    rows="4"
                    placeholder="ì¶”ê°€ë¡œ ì „ë‹¬í•  ë‚´ìš©ì´ ìˆìœ¼ë©´ ì…ë ¥í•˜ì„¸ìš”."></textarea>
        </div>
      </div>

      <!-- ì œì¶œ ë²„íŠ¼ -->
      <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-5">
        <button type="button" class="btn btn-secondary" onclick="goBack()">
          ì·¨ì†Œ
        </button>
        <button type="submit" class="btn btn-primary btn-lg">
          ì‹ ì²­í•˜ê¸°
        </button>
      </div>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    console.log('ğŸ”µ NewRequestPage: Bootstrap loaded');
  </script>
  <?!= include('JavaScript'); ?>
  <script>
    console.log('ğŸ”µ NewRequestPage: JavaScript.html included');
    console.log('ğŸ”µ Checking callServer:', typeof callServer);
    console.log('ğŸ”µ Checking showLoading:', typeof showLoading);
    
    // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬ - ë¹ˆ í˜ì´ì§€ ë°©ì§€
    window.addEventListener('error', function(e) {
      console.error('ğŸ”´ Global error caught:', e.error || e.message);
      console.error('ğŸ”´ Error details:', e);
      const errorDiv = document.createElement('div');
      errorDiv.className = 'alert alert-danger m-4';
      errorDiv.style.position = 'fixed';
      errorDiv.style.top = '20px';
      errorDiv.style.left = '50%';
      errorDiv.style.transform = 'translateX(-50%)';
      errorDiv.style.zIndex = '9999';
      errorDiv.style.maxWidth = '600px';
      errorDiv.innerHTML = `
        <h5>âš ï¸ í˜ì´ì§€ ë¡œë”© ì˜¤ë¥˜</h5>
        <p><strong>ì˜¤ë¥˜:</strong> ${e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>
        <p><small>${e.filename || ''} ${e.lineno ? '(' + e.lineno + ':' + e.colno + ')' : ''}</small></p>
        <button class="btn btn-primary btn-sm" onclick="window.location.reload()">ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn btn-secondary btn-sm" onclick="history.back()">ë’¤ë¡œê°€ê¸°</button>
      `;
      document.body.appendChild(errorDiv);
    });

    let currentUser = null;
    let photoFile = null;

    // ì„¸ì…˜ í† í° ê°€ì ¸ì˜¤ê¸°
    function getSessionToken() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('token') || sessionStorage.getItem('sessionToken');
    }

    console.log('ğŸ”µ NewRequestPage: Functions defined');

    // í˜ì´ì§€ ì´ˆê¸°í™”
    window.onload = async function() {
      try {
        const startTime = performance.now();
        console.log('âœ… NewRequestPage: Initializing...');
        
        const sessionToken = getSessionToken();
        if (!sessionToken) {
          window.location.href = '?page=login';
          return;
        }

        showLoading('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

        // âœ… ì‚¬ìš©ì ì •ë³´ ìºì‹œ í™•ì¸
        let currentUser = sessionStorage.getItem('currentUser');
        if (currentUser) {
          currentUser = JSON.parse(currentUser);
          console.log('âœ… Using cached user info');
        } else {
          currentUser = await callServer('getCurrentUser', sessionToken);
          if (currentUser) {
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
          }
        }
        
        if (!currentUser) {
          hideLoading();
          window.location.href = '?page=login';
          return;
        }

        // í™”ë©´ì— ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
        document.getElementById('requesterName').value = currentUser.name || '';
        document.getElementById('requesterTeam').value = currentUser.team || '';
        document.getElementById('requesterRegion').value = currentUser.region || '';
        document.getElementById('headerUserName').textContent = currentUser.name || '';
        document.getElementById('headerUserTeam').textContent = currentUser.team || '';

        // íŒŒíŠ¸ë³„ ë°°ì†¡ì§€ ëª©ë¡ ë¡œë“œ
        try {
          const deliveryPlaces = await callServer('getDeliveryPlaces', currentUser.team, sessionToken);
          const deliverySelect = document.getElementById('deliveryPlace');
          
          // ì‘ë‹µ íƒ€ì… ê²€ì¦
          if (!Array.isArray(deliveryPlaces)) {
            console.error('Invalid deliveryPlaces response:', deliveryPlaces);
            // ë¹ˆ ë°°ì—´ë¡œ ì²˜ë¦¬
          } else {
            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì„ íƒí•˜ì„¸ìš”, ê¸°íƒ€ ì œì™¸)
            while (deliverySelect.options.length > 2) {
              deliverySelect.remove(1); // ì²« ë²ˆì§¸ ì˜µì…˜(ì„ íƒí•˜ì„¸ìš”)ê³¼ ë§ˆì§€ë§‰ ì˜µì…˜(ê¸°íƒ€) ì œì™¸
            }
            
            // íŒŒíŠ¸ë³„ ë°°ì†¡ì§€ ì¶”ê°€
            if (deliveryPlaces.length > 0) {
            deliveryPlaces.forEach(place => {
              const option = document.createElement('option');
              option.value = place['ë°°ì†¡ì§€ëª…'] || place.name;
              option.textContent = place['ë°°ì†¡ì§€ëª…'] || place.name;
              deliverySelect.insertBefore(option, deliverySelect.lastElementChild); // "ê¸°íƒ€" ì•ì— ì¶”ê°€
            });
            }
          }
          
          // ì‚¬ìš©ìì˜ ìµœê·¼ ì‹ ì²­ ë‚´ì—­ì—ì„œ ê°€ì¥ ë§ì´ ì‚¬ìš©í•œ ë°°ì†¡ì§€ ìë™ ì„ íƒ
          const myRequests = await callServer('getMyRequests', {}, sessionToken);
          if (Array.isArray(myRequests) && myRequests.length > 0) {
            // ë°°ì†¡ì§€ë³„ ì‚¬ìš© ë¹ˆë„ ê³„ì‚°
            const deliveryPlaceCount = {};
            myRequests.forEach(req => {
              if (req.deliveryPlace) {
                deliveryPlaceCount[req.deliveryPlace] = (deliveryPlaceCount[req.deliveryPlace] || 0) + 1;
              }
            });
            
            // ê°€ì¥ ë§ì´ ì‚¬ìš©í•œ ë°°ì†¡ì§€ ì°¾ê¸°
            let mostUsedPlace = null;
            let maxCount = 0;
            Object.keys(deliveryPlaceCount).forEach(place => {
              if (deliveryPlaceCount[place] > maxCount) {
                maxCount = deliveryPlaceCount[place];
                mostUsedPlace = place;
              }
            });
            
            // ìë™ ì„ íƒ
            if (mostUsedPlace) {
              // ì˜µì…˜ ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸
              let found = false;
              for (let i = 0; i < deliverySelect.options.length; i++) {
                if (deliverySelect.options[i].value === mostUsedPlace) {
                  deliverySelect.value = mostUsedPlace;
                  found = true;
                  break;
                }
              }
              
              // ì˜µì…˜ ëª©ë¡ì— ì—†ìœ¼ë©´ "ê¸°íƒ€" ì„ íƒí•˜ê³  ì§ì ‘ ì…ë ¥ í•„ë“œì— ê°’ ì„¤ì •
              if (!found) {
                deliverySelect.value = 'ê¸°íƒ€';
                document.getElementById('customDeliveryPlaceDiv').style.display = 'block';
                document.getElementById('customDeliveryPlace').value = mostUsedPlace;
              }
            }
          }
        } catch (error) {
          console.log('Failed to load delivery places:', error);
          // ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
        }

        hideLoading();
        
        const loadTime = (performance.now() - startTime).toFixed(0);
        console.log(`âœ… NewRequestPage loaded in ${loadTime}ms`);
      } catch (error) {
        console.error('NewRequestPage init error:', error);
        hideLoading();
        showToast('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'danger');
      }
    };

    // ë°°ì†¡ì§€ ì„ íƒ ì´ë²¤íŠ¸
    document.getElementById('deliveryPlace').addEventListener('change', function() {
      const customDiv = document.getElementById('customDeliveryPlaceDiv');
      if (this.value === 'ê¸°íƒ€') {
        customDiv.style.display = 'block';
        document.getElementById('customDeliveryPlace').required = true;
      } else {
        customDiv.style.display = 'none';
        document.getElementById('customDeliveryPlace').required = false;
      }
    });

    // ì „í™”ë²ˆí˜¸ ìë™ í¬ë§·íŒ… (ìˆ«ìë§Œ ì…ë ¥ ì‹œ - ìë™ ì¶”ê°€)
    document.getElementById('phone').addEventListener('input', function(e) {
      let value = e.target.value.replace(/[^0-9]/g, ''); // ìˆ«ìë§Œ ì¶”ì¶œ
      
      if (value.length > 0) {
        if (value.length <= 3) {
          value = value;
        } else if (value.length <= 7) {
          value = value.slice(0, 3) + '-' + value.slice(3);
        } else if (value.length <= 11) {
          value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7);
        } else {
          value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
        }
      }
      
      e.target.value = value;
    });

    // ì‚¬ì§„ ì´¬ì˜
    function capturePhoto() {
      const input = document.getElementById('photoInput');
      input.setAttribute('capture', 'environment');
      input.click();
    }

    // íŒŒì¼ ì„ íƒ
    function selectFile() {
      const input = document.getElementById('photoInput');
      input.removeAttribute('capture');
      input.click();
    }

    // ì‚¬ì§„ ì„ íƒ ì²˜ë¦¬
    async function handlePhotoSelect(event) {
      const file = event.target.files[0];
      
      if (!file) return;
      
      // íŒŒì¼ í¬ê¸° ê²€ì¦
      const maxSize = 5 * 1024 * 1024; // 5MB
      if (file.size > maxSize) {
        showToast('íŒŒì¼ í¬ê¸°ëŠ” 5MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'danger');
        event.target.value = '';
        return;
      }
      
      // íŒŒì¼ í˜•ì‹ ê²€ì¦
      if (!['image/jpeg', 'image/jpg', 'image/png'].includes(file.type)) {
        showToast('JPG, PNG í˜•ì‹ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'danger');
        event.target.value = '';
        return;
      }
      
      try {
        photoFile = file;
        
        // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('photoPreview').src = e.target.result;
          document.getElementById('photoFileName').textContent = file.name;
          document.getElementById('photoFileSize').textContent = formatFileSize(file.size);
          document.getElementById('photoPreviewContainer').style.display = 'block';
        };
        reader.readAsDataURL(file);
        
      } catch (error) {
        showToast('ì´ë¯¸ì§€ ì²˜ë¦¬ ì‹¤íŒ¨: ' + error.message, 'danger');
      }
    }

    // ì‚¬ì§„ ì‚­ì œ
    function removePhoto() {
      document.getElementById('photoInput').value = '';
      document.getElementById('photoPreviewContainer').style.display = 'none';
      photoFile = null;
    }

    // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' Bytes';
      if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
      return (bytes / 1048576).toFixed(2) + ' MB';
    }

    // í¼ ì œì¶œ
    async function handleSubmit(event) {
      event.preventDefault();
      
      try {
        console.log('handleSubmit: Starting...');
        
        // ìœ íš¨ì„± ê²€ì¦
        if (!validateForm()) {
          console.log('Form validation failed');
          return;
        }
        
        const sessionToken = getSessionToken();
        if (!sessionToken) {
          console.warn('No session token for submit');
          showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
          window.location.href = '?page=login';
          return;
        }
        
        showLoading('ì‹ ì²­ ì²˜ë¦¬ ì¤‘...');
        
        // í¼ ë°ì´í„° ìˆ˜ì§‘
        const formData = {
          itemName: document.getElementById('itemName').value.trim(),
          modelName: document.getElementById('modelName').value.trim(),
          quantity: parseInt(document.getElementById('quantity').value),
          assetNo: document.getElementById('assetNo').value.trim(),
          serialNo: document.getElementById('serialNo').value.trim(),
          deliveryPlace: getDeliveryPlace(),
          phone: document.getElementById('phone').value.trim(),
          company: document.getElementById('company').value.trim(),
          remarks: document.getElementById('remarks').value.trim()
        };
        
        console.log('Form data:', formData);
        
        // ì‚¬ì§„ Base64 ì¸ì½”ë”©
        if (photoFile) {
          console.log('Encoding photo to Base64...');
          formData.photoBase64 = await fileToBase64(photoFile);
          console.log('Photo encoded, size:', formData.photoBase64.length);
        }
        
        // ì„œë²„ ì „ì†¡
        console.log('Calling createRequest API...');
        const result = await callServer('createRequest', formData, sessionToken);
        console.log('createRequest result:', result);
        
        // ì¤‘ë³µ ì ‘ìˆ˜ ì²´í¬
        if (result.isDuplicate) {
          hideLoading();
          const duplicateMessage = `ì¤‘ë³µ ì ‘ìˆ˜ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì‹ ì²­ë²ˆí˜¸: ${result.duplicateRequestNo}\n\nê¸°ì¡´ ì‹ ì²­ì„ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
          if (confirm(duplicateMessage)) {
            // ê¸°ì¡´ ì‹ ì²­ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
            sessionStorage.setItem('pendingRequestNo', result.duplicateRequestNo);
            sessionStorage.setItem('pendingPage', 'detail');
            const baseUrl = await callServer('getWebAppUrl');
            if (baseUrl) {
              window.top.location.href = baseUrl + '?page=detail&requestNo=' + result.duplicateRequestNo + '&token=' + encodeURIComponent(sessionToken);
            }
          }
          return;
        }
        
        if (result.success) {
          console.log('Request created successfully:', result.requestNo);
          
          // ì„±ê³µ ë©”ì‹œì§€ì™€ í•¨ê»˜ ì¦‰ì‹œ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
          hideLoading();
          
          // ì„±ê³µ ëª¨ë‹¬ í‘œì‹œ
          const modal = document.createElement('div');
          modal.className = 'modal fade show';
          modal.style.display = 'block';
          modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
          modal.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header bg-success text-white">
                  <h5 class="modal-title">âœ… ì‹ ì²­ ì™„ë£Œ</h5>
                </div>
                <div class="modal-body text-center">
                  <p class="mb-2"><strong>ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</strong></p>
                  <p class="text-muted">ì‹ ì²­ë²ˆí˜¸: <strong>${result.requestNo}</strong></p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" onclick="navigateToDashboard()">
                    ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
                  </button>
                </div>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          
          return; // ì—¬ê¸°ì„œ ì¢…ë£Œ
        } else {
          console.error('Request creation failed:', result.message);
          showToast('ì‹ ì²­ ì‹¤íŒ¨: ' + result.message, 'danger');
        }
        
      } catch (error) {
        console.error('handleSubmit error:', error);
        console.error('Error stack:', error.stack);
        showToast('ì‹ ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'danger');
      } finally {
        hideLoading();
      }
    }

    // ìœ íš¨ì„± ê²€ì¦
    function validateForm() {
      // í’ˆëª… ê²€ì¦
      const itemName = document.getElementById('itemName').value.trim();
      if (!itemName) {
        showToast('í’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        document.getElementById('itemName').focus();
        return false;
      }
      
      // ìˆ˜ëŸ‰ ê²€ì¦
      const quantity = parseInt(document.getElementById('quantity').value);
      if (!quantity || quantity < 1) {
        showToast('ìˆ˜ëŸ‰ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'warning');
        document.getElementById('quantity').focus();
        return false;
      }
      
      // ê´€ë¦¬ë²ˆí˜¸ ê²€ì¦
      const assetNo = document.getElementById('assetNo').value.trim();
      if (!assetNo) {
        showToast('ê´€ë¦¬ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        document.getElementById('assetNo').focus();
        return false;
      }
      
      // ì‚¬ì§„ ê²€ì¦
      if (!photoFile) {
        showToast('ì‚¬ì§„ì„ ì²¨ë¶€í•´ì£¼ì„¸ìš”.', 'warning');
        return false;
      }
      
      // ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì¦ (ì…ë ¥ëœ ê²½ìš°)
      const phone = document.getElementById('phone').value.trim();
      if (phone) {
        const phoneRegex = /^01[0-9]-[0-9]{4}-[0-9]{4}$/;
        if (!phoneRegex.test(phone)) {
          showToast('ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì˜ˆ: 010-1234-5678)', 'warning');
          document.getElementById('phone').focus();
          return false;
        }
      }
      
      return true;
    }

    // ë°°ì†¡ì§€ ê°’ ê°€ì ¸ì˜¤ê¸°
    function getDeliveryPlace() {
      const select = document.getElementById('deliveryPlace');
      if (select.value === 'ê¸°íƒ€') {
        return document.getElementById('customDeliveryPlace').value.trim();
      }
      return select.value;
    }

    // File to Base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ì„±ê³µ ë©”ì‹œì§€
    function showSuccess(message) {
      const modal = document.createElement('div');
      modal.className = 'modal fade';
      modal.id = 'successModal';
      modal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-success text-white">
              <h5 class="modal-title">âœ… ì‹ ì²­ ì™„ë£Œ</h5>
            </div>
            <div class="modal-body text-center">
              <p>${message}</p>
              <p class="text-muted">ì ì‹œ í›„ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™í•©ë‹ˆë‹¤...</p>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      const bsModal = new bootstrap.Modal(modal);
      bsModal.show();
    }

    async function goBack() {
      try {
        const sessionToken = getSessionToken();
        const baseUrl = await callServer('getWebAppUrl');
        if (!baseUrl) return;
        
        const targetUrl = baseUrl + '?page=dashboard&token=' + encodeURIComponent(sessionToken);
        
        if (window.top && window.top !== window) {
          window.top.location.href = targetUrl;
        } else {
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('goBack error:', error);
        window.location.href = '?page=login';
      }
    }

    async function navigateToDashboard() {
      try {
        console.log('navigateToDashboard: Starting...');
        const sessionToken = getSessionToken();
        
        // ì„œë²„ì—ì„œ ì‹¤ì œ ì›¹ ì•± URL ê°€ì ¸ì˜¤ê¸°
        const baseUrl = await callServer('getWebAppUrl');
        console.log('Base URL from server:', baseUrl);
        
        if (!baseUrl) {
          console.error('Failed to get web app URL');
          showToast('í˜ì´ì§€ ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
          return;
        }
        
        const targetUrl = baseUrl + '?page=dashboard&token=' + encodeURIComponent(sessionToken);
        console.log('Target URL:', targetUrl);
        
        // ì§ì ‘ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ì‚¬ìš©ì í´ë¦­ ì´ë²¤íŠ¸ ë‚´ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ ì•ˆì „)
        if (window.top && window.top !== window) {
          console.log('Redirecting parent window...');
          window.top.location.href = targetUrl;
        } else {
          console.log('Redirecting current window...');
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('navigateToDashboard error:', error);
        showToast('í˜ì´ì§€ ì´ë™ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'danger');
      }
    }

    // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ í™•ì¸
    console.log('âœ“ NewRequestPage script loaded');
  </script>
</body>
</html>

