<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¶€í’ˆ ë°œì£¼ ê´€ë¦¬</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* ê´€ë¦¬ì í˜ì´ì§€ëŠ” PC ì „ìš© ìŠ¤íƒ€ì¼ ì ìš© */
    body {
      font-size: 14px !important;
    }
    
    .container-fluid {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ ì œê±° */
    @media (max-width: 768px) {
      body {
        font-size: 14px !important;
      }
      
      input, .form-control, .form-select, textarea {
        font-size: 14px !important;
        min-height: auto !important;
        padding: 0.375rem 0.75rem !important;
      }
      
      button, .btn {
        font-size: 14px !important;
        min-height: auto !important;
        padding: 0.375rem 0.75rem !important;
      }
    }
  </style>
</head>
<body>
  <!-- í—¤ë” -->
  <nav class="navbar navbar-dark bg-primary mb-3">
    <div class="container-fluid px-2">
      <span class="navbar-brand mb-0">ğŸ  ë¶€í’ˆë°œì£¼ (ê´€ë¦¬ì)</span>
      <div class="d-flex align-items-center">
        <span class="text-white d-none d-md-inline me-2 small">
          ğŸ‘¤ <span id="headerUserName"></span>
        </span>
        <button class="btn btn-sm btn-outline-light" onclick="goBack()">â† ë’¤ë¡œ</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid px-2 mt-2">
    <h2 class="h4 mb-3">ğŸ“‹ ì „ì²´ ì‹ ì²­ ëª©ë¡</h2>
    
    <!-- í•„í„° -->
    <div class="filter-section mb-3">
      <div class="row g-2">
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label small">ìƒíƒœ</label>
          <select class="form-select" id="filterStatus">
            <option value="">ì „ì²´ ìƒíƒœ</option>
          </select>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label small">ì§€ì—­</label>
          <select class="form-select" id="filterRegion">
            <option value="">ì „ì²´ ì§€ì—­</option>
          </select>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label small">ì‹œì‘ì¼</label>
          <input type="date" class="form-control" id="filterDateFrom">
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label small">ì¢…ë£Œì¼</label>
          <input type="date" class="form-control" id="filterDateTo">
        </div>
        <div class="col-md-12">
          <button class="btn btn-primary" onclick="applyFilter()">í•„í„° ì ìš©</button>
          <button class="btn btn-secondary" onclick="resetFilter()">ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>
    
    <!-- ì‹ ì²­ ëª©ë¡ -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">ì‹ ì²­ ëª©ë¡</h5>
        <div>
          <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
          <label for="selectAll" class="ms-2">ì „ì²´ ì„ íƒ</label>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover" id="adminRequestsTable">
            <thead>
              <tr>
                <th width="50"><input type="checkbox" id="selectAllHeader" onchange="toggleSelectAll()"></th>
                <th>ì‹ ì²­ë²ˆí˜¸</th>
                <th>ìƒíƒœ</th>
                <th>ì‹ ì²­ì¼</th>
                <th>ì‹ ì²­ì</th>
                <th>ì§€ì—­</th>
                <th>í’ˆëª…</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>ê´€ë¦¬ë²ˆí˜¸</th>
                <th>ë‹´ë‹¹ì</th>
                <th>ì‚¬ì§„</th>
                <th>ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="adminRequestsBody">
              <tr>
                <td colspan="12" class="text-center">ë¡œë”© ì¤‘...</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- í˜ì´ì§• -->
        <nav>
          <ul class="pagination justify-content-center" id="pagination">
          </ul>
        </nav>
      </div>
    </div>
    
    <!-- ì¼ê´„ ì‘ì—… ë²„íŠ¼ (ê³ ì • í•˜ë‹¨) -->
    <div class="fixed-bottom-actions">
      <div class="container-fluid">
        <div class="d-flex gap-2">
          <button class="btn btn-info" onclick="bulkAssign()">ë‹´ë‹¹ì ë°°ì •</button>
          <button class="btn btn-warning" onclick="bulkUpdateStatus('ì ‘ìˆ˜ì¤‘')">ì ‘ìˆ˜ì¤‘</button>
          <button class="btn btn-info" onclick="bulkUpdateStatus('ë°œì£¼ì§„í–‰')">ë°œì£¼ì§„í–‰</button>
          <button class="btn btn-success" onclick="bulkUpdateStatus('ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)')">ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)</button>
          <button class="btn btn-primary" onclick="bulkUpdateStatus('ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)')">ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)</button>
          <button class="btn btn-success" onclick="bulkUpdateStatus('ì²˜ë¦¬ì™„ë£Œ')">ì²˜ë¦¬ì™„ë£Œ</button>
          <button class="btn btn-secondary" onclick="bulkUpdateStatus('ì ‘ìˆ˜ì·¨ì†Œ')">ì ‘ìˆ˜ì·¨ì†Œ</button>
          <button class="btn btn-danger" onclick="bulkCancel()">ì·¨ì†Œ</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ìƒì„¸ ëª¨ë‹¬ -->
  <div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ì‹ ì²­ ìƒì„¸</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="detailModalBody">
          ë¡œë”© ì¤‘...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <?!= include('JavaScript'); ?>
  <script>
    // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬ - ë¹ˆ í˜ì´ì§€ ë°©ì§€
    window.addEventListener('error', function(e) {
      console.error('Global error caught:', e.error || e.message);
      const errorDiv = document.createElement('div');
      errorDiv.className = 'alert alert-danger m-4';
      errorDiv.style.position = 'fixed';
      errorDiv.style.top = '20px';
      errorDiv.style.left = '50%';
      errorDiv.style.transform = 'translateX(-50%)';
      errorDiv.style.zIndex = '9999';
      errorDiv.style.maxWidth = '600px';
      errorDiv.innerHTML = `
        <h5>âš ï¸ í˜ì´ì§€ ë¡œë”© ì˜¤ë¥˜</h5>
        <p><strong>ì˜¤ë¥˜:</strong> ${e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>
        <button class="btn btn-primary btn-sm" onclick="window.location.reload()">ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn btn-secondary btn-sm" onclick="window.location.href='?page=admin-dashboard'">ëŒ€ì‹œë³´ë“œ</button>
      `;
      document.body.appendChild(errorDiv);
    });

    // ì„¸ì…˜ í† í° ê°€ì ¸ì˜¤ê¸°
    function getSessionToken() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('token') || sessionStorage.getItem('sessionToken');
    }
    let allRequests = [];
    let currentFilter = {};
    let currentPage = 1;
    const itemsPerPage = 20; // í˜ì´ì§€ë‹¹ í•­ëª© ìˆ˜
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.onload = async function() {
      try {
        const startTime = performance.now();
        console.log('AdminPage: Initializing...');
        const sessionToken = getSessionToken();
        console.log('Session token:', sessionToken ? 'Present' : 'Missing');
        
        if (!sessionToken) {
          console.warn('No session token, redirecting to login');
          window.location.href = '?page=login';
          return;
        }

        showLoading('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        
        // ì‚¬ìš©ì ì •ë³´ í™•ì¸
        console.log('Checking user role...');
        const user = await callServer('getCurrentUser', sessionToken);
        console.log('Current user:', user);
        
        if (!user || user.role !== 'ê´€ë¦¬ì') {
          console.warn('Not admin or no user, redirecting to login');
          hideLoading();
          window.location.href = '?page=login';
          return;
        }
        
        // í—¤ë”ì— ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
        if (document.getElementById('headerUserName')) {
          document.getElementById('headerUserName').textContent = user.name || 'ê´€ë¦¬ì';
        }
        
        // ì½”ë“œ ëª©ë¡ ë¡œë“œ
        console.log('Loading code list...');
        const codes = await callServer('getCodeList');
        console.log('Codes:', codes);
        
        if (codes) {
          // ìƒíƒœ í•„í„°
          const statusSelect = document.getElementById('filterStatus');
          if (codes.statuses && Array.isArray(codes.statuses)) {
            console.log('Adding status options:', codes.statuses.length);
            codes.statuses.forEach(status => {
              const option = document.createElement('option');
              option.value = status.name;
              option.textContent = status.name;
              statusSelect.appendChild(option);
            });
          }
          
          // ì§€ì—­ í•„í„°
          const regionSelect = document.getElementById('filterRegion');
          if (codes.regions && Array.isArray(codes.regions)) {
            console.log('Adding region options:', codes.regions.length);
            codes.regions.forEach(region => {
              const option = document.createElement('option');
              option.value = region.name;
              option.textContent = region.name;
              regionSelect.appendChild(option);
            });
          }
        }
        
        // ëŒ€ì‹œë³´ë“œì—ì„œ ìƒíƒœ í•„í„°ê°€ ì „ë‹¬ëœ ê²½ìš° ì ìš© (URL íŒŒë¼ë¯¸í„° ìš°ì„ )
        const urlParams = new URLSearchParams(window.location.search);
        let statusFilter = urlParams.get('status') || sessionStorage.getItem('adminStatusFilter');
        
        if (statusFilter) {
          document.getElementById('filterStatus').value = statusFilter;
          sessionStorage.removeItem('adminStatusFilter');
          // í•„í„°ê°€ ì„¤ì •ëœ ê²½ìš° ìë™ìœ¼ë¡œ ì ìš©
          await loadAllRequests({ status: statusFilter });
        } else {
          // ì‹ ì²­ ëª©ë¡ ë¡œë“œ        
          await loadAllRequests();
        }
        
        hideLoading();
        
        const loadTime = (performance.now() - startTime).toFixed(0);
        console.log(`âœ… AdminPage loaded in ${loadTime}ms`);
      } catch (error) {
        console.error('AdminPage init error:', error);
        console.error('Error stack:', error.stack);
        hideLoading();
        handleError(error);
      }
    };
    
    // ì „ì²´ ì‹ ì²­ ëª©ë¡ ë¡œë“œ (ì„œë²„ ì¸¡ í•„í„°ë§ ë° í˜ì´ì§• ì‚¬ìš©)
    async function loadAllRequests(filter = {}) {
      try {
        console.log('loadAllRequests: filter =', filter);
        currentFilter = filter;
        const sessionToken = getSessionToken();
        
        // ì„œë²„ ì¸¡ í•„í„°ë§ ë° í˜ì´ì§• ì˜µì…˜
        const serverFilter = {
          status: filter.status || '',
          region: filter.region || '',
          dateFrom: filter.dateFrom || '',
          dateTo: filter.dateTo || '',
          page: currentPage || 1,
          pageSize: itemsPerPage || 20,
          sortBy: 'requestDate',
          sortOrder: 'desc'
        };
        
        console.log('Calling getAllRequests API with server filter and pagination...');
        const allReqs = await callServer('getAllRequests', serverFilter, sessionToken);
        console.log('getAllRequests result:', allReqs ? allReqs.length + ' items' : 'null');
        
        if (!allReqs || !Array.isArray(allReqs)) {
          console.error('Invalid response from getAllRequests:', allReqs);
          allRequests = [];
          renderAdminRequestsTable(allRequests);
          return;
        }
        
        // ì„œë²„ì—ì„œ ì´ë¯¸ í•„í„°ë§ ë° í˜ì´ì§•ëœ ë°ì´í„°ë¥¼ ë°›ìŒ
        allRequests = allReqs;
        renderAdminRequestsTable(allRequests);
      } catch (error) {
        console.error('loadAllRequests error:', error);
        handleError(error);
      }
    }
    
    // í…Œì´ë¸” ë Œë”ë§ (í˜ì´ì§• ì ìš©)
    function renderAdminRequestsTable(requests) {
      console.log('renderAdminRequestsTable: requests =', requests ? requests.length : 0);
      const tbody = document.getElementById('adminRequestsBody');
      tbody.innerHTML = '';
      
      if (!requests || requests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        document.getElementById('pagination').innerHTML = '';
        return;
      }
      
      // í˜ì´ì§• ê³„ì‚°
      const totalPages = Math.ceil(requests.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, requests.length);
      const pageRequests = requests.slice(startIndex, endIndex);
      
      // í˜„ì¬ í˜ì´ì§€ê°€ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ë§ˆì§€ë§‰ í˜ì´ì§€ë¡œ ì¡°ì •
      if (currentPage > totalPages && totalPages > 0) {
        currentPage = totalPages;
        const adjustedStartIndex = (currentPage - 1) * itemsPerPage;
        const adjustedEndIndex = Math.min(adjustedStartIndex + itemsPerPage, requests.length);
        const adjustedPageRequests = requests.slice(adjustedStartIndex, adjustedEndIndex);
        
        adjustedPageRequests.forEach(req => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="checkbox" class="request-check" value="${escapeHtml(req.requestNo)}"></td>
            <td>${escapeHtml(req.requestNo)}</td>
            <td>${createStatusBadge(req.status)}</td>
            <td>${escapeHtml(req.requestDate || '')}</td>
            <td>${escapeHtml(req.requester || '')}<br><small class="text-muted">${escapeHtml(req.team || '')}</small></td>
            <td>${escapeHtml(req.region || '')}</td>
            <td>${escapeHtml(req.itemName || '')}</td>
            <td>${req.quantity || 0}</td>
            <td>${escapeHtml(req.assetNo || '')}</td>
            <td>${escapeHtml(req.handler || '-')}</td>
            <td>
              ${req.photoUrl ? `<a href="${escapeHtml(req.photoUrl)}" target="_blank" class="btn btn-sm btn-info">ë³´ê¸°</a>` : '-'}
            </td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="showDetail('${req.requestNo}')">ìƒì„¸</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } else {
        // í˜„ì¬ í˜ì´ì§€ ë°ì´í„° ë Œë”ë§
        pageRequests.forEach(req => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="checkbox" class="request-check" value="${escapeHtml(req.requestNo)}"></td>
            <td>${escapeHtml(req.requestNo)}</td>
            <td>${createStatusBadge(req.status)}</td>
            <td>${escapeHtml(req.requestDate || '')}</td>
            <td>${escapeHtml(req.requester || '')}<br><small class="text-muted">${escapeHtml(req.team || '')}</small></td>
            <td>${escapeHtml(req.region || '')}</td>
            <td>${escapeHtml(req.itemName || '')}</td>
            <td>${req.quantity || 0}</td>
            <td>${escapeHtml(req.assetNo || '')}</td>
            <td>${escapeHtml(req.handler || '-')}</td>
            <td>
              ${req.photoUrl ? `<a href="${escapeHtml(req.photoUrl)}" target="_blank" class="btn btn-sm btn-info">ë³´ê¸°</a>` : '-'}
            </td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="showDetail('${req.requestNo}')">ìƒì„¸</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }
      
      // í˜ì´ì§• ë Œë”ë§
      renderPagination(totalPages, requests.length);
      
      console.log(`Table rendered: page ${currentPage}/${totalPages}, showing ${pageRequests.length} of ${requests.length} items`);
    }
    
    // í˜ì´ì§• ë Œë”ë§
    function renderPagination(totalPages, totalItems) {
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';
      
      if (totalPages <= 1) {
        // í˜ì´ì§€ê°€ 1ê°œ ì´í•˜ë©´ í˜ì´ì§• ìˆ¨ê¹€
        return;
      }
      
      // ì „ì²´ í•­ëª© ìˆ˜ í‘œì‹œ
      const infoLi = document.createElement('li');
      infoLi.className = 'page-item disabled';
      infoLi.innerHTML = `<span class="page-link">ì „ì²´ ${totalItems}ê±´</span>`;
      pagination.appendChild(infoLi);
      
      // ì´ì „ ë²„íŠ¼
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `
        <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
          â† ì´ì „
        </a>
      `;
      pagination.appendChild(prevLi);
      
      // í˜ì´ì§€ ë²ˆí˜¸
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);
      
      if (startPage > 1) {
        const firstLi = document.createElement('li');
        firstLi.className = 'page-item';
        firstLi.innerHTML = `
          <a class="page-link" href="#" onclick="changePage(1); return false;">1</a>
        `;
        pagination.appendChild(firstLi);
        
        if (startPage > 2) {
          const ellipsisLi = document.createElement('li');
          ellipsisLi.className = 'page-item disabled';
          ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
          pagination.appendChild(ellipsisLi);
        }
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `
          <a class="page-link" href="#" onclick="changePage(${i}); return false;">
            ${i}
          </a>
        `;
        pagination.appendChild(li);
      }
      
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const ellipsisLi = document.createElement('li');
          ellipsisLi.className = 'page-item disabled';
          ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
          pagination.appendChild(ellipsisLi);
        }
        
        const lastLi = document.createElement('li');
        lastLi.className = 'page-item';
        lastLi.innerHTML = `
          <a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a>
        `;
        pagination.appendChild(lastLi);
      }
      
      // ë‹¤ìŒ ë²„íŠ¼
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      nextLi.innerHTML = `
        <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
          ë‹¤ìŒ â†’
        </a>
      `;
      pagination.appendChild(nextLi);
    }
    
    // í˜ì´ì§€ ë³€ê²½
    function changePage(page) {
      currentPage = page;
      renderAdminRequestsTable(allRequests);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // í•„í„° ì ìš©
    async function applyFilter() {
      const filter = {
        status: document.getElementById('filterStatus').value || undefined,
        region: document.getElementById('filterRegion').value || undefined,
        dateFrom: document.getElementById('filterDateFrom').value || undefined,
        dateTo: document.getElementById('filterDateTo').value || undefined
      };
      
      showLoading('í•„í„° ì ìš© ì¤‘...');
      await loadAllRequests(filter);
      hideLoading();
    }
    
    // í•„í„° ì´ˆê¸°í™”
    function resetFilter() {
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterRegion').value = '';
      document.getElementById('filterDateFrom').value = '';
      document.getElementById('filterDateTo').value = '';
      applyFilter();
    }
    
    // ì „ì²´ ì„ íƒ/í•´ì œ
    function toggleSelectAll() {
      const checked = document.getElementById('selectAll').checked;
      document.querySelectorAll('.request-check').forEach(cb => {
        cb.checked = checked;
      });
    }
    
    // ì„ íƒëœ ì‹ ì²­ë²ˆí˜¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    function getSelectedRequests() {
      const selected = [];
      document.querySelectorAll('.request-check:checked').forEach(cb => {
        selected.push(cb.value);
      });
      return selected;
    }
    
    // ìƒì„¸ ë³´ê¸° - ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
    async function showDetail(requestNo) {
      try {
        console.log('showDetail called with requestNo:', requestNo);
        const sessionToken = getSessionToken();
        console.log('Session token:', sessionToken ? 'Present' : 'Missing');
        
        // âœ… sessionStorageì— íŒŒë¼ë¯¸í„° ì €ì¥ (OAuth ë¦¬ë‹¤ì´ë ‰ì…˜ ëŒ€ë¹„)
        sessionStorage.setItem('pendingRequestNo', requestNo);
        sessionStorage.setItem('pendingPage', 'admin-detail');
        console.log('Saved to sessionStorage:', { requestNo, page: 'admin-detail' });
        
        const baseUrl = await callServer('getWebAppUrl');
        console.log('Base URL:', baseUrl);
        
        if (!baseUrl) {
          showToast('í˜ì´ì§€ ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
          return;
        }
        
        const targetUrl = baseUrl + '?page=admin-detail&requestNo=' + encodeURIComponent(requestNo) + '&token=' + encodeURIComponent(sessionToken);
        console.log('Target URL:', targetUrl);
        console.log('Navigating to detail page...');
        
        if (window.top && window.top !== window) {
          window.top.location.href = targetUrl;
        } else {
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('showDetail error:', error);
        handleError(error);
      }
    }
    
    // ì¼ê´„ ìƒíƒœ ë³€ê²½
    async function bulkUpdateStatus(newStatus) {
      const selected = getSelectedRequests();
      if (selected.length === 0) {
        showToast('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
      }
      
      if (!confirm(`${selected.length}ê±´ì„ "${newStatus}" ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      
      try {
        const sessionToken = getSessionToken();
        showLoading('ì²˜ë¦¬ ì¤‘...');
        const result = await callServer('bulkUpdateStatus', selected, newStatus, '', sessionToken);
        hideLoading();
        
        if (result.success) {
          showToast(result.message, 'success');
          await loadAllRequests(currentFilter);
        } else {
          showToast(result.message || 'ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
        }
      } catch (error) {
        hideLoading();
        handleError(error);
      }
    }
    
    // ì¼ê´„ ì·¨ì†Œ
    async function bulkCancel() {
      await bulkUpdateStatus('ì ‘ìˆ˜ì·¨ì†Œ');
    }
    
    // ìƒíƒœ ë°°ì§€ ìƒì„±
    function createStatusBadge(status) {
      if (!status) return '<span class="badge bg-secondary">-</span>';
      
      const colors = {
        'ì ‘ìˆ˜ì¤‘': 'warning',
        'ë°œì£¼ì§„í–‰': 'primary',
        'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)': 'success',
        'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)': 'success', // ìƒ‰ìƒì½”ë“œ #D4EDDAì— ë§ì¶° successë¡œ ë³€ê²½
        'ì²˜ë¦¬ì™„ë£Œ': 'success',
        'ì ‘ìˆ˜ì·¨ì†Œ': 'secondary'
      };
      
      const color = colors[status] || 'secondary';
      let badgeHtml = `<span class="badge bg-${color}">${escapeHtml(status)}</span>`;
      
      // ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •) ìƒíƒœì— ëŒ€í•œ ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì ìš©
      if (status === 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)') {
        badgeHtml = `<span class="badge" style="background-color: #D4EDDA !important; color: #155724 !important; border: 1px solid #C3E6CB !important;">${escapeHtml(status)}</span>`;
      }
      
      return badgeHtml;
    }
    
    // ë‹´ë‹¹ì ë°°ì •
    async function bulkAssign() {
      const selected = getSelectedRequests();
      if (selected.length === 0) {
        showToast('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
      }
      
      const handlerEmail = prompt('ë‹´ë‹¹ì ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”:');
      if (!handlerEmail) return;
      
      try {
        showLoading('ë‹´ë‹¹ì ë°°ì • ì¤‘...');
        let successCount = 0;
        
        for (const requestNo of selected) {
          try {
            const sessionToken = getSessionToken();
            const result = await callServer('assignHandler', requestNo, handlerEmail, sessionToken);
            if (result.success) successCount++;
          } catch (error) {
            console.error('Assign failed for ' + requestNo, error);
          }
        }
        
        hideLoading();
        showToast(`${successCount}ê±´ì— ë‹´ë‹¹ìê°€ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        await loadAllRequests(currentFilter);
      } catch (error) {
        hideLoading();
        handleError(error);
      }
    }
    
    // ë’¤ë¡œê°€ê¸°
    async function goBack() {
      try {
        const sessionToken = getSessionToken();
        const baseUrl = await callServer('getWebAppUrl');
        if (!baseUrl) {
          window.location.href = '?page=admin-dashboard';
          return;
        }
        
        const targetUrl = baseUrl + '?page=admin-dashboard&token=' + encodeURIComponent(sessionToken);
        
        if (window.top && window.top !== window) {
          window.top.location.href = targetUrl;
        } else {
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('goBack error:', error);
        window.location.href = '?page=admin-dashboard';
      }
    }
  </script>
</body>
</html>

