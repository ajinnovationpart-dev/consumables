<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ì‹ ì²­ ìƒì„¸</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <?!= include('Stylesheet'); ?>
</head>
<body>
  <!-- í—¤ë” -->
  <nav class="navbar navbar-dark bg-primary mb-3">
    <div class="container-fluid px-2">
      <span class="navbar-brand mb-0">ğŸ  ë¶€í’ˆë°œì£¼</span>
      <div class="d-flex align-items-center">
        <span class="text-white d-none d-md-inline me-2 small">
          ğŸ‘¤ <span id="headerUserName"></span> (<span id="headerUserTeam"></span>)
        </span>
        <button class="btn btn-sm btn-outline-light" onclick="goBack()">â† ë’¤ë¡œ</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid px-2 mt-2">
    <div class="d-flex align-items-center mb-3">
      <h2 class="h4 mb-0">ì‹ ì²­ ìƒì„¸ - <span id="detailRequestNo"></span></h2>
    </div>

    <!-- ìƒíƒœ ì§„í–‰ë°” -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="mb-3">ğŸ”– ì§„í–‰ ìƒíƒœ</h5>
        <div id="statusProgressBar"></div>
      </div>
    </div>

    <!-- ì‹ ì²­ ì •ë³´ -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">ğŸ“‹ ì‹ ì²­ ì •ë³´</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <strong>ì‹ ì²­ë²ˆí˜¸</strong>
            <p id="requestNo"></p>
          </div>
          <div class="col-md-6 mb-3">
            <strong>ì‹ ì²­ì¼ì‹œ</strong>
            <p id="requestDate"></p>
          </div>
          <div class="col-md-6 mb-3">
            <strong>ì‹ ì²­ì</strong>
            <p id="requester"></p>
          </div>
          <div class="col-md-6 mb-3">
            <strong>í˜„ì¬ ìƒíƒœ</strong>
            <p><span id="currentStatus" class="badge"></span></p>
          </div>
        </div>
      </div>
    </div>

    <!-- ë¶€í’ˆ ì •ë³´ -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">ğŸ”§ ë¶€í’ˆ ì •ë³´</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <strong>í’ˆëª…</strong>
            <p id="itemName"></p>
          </div>
          <div class="col-md-6 mb-3">
            <strong>ëª¨ë¸ëª…</strong>
            <p id="modelName"></p>
          </div>
          <div class="col-md-4 mb-3">
            <strong>ìˆ˜ëŸ‰</strong>
            <p id="quantity"></p>
          </div>
          <div class="col-md-4 mb-3">
            <strong>ê´€ë¦¬ë²ˆí˜¸</strong>
            <p id="assetNo"></p>
          </div>
          <div class="col-md-4 mb-3">
            <strong>ì‹œë¦¬ì–¼ë²ˆí˜¸</strong>
            <p id="serialNo"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- ìˆ˜ë ¹ ì •ë³´ -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">ğŸ“¦ ìˆ˜ë ¹ ì •ë³´</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <strong>ë°°ì†¡ì§€</strong>
            <p id="deliveryPlace"></p>
          </div>
          <div class="col-md-6 mb-3">
            <strong>ì „í™”ë²ˆí˜¸</strong>
            <p id="phone"></p>
          </div>
          <div class="col-md-6 mb-3">
            <strong>ì—…ì²´ëª…</strong>
            <p id="company"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- ì²¨ë¶€ ì‚¬ì§„ -->
    <div class="card mb-4" id="photoCard">
      <div class="card-header">
        <h5 class="mb-0">ğŸ“· ì²¨ë¶€ ì‚¬ì§„</h5>
      </div>
      <div class="card-body text-center">
        <img id="photoPreview" class="img-thumbnail mb-2" style="max-width: 500px; display: none; cursor: pointer;" 
             onclick="copyImageToClipboard(event)" 
             oncontextmenu="copyImageToClipboard(event); return false;" 
             title="í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ë³µì‚¬ (ì¢Œí´ë¦­/ìš°í´ë¦­)">
        <br>
        <a id="photoLink" href="#" target="_blank" class="btn btn-outline-primary" style="display: none;">
          ğŸ” ì›ë³¸ ë³´ê¸°
        </a>
      </div>
    </div>

    <!-- ì²˜ë¦¬ ì •ë³´ -->
    <div class="card mb-4" id="handlerInfoCard" style="display:none;">
      <div class="card-header">
        <h5 class="mb-0">ğŸ‘¨â€ğŸ’¼ ì²˜ë¦¬ ì •ë³´</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <strong>ì ‘ìˆ˜ë‹´ë‹¹ì</strong>
            <p id="handler"></p>
          </div>
          <div class="col-md-6 mb-3">
            <strong>ë°œì£¼ì¼ì‹œ</strong>
            <p id="orderDate"></p>
          </div>
          <div class="col-md-6 mb-3">
            <strong>ì˜ˆìƒë‚©ê¸°ì¼</strong>
            <p id="expectedDeliveryDate"></p>
          </div>
          <div class="col-md-6 mb-3">
            <strong>ìˆ˜ë ¹í™•ì¸ì¼ì‹œ</strong>
            <p id="receiptDate"></p>
          </div>
          <div class="col-md-12">
            <strong>ë‹´ë‹¹ì ë¹„ê³ </strong>
            <p id="handlerRemarks"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- ë¹„ê³  -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">ğŸ“ ë¹„ê³ </h5>
      </div>
      <div class="card-body">
        <p id="remarks"></p>
      </div>
    </div>

    <!-- ì•¡ì…˜ ë²„íŠ¼ -->
    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-5">
      <button id="cancelBtn" class="btn btn-danger" onclick="cancelRequest()" style="display:none;">
        âœ• ì‹ ì²­ ì·¨ì†Œ
      </button>
      <button id="confirmReceiptBtn" class="btn btn-success" onclick="confirmReceipt()" style="display:none;">
        âœ“ ìˆ˜ë ¹ í™•ì¸
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <?!= include('JavaScript'); ?>
  <script>
    let currentRequest = null;

    // ì„¸ì…˜ í† í° ê°€ì ¸ì˜¤ê¸°
    function getSessionToken() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('token') || sessionStorage.getItem('sessionToken');
    }

    // í˜ì´ì§€ ì´ˆê¸°í™”
    window.onload = async function() {
      try {
        const startTime = performance.now();
        console.log('RequestDetailPage: Initializing...');
        console.log('Current URL:', window.location.href);
        console.log('URL search params:', window.location.search);
        
        const sessionToken = getSessionToken();
        console.log('Session token:', sessionToken ? 'Present' : 'Missing');
        
        if (!sessionToken) {
          console.warn('No session token, redirecting to login');
          window.location.href = '?page=login';
          return;
        }

        // URLì—ì„œ ì‹ ì²­ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        console.log('All URL params:', Array.from(urlParams.entries()));
        
        // âœ… URL íŒŒë¼ë¯¸í„° ë¨¼ì € ì‹œë„, ì—†ìœ¼ë©´ sessionStorageì—ì„œ ì½ê¸°
        let requestNo = urlParams.get('requestNo');
        
        if (!requestNo) {
          console.log('No requestNo in URL, checking sessionStorage...');
          requestNo = sessionStorage.getItem('pendingRequestNo');
          console.log('Found in sessionStorage:', requestNo);
          
          // ì‚¬ìš© í›„ ì‚­ì œ
          if (requestNo) {
            sessionStorage.removeItem('pendingRequestNo');
            sessionStorage.removeItem('pendingPage');
          }
        }
        
        console.log('Request No:', requestNo);
        console.log('Request No type:', typeof requestNo);

        if (!requestNo) {
          console.warn('No request number provided');
          showErrorModal('ì‹ ì²­ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.');
          return;
        }

        showLoading('ìƒì„¸ ì •ë³´ ë¡œë”© ì¤‘...');

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        const user = await callServer('getCurrentUser', sessionToken);
        if (!user) {
          window.location.href = '?page=login';
          return;
        }

        document.getElementById('headerUserName').textContent = user.name;
        document.getElementById('headerUserTeam').textContent = user.team;

        // ìƒì„¸ ì •ë³´ ë¡œë“œ
        currentRequest = await callServer('getRequest', requestNo, sessionToken);
        
        if (!currentRequest) {
          console.warn('Request not found');
          hideLoading();
          showErrorModal('ì‹ ì²­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.');
          return;
        }
        
        // ì—ëŸ¬ ì‘ë‹µ ì²´í¬
        if (currentRequest.success === false) {
          console.error('Request loading failed:', currentRequest.message);
          hideLoading();
          showErrorModal('ì‹ ì²­ ì •ë³´ ë¡œë”© ì‹¤íŒ¨:<br>' + currentRequest.message);
          return;
        }

        // í™”ë©´ì— í‘œì‹œ
        displayRequestDetail(currentRequest);

        hideLoading();
        
        const loadTime = (performance.now() - startTime).toFixed(0);
        console.log(`âœ… RequestDetailPage loaded in ${loadTime}ms`);
      } catch (error) {
        hideLoading();
        showToast('ìƒì„¸ ì •ë³´ ë¡œë”© ì‹¤íŒ¨: ' + error.message, 'danger');
        console.error('Detail init error:', error);
      }
    };
    
    // ì—ëŸ¬ ëª¨ë‹¬ í‘œì‹œ (SecurityError ë°©ì§€)
    function showErrorModal(message) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; text-align: center;">
          <h4 style="color: #dc3545; margin-bottom: 20px;">âš ï¸ ì•Œë¦¼</h4>
          <p style="margin-bottom: 30px;">${message}</p>
          <button class="btn btn-primary btn-lg" onclick="this.closest('div').parentElement.remove(); goBack();">
            ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
          </button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // ìƒì„¸ ì •ë³´ í‘œì‹œ
    function displayRequestDetail(req) {
      // ìƒíƒœ ì§„í–‰ë°”
      renderStatusProgress(req.status);

      // ì‹ ì²­ ì •ë³´
      document.getElementById('detailRequestNo').textContent = req.requestNo;
      document.getElementById('requestNo').textContent = req.requestNo;
      document.getElementById('requestDate').textContent = formatDateTime(req.requestDate);
      document.getElementById('requester').textContent = `${req.requesterName || ''} (${req.team || ''})`;

      const statusBadge = document.getElementById('currentStatus');
      statusBadge.textContent = req.status;
      statusBadge.className = `badge bg-${getStatusColor(req.status)}`;

      // ë¶€í’ˆ ì •ë³´
      document.getElementById('itemName').textContent = req.itemName || '-';
      document.getElementById('modelName').textContent = req.modelName || '-';
      document.getElementById('quantity').textContent = req.quantity || '-';
      document.getElementById('assetNo').textContent = req.assetNo || '-';
      document.getElementById('serialNo').textContent = req.serialNo || '-';

      // ìˆ˜ë ¹ ì •ë³´
      document.getElementById('deliveryPlace').textContent = req.deliveryPlace || '-';
      document.getElementById('phone').textContent = req.phone || '-';
      document.getElementById('company').textContent = req.company || '-';

      // ì‚¬ì§„
      if (req.photoUrl) {
        const imgElement = document.getElementById('photoPreview');
        imgElement.setAttribute('data-original-url', req.photoUrl); // ì›ë³¸ URL ì €ì¥
        document.getElementById('photoLink').href = req.photoUrl;
        document.getElementById('photoLink').style.display = 'inline-block';
        
        // Google Drive ì´ë¯¸ì§€ì¸ ê²½ìš° ì„œë²„ë¥¼ í†µí•´ ê°€ì ¸ì™€ì„œ í‘œì‹œ
        if (req.photoUrl.includes('drive.google.com')) {
          showLoading('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
          const sessionToken = getSessionToken();
          
          callServer('getImageAsBase64', req.photoUrl, sessionToken)
            .then(result => {
              if (result && result.success && result.dataUrl) {
                // Base64 Data URLë¡œ ì´ë¯¸ì§€ í‘œì‹œ
                imgElement.src = result.dataUrl;
                imgElement.style.display = 'block';
                console.log('Image loaded successfully from server');
                
                // ì´ë¯¸ì§€ ë¯¸ë¦¬ ë¡œë“œ (ë³µì‚¬ ì¤€ë¹„)
                preloadImageForCopy(req.photoUrl).catch(err => {
                  console.log('Image preload failed (non-critical):', err);
                });
              } else {
                throw new Error(result?.error || 'ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
              }
            })
            .catch(error => {
              console.error('Failed to load image:', error);
              // ì‹¤íŒ¨ ì‹œ ì›ë³¸ URLë¡œ ì‹œë„
              imgElement.src = req.photoUrl;
              imgElement.style.display = 'block';
              showToast('ì´ë¯¸ì§€ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì›ë³¸ ë§í¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.', 'warning');
            })
            .finally(() => {
              hideLoading();
            });
        } else {
          // ì¼ë°˜ ì´ë¯¸ì§€ URLì¸ ê²½ìš° ì§ì ‘ í‘œì‹œ
          imgElement.src = req.photoUrl;
          imgElement.style.display = 'block';
          
          // ì´ë¯¸ì§€ ë¯¸ë¦¬ ë¡œë“œ (ë³µì‚¬ ì¤€ë¹„)
          preloadImageForCopy(req.photoUrl).catch(err => {
            console.log('Image preload failed (non-critical):', err);
          });
        }
      } else {
        document.getElementById('photoCard').style.display = 'none';
      }

      // ì²˜ë¦¬ ì •ë³´ - í•­ìƒ í‘œì‹œ (ë°œì£¼ì¼ì‹œ ë° ì˜ˆìƒë‚©ê¸°ì¼ ì •ë³´ ë…¸ì¶œ)
      document.getElementById('handlerInfoCard').style.display = 'block';
      document.getElementById('handler').textContent = req.handler || '-';
      document.getElementById('orderDate').textContent = req.orderDate ? formatDateTime(req.orderDate) : '-';
      document.getElementById('expectedDeliveryDate').textContent = req.expectedDeliveryDate ? formatDate(req.expectedDeliveryDate) : '-';
      document.getElementById('receiptDate').textContent = req.receiptDate ? formatDateTime(req.receiptDate) : '-';
      document.getElementById('handlerRemarks').textContent = req.handlerRemarks || '-';

      // ë¹„ê³ 
      document.getElementById('remarks').textContent = req.remarks || '-';

      // ì•¡ì…˜ ë²„íŠ¼ í‘œì‹œ
      showActionButtons(req);
    }

    // ìƒíƒœ ì§„í–‰ë°” ë Œë”ë§
    function renderStatusProgress(currentStatus) {
      const container = document.getElementById('statusProgressBar');

      const statuses = [
        { code: 'ì ‘ìˆ˜ì¤‘', label: 'ì ‘ìˆ˜ì¤‘' },
        { code: 'ë°œì£¼ì§„í–‰', label: 'ë°œì£¼ì§„í–‰' },
        { code: 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)', label: 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)' },
        { code: 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)', label: 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)' },
        { code: 'ì²˜ë¦¬ì™„ë£Œ', label: 'ì²˜ë¦¬ì™„ë£Œ' }
      ];

      let currentIndex = statuses.findIndex(s => s.code === currentStatus);
      if (currentIndex === -1) currentIndex = 0;

      let html = '<div class="d-flex justify-content-between align-items-center">';

      statuses.forEach((status, index) => {
        const isActive = index <= currentIndex;
        const isCurrent = index === currentIndex;
        
        // status.labelì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ (escapeHtmlì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì§ì ‘ ì²˜ë¦¬)
        let escapedLabel = status.label;
        if (typeof escapeHtml === 'function') {
          escapedLabel = escapeHtml(status.label);
        } else {
          // ê°„ë‹¨í•œ HTML ì´ìŠ¤ì¼€ì´í”„
          escapedLabel = String(status.label)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
        }

        html += '<div class="text-center flex-fill">';
        html += '<div class="mb-2">';
        html += '<span class="badge ' + (isActive ? 'bg-primary' : 'bg-secondary') + '" ';
        html += 'style="width: 40px; height: 40px; line-height: 30px; font-size: 18px;">';
        html += (isCurrent ? 'â—' : isActive ? 'âœ“' : 'â—‹');
        html += '</span>';
        html += '</div>';
        html += '<small class="' + (isActive ? 'fw-bold' : 'text-muted') + '">' + escapedLabel + '</small>';
        html += '</div>';

        if (index < statuses.length - 1) {
          html += '<div class="flex-fill" style="height: 2px; background: ' + (isActive ? '#0d6efd' : '#dee2e6') + '; margin: 0 10px 20px;"></div>';
        }
      });

      html += '</div>';
      container.innerHTML = html;
    }

    // ì•¡ì…˜ ë²„íŠ¼ í‘œì‹œ
    function showActionButtons(req) {
      const cancelBtn = document.getElementById('cancelBtn');
      const confirmBtn = document.getElementById('confirmReceiptBtn');

      cancelBtn.style.display = 'none';
      confirmBtn.style.display = 'none';

      if (req.status === 'ì ‘ìˆ˜ì¤‘') {
        cancelBtn.style.display = 'inline-block';
      } else if (req.status === 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)' || req.status === 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)') {
        confirmBtn.style.display = 'inline-block';
      }
    }

    // ìƒíƒœë³„ ìƒ‰ìƒ
    function getStatusColor(status) {
      const colors = {
        'ì ‘ìˆ˜ì¤‘': 'warning',
        'ë°œì£¼ì§„í–‰': 'primary',
        'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)': 'success',
        'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)': 'info',
        'ì²˜ë¦¬ì™„ë£Œ': 'success',
        'ì ‘ìˆ˜ì·¨ì†Œ': 'secondary'
      };
      return colors[status] || 'secondary';
    }

    // ë‚ ì§œ/ì‹œê°„ í¬ë§·íŒ…
    function formatDateTime(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toISOString().split('T')[0];
    }

    // ì‹ ì²­ ì·¨ì†Œ
    async function cancelRequest() {
      if (!confirm('ì •ë§ ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      try {
        const sessionToken = getSessionToken();
        showLoading('ì·¨ì†Œ ì²˜ë¦¬ ì¤‘...');

        const result = await callServer('cancelRequest', currentRequest.requestNo, sessionToken);

        if (result.success) {
          showToast('ì‹ ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          setTimeout(() => {
            goBack();
          }, 2000);
        } else {
          showToast('ì·¨ì†Œ ì‹¤íŒ¨: ' + result.message, 'danger');
        }

      } catch (error) {
        showToast('ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'danger');
      } finally {
        hideLoading();
      }
    }

    // ìˆ˜ë ¹ í™•ì¸
    async function confirmReceipt() {
      if (!confirm('ë¶€í’ˆì„ ìˆ˜ë ¹í•˜ì…¨ìŠµë‹ˆê¹Œ?\nìˆ˜ë ¹ í™•ì¸ í›„ì—ëŠ” ì²˜ë¦¬ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½ë©ë‹ˆë‹¤.')) {
        return;
      }

      try {
        const sessionToken = getSessionToken();
        showLoading('ìˆ˜ë ¹ í™•ì¸ ì²˜ë¦¬ ì¤‘...');

        const result = await callServer('confirmReceipt', currentRequest.requestNo, sessionToken);

        if (result.success) {
          showToast('ìˆ˜ë ¹ í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          // ìƒì„¸ ì •ë³´ ìƒˆë¡œê³ ì¹¨
          window.location.reload();
        } else {
          showToast('ìˆ˜ë ¹ í™•ì¸ ì‹¤íŒ¨: ' + result.message, 'danger');
        }

      } catch (error) {
        showToast('ìˆ˜ë ¹ í™•ì¸ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'danger');
      } finally {
        hideLoading();
      }
    }

    // Google Drive URLì„ ì´ë¯¸ì§€ë¡œ í‘œì‹œ ê°€ëŠ¥í•œ URLë¡œ ë³€í™˜
    function convertDriveUrlToImage(url) {
      if (!url || !url.includes('drive.google.com')) {
        return url;
      }
      
      // íŒŒì¼ ID ì¶”ì¶œ
      let fileId = null;
      
      // í˜•ì‹ 1: /file/d/FILE_ID/view
      const match1 = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
      if (match1) {
        fileId = match1[1];
      }
      
      // í˜•ì‹ 2: ?id=FILE_ID
      if (!fileId) {
        const match2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
        if (match2) {
          fileId = match2[1];
        }
      }
      
      if (fileId) {
        // ì´ë¯¸ì§€ë¡œ í‘œì‹œ ê°€ëŠ¥í•œ URLë¡œ ë³€í™˜
        return 'https://drive.google.com/uc?export=view&id=' + fileId;
      }
      
      return url;
    }
    
    // Google Drive URLì„ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ URLë¡œ ë³€í™˜
    function convertDriveUrlToDownload(url) {
      if (!url || !url.includes('drive.google.com')) {
        return url;
      }
      
      // íŒŒì¼ ID ì¶”ì¶œ
      let fileId = null;
      
      // í˜•ì‹ 1: /file/d/FILE_ID/view
      const match1 = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
      if (match1) {
        fileId = match1[1];
      }
      
      // í˜•ì‹ 2: ?id=FILE_ID
      if (!fileId) {
        const match2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
        if (match2) {
          fileId = match2[1];
        }
      }
      
      if (fileId) {
        // ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ URLë¡œ ë³€í™˜
        return 'https://drive.google.com/uc?export=download&id=' + fileId;
      }
      
      return url;
    }

    // ì´ë¯¸ì§€ Blob ìºì‹œ
    let cachedImageBlob = null;
    let cachedImageUrl = null;
    
    // ì´ë¯¸ì§€ ë¯¸ë¦¬ ë¡œë“œ (ì›ë³¸ URLì„ ë°›ì•„ì„œ ì²˜ë¦¬)
    async function preloadImageForCopy(originalUrl) {
      try {
        const sessionToken = getSessionToken();
        
        // Google Drive ì´ë¯¸ì§€ì¸ ê²½ìš° ì„œë²„ë¥¼ í†µí•´ ê°€ì ¸ì˜¤ê¸°
        if (originalUrl && originalUrl.includes('drive.google.com')) {
          const result = await callServer('getImageAsBase64', originalUrl, sessionToken);
          
          if (!result || !result.success) {
            throw new Error(result?.error || 'ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
          
          // Base64 Data URLì„ Blobìœ¼ë¡œ ë³€í™˜
          const response = await fetch(result.dataUrl);
          cachedImageBlob = await response.blob();
          cachedImageUrl = originalUrl;
          console.log('Image preloaded successfully for copy');
          return cachedImageBlob;
        }
        
        // ì¼ë°˜ ì´ë¯¸ì§€ URLì¸ ê²½ìš° ì§ì ‘ fetch
        const response = await fetch(originalUrl, {
          mode: 'cors',
          credentials: 'omit'
        });
        
        if (!response.ok) {
          throw new Error('HTTP error! status: ' + response.status);
        }
        
        cachedImageBlob = await response.blob();
        cachedImageUrl = originalUrl;
        
        if (!cachedImageBlob.type.startsWith('image/')) {
          throw new Error('Not an image file');
        }
        
        return cachedImageBlob;
        
      } catch (error) {
        console.error('Image preload failed:', error);
        cachedImageBlob = null;
        cachedImageUrl = null;
        return null;
      }
    }
    
    // ì´ë¯¸ì§€ í´ë¦­ ë³µì‚¬ ê¸°ëŠ¥ (ì¢Œí´ë¦­/ìš°í´ë¦­ ëª¨ë‘ ì§€ì›)
    async function copyImageToClipboard(event) {
      event.preventDefault();
      event.stopPropagation();
      
      const img = event.target;
      if (!img || !img.src) {
        showToast('ë³µì‚¬í•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
      }
      
      // ì›ë³¸ URL ì°¾ê¸° (photoLinkì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ imgì˜ data-original-url ì†ì„± ì‚¬ìš©)
      let originalUrl = img.getAttribute('data-original-url');
      if (!originalUrl) {
        // photoLinkì—ì„œ ì›ë³¸ URL ê°€ì ¸ì˜¤ê¸°
        const photoLink = document.getElementById('photoLink');
        if (photoLink && photoLink.href) {
          originalUrl = photoLink.href;
        } else {
          originalUrl = img.src;
        }
      }
      
      // ìºì‹œëœ ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ URLì´ ë³€ê²½ëœ ê²½ìš° ë¯¸ë¦¬ ë¡œë“œ
      if (!cachedImageBlob || cachedImageUrl !== originalUrl) {
        showToast('ì´ë¯¸ì§€ë¥¼ ì¤€ë¹„í•˜ëŠ” ì¤‘...', 'info');
        const blob = await preloadImageForCopy(originalUrl);
        if (!blob) {
          showToast('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
          return;
        }
      }
      
      // ì‚¬ìš©ì ì œìŠ¤ì²˜ì™€ ì§ì ‘ ì—°ê²°ëœ í´ë¦½ë³´ë“œ ì ‘ê·¼
      try {
        // í´ë¦½ë³´ë“œ ì ‘ê·¼ì„ ì‚¬ìš©ì ì œìŠ¤ì²˜ì™€ ì§ì ‘ ì—°ê²°
        const item = new ClipboardItem({ [cachedImageBlob.type]: cachedImageBlob });
        await navigator.clipboard.write([item]);
        
        showToast('ì´ë¯¸ì§€ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        
      } catch (error) {
        console.error('Clipboard write failed:', error);
        
        // ëŒ€ì²´ ë°©ë²•: ì´ë¯¸ì§€ URL ë³µì‚¬
        try {
          await navigator.clipboard.writeText(originalUrl);
          showToast('ì´ë¯¸ì§€ URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        } catch (urlError) {
          console.error('URL copy also failed:', urlError);
          showToast('ì´ë¯¸ì§€ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ í´ë¦­í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
        }
      }
    }

    async function goBack() {
      try {
        console.log('goBack: Starting...');
        const sessionToken = getSessionToken();
        const baseUrl = await callServer('getWebAppUrl');
        
        if (!baseUrl) {
          window.location.href = '?page=my-requests&token=' + encodeURIComponent(sessionToken);
          return;
        }
        
        const targetUrl = baseUrl + '?page=my-requests&token=' + encodeURIComponent(sessionToken);
        console.log('Navigating to:', targetUrl);
        
        if (window.top && window.top !== window) {
          window.top.location.href = targetUrl;
        } else {
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('goBack error:', error);
        window.location.href = '?page=my-requests';
      }
    }
  </script>
</body>
</html>


