<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í†µê³„ ë° ë¦¬í¬íŠ¸</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* ê´€ë¦¬ì í˜ì´ì§€ëŠ” PC ì „ìš© ìŠ¤íƒ€ì¼ ì ìš© */
    body {
      font-size: 14px !important;
    }
    
    .container-fluid {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ ì œê±° */
    @media (max-width: 768px) {
      body {
        font-size: 14px !important;
      }
      
      input, .form-control, .form-select, textarea {
        font-size: 14px !important;
        min-height: auto !important;
        padding: 0.375rem 0.75rem !important;
      }
      
      button, .btn {
        font-size: 14px !important;
        min-height: auto !important;
        padding: 0.375rem 0.75rem !important;
      }
    }
  </style>
</head>
<body>
  <!-- í—¤ë” -->
  <nav class="navbar navbar-dark bg-primary mb-3">
    <div class="container-fluid px-2">
      <span class="navbar-brand mb-0">ğŸ  ë¶€í’ˆë°œì£¼ (ê´€ë¦¬ì)</span>
      <div class="d-flex align-items-center">
        <span class="text-white d-none d-md-inline me-2 small">
          ğŸ‘¤ <span id="headerUserName"></span>
        </span>
        <button class="btn btn-sm btn-outline-light" onclick="goBack()">â† ë’¤ë¡œ</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid px-2 mt-2">
    <h2 class="h4 mb-3">ğŸ“ˆ í†µê³„ ë° ë¦¬í¬íŠ¸</h2>

    <!-- ê¸°ê°„ ì„ íƒ -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">ì‹œì‘ì¼</label>
            <input type="date" class="form-control" id="startDate">
          </div>
          <div class="col-md-3">
            <label class="form-label">ì¢…ë£Œì¼</label>
            <input type="date" class="form-control" id="endDate">
          </div>
          <div class="col-md-3">
            <label class="form-label">ë¹ ë¥¸ ì„ íƒ</label>
            <select class="form-select" id="quickPeriod" onchange="selectQuickPeriod()">
              <option value="">ì§ì ‘ ì„ íƒ</option>
              <option value="today">ì˜¤ëŠ˜</option>
              <option value="week">ìµœê·¼ 7ì¼</option>
              <option value="month">ìµœê·¼ 30ì¼</option>
              <option value="quarter">ìµœê·¼ 90ì¼</option>
            </select>
          </div>
          <div class="col-md-3">
            <button class="btn btn-primary w-100" onclick="loadStatistics()">
              ğŸ” ì¡°íšŒ
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ì „ì²´ í†µê³„ -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card text-center border-primary">
          <div class="card-body">
            <h6 class="text-muted">ì´ ì‹ ì²­ ê±´ìˆ˜</h6>
            <h2 class="text-primary" id="totalCount">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center border-success">
          <div class="card-body">
            <h6 class="text-muted">ì²˜ë¦¬ ì™„ë£Œ</h6>
            <h2 class="text-success" id="completedCount">0</h2>
            <small class="text-muted">(<span id="completedRate">0</span>%)</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center border-warning">
          <div class="card-body">
            <h6 class="text-muted">ì§„í–‰ ì¤‘</h6>
            <h2 class="text-warning" id="inProgressCount">0</h2>
            <small class="text-muted">(<span id="inProgressRate">0</span>%)</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center border-danger">
          <div class="card-body">
            <h6 class="text-muted">í‰ê·  ì²˜ë¦¬ì¼</h6>
            <h2 class="text-danger" id="avgDays">0</h2>
            <small class="text-muted">ì¼</small>
          </div>
        </div>
      </div>
    </div>

    <!-- ì°¨íŠ¸ ì˜ì—­ -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">ğŸ“Š ìƒíƒœë³„ ë¶„í¬</h5>
          </div>
          <div class="card-body">
            <canvas id="statusChart" height="300"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">ğŸ“ íŒŒíŠ¸ë³„ ë¶„í¬</h5>
          </div>
          <div class="card-body">
            <canvas id="regionChart" height="300"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">ğŸ“… ì¼ë³„ ì‹ ì²­ ì¶”ì´</h5>
          </div>
          <div class="card-body">
            <canvas id="dailyChart" height="100"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- ìƒì„¸ í†µê³„ í…Œì´ë¸” -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">ğŸ‘¥ ì‹ ì²­ìë³„ í†µê³„</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
              <table class="table table-sm">
                <thead class="table-light sticky-top">
                  <tr>
                    <th>ì‹ ì²­ì</th>
                    <th>ì†Œì†</th>
                    <th class="text-end">ê±´ìˆ˜</th>
                  </tr>
                </thead>
                <tbody id="userStatsBody">
                  <tr>
                    <td colspan="3" class="text-center text-muted">ë¡œë”© ì¤‘...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">ğŸ”§ í’ˆëª©ë³„ í†µê³„</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
              <table class="table table-sm">
                <thead class="table-light sticky-top">
                  <tr>
                    <th>í’ˆëª…</th>
                    <th class="text-end">ê±´ìˆ˜</th>
                    <th class="text-end">ìˆ˜ëŸ‰</th>
                  </tr>
                </thead>
                <tbody id="itemStatsBody">
                  <tr>
                    <td colspan="3" class="text-center text-muted">ë¡œë”© ì¤‘...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
    <div class="d-flex justify-content-end mb-4">
      <button class="btn btn-success" onclick="exportToExcel()">
        ğŸ“¥ Excel ë‹¤ìš´ë¡œë“œ
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <?!= include('JavaScript'); ?>
  <script>
    // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬
    window.addEventListener('error', function(e) {
      console.error('Global error caught:', e.error || e.message);
      const errorDiv = document.createElement('div');
      errorDiv.className = 'alert alert-danger m-4';
      errorDiv.style.position = 'fixed';
      errorDiv.style.top = '20px';
      errorDiv.style.left = '50%';
      errorDiv.style.transform = 'translateX(-50%)';
      errorDiv.style.zIndex = '9999';
      errorDiv.style.maxWidth = '600px';
      errorDiv.innerHTML = `
        <h5>âš ï¸ í˜ì´ì§€ ë¡œë”© ì˜¤ë¥˜</h5>
        <p><strong>ì˜¤ë¥˜:</strong> ${e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>
        <button class="btn btn-primary btn-sm" onclick="window.location.reload()">ìƒˆë¡œê³ ì¹¨</button>
      `;
      document.body.appendChild(errorDiv);
    });

    let statusChart, regionChart, dailyChart;
    let statsData = null;

    // ì„¸ì…˜ í† í° ê°€ì ¸ì˜¤ê¸°
    function getSessionToken() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('token') || sessionStorage.getItem('sessionToken');
    }

    // í˜ì´ì§€ ì´ˆê¸°í™”
    window.onload = async function() {
      try {
        const startTime = performance.now();
        console.log('âœ… AdminStatisticsPage: Initializing...');
        
        const sessionToken = getSessionToken();
        if (!sessionToken) {
          window.location.href = '?page=login';
          return;
        }

        // âœ… ì‚¬ìš©ì ì •ë³´ ìºì‹œ í™•ì¸
        let user = sessionStorage.getItem('currentUser');
        if (user) {
          user = JSON.parse(user);
          console.log('âœ… Using cached user info');
        } else {
          user = await callServer('getCurrentUser', sessionToken);
          if (user) {
            sessionStorage.setItem('currentUser', JSON.stringify(user));
          }
        }
        
        if (!user || user.role !== 'ê´€ë¦¬ì') {
          window.location.href = '?page=login';
          return;
        }

        document.getElementById('headerUserName').textContent = user.name || '';

        // ê¸°ë³¸ê°’: ìµœê·¼ 30ì¼
        selectQuickPeriod('month');
        await loadStatistics();

        const loadTime = (performance.now() - startTime).toFixed(0);
        console.log(`âœ… AdminStatisticsPage loaded in ${loadTime}ms`);
      } catch (error) {
        console.error('AdminStatisticsPage init error:', error);
        showToast('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'danger');
      }
    };

    // ë¹ ë¥¸ ê¸°ê°„ ì„ íƒ
    function selectQuickPeriod(period = null) {
      const select = document.getElementById('quickPeriod');
      const selectedPeriod = period || select.value;
      
      if (!selectedPeriod) return;

      const today = new Date();
      const endDate = new Date(today);
      let startDate = new Date(today);

      switch(selectedPeriod) {
        case 'today':
          startDate = new Date(today);
          break;
        case 'week':
          startDate.setDate(today.getDate() - 7);
          break;
        case 'month':
          startDate.setDate(today.getDate() - 30);
          break;
        case 'quarter':
          startDate.setDate(today.getDate() - 90);
          break;
      }

      document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
      document.getElementById('endDate').value = endDate.toISOString().split('T')[0];

      if (!period) {
        loadStatistics();
      }
    }

    // í†µê³„ ë°ì´í„° ë¡œë“œ
    async function loadStatistics() {
      try {
        showLoading('í†µê³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
        const sessionToken = getSessionToken();

        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        console.log('Loading statistics for period:', startDate, '~', endDate);

        if (!startDate || !endDate) {
          showToast('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•˜ì„¸ìš”.', 'warning');
          hideLoading();
          return;
        }

        // í†µê³„ ë°ì´í„° ì¡°íšŒ - í•„í„° ì—†ì´ ì „ì²´ ë°ì´í„° ì¡°íšŒ
        console.log('Calling getAllRequests API...');
        const allRequests = await callServer('getAllRequests', {}, sessionToken);
        console.log('getAllRequests result:', allRequests ? allRequests.length + ' items' : 'null');
        
        if (!allRequests || allRequests.length === 0) {
          console.warn('No requests found');
          statsData = calculateStatistics([]);
          displayStatistics(statsData);
          hideLoading();
          showToast('ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
          return;
        }

        // í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ë‚ ì§œ í•„í„°ë§
        const filtered = allRequests.filter(req => {
          if (!req.requestDate) return false;
          
          // "2026. 1. 7 PM 05:04:45" â†’ "2026. 1. 7" â†’ "2026-01-07"
          let reqDateStr;
          const dateParts = req.requestDate.split(' ');
          if (dateParts.length >= 3) {
            // "2026. 1. 7" ì¶”ì¶œ
            reqDateStr = dateParts[0] + '.' + dateParts[1] + '.' + dateParts[2];
          } else {
            reqDateStr = req.requestDate.split(' ')[0];
          }
          
          // "2026. 1. 7" â†’ "2026-01-07"
          if (reqDateStr.includes('.')) {
            const parts = reqDateStr.split('.').map(p => p.trim()).filter(p => p);
            if (parts.length >= 3) {
              reqDateStr = parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');
            }
          }
          
          return reqDateStr >= startDate && reqDateStr <= endDate;
        });

        console.log('Filtered requests:', filtered.length, 'out of', allRequests.length);
        
        statsData = calculateStatistics(filtered);
        console.log('Statistics calculated:', statsData);

        // í™”ë©´ì— í‘œì‹œ
        displayStatistics(statsData);

        hideLoading();
      } catch (error) {
        console.error('loadStatistics error:', error);
        console.error('Error stack:', error.stack);
        hideLoading();
        showToast('í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message, 'danger');
      }
    }

    // í•œêµ­ì–´ ë‚ ì§œ í˜•ì‹ì„ Date ê°ì²´ë¡œ ë³€í™˜
    function parseKoreanDate(dateStr) {
      if (!dateStr) return null;
      
      try {
        // "2026. 1. 7 PM 05:04:45" â†’ Date ê°ì²´
        const parts = dateStr.split(' ');
        if (parts.length < 3) return null;
        
        // ë‚ ì§œ ë¶€ë¶„: "2026.", "1.", "7"
        const dateParts = [parts[0], parts[1], parts[2]].join('').split('.').map(p => p.trim()).filter(p => p);
        if (dateParts.length < 3) return null;
        
        const year = parseInt(dateParts[0]);
        const month = parseInt(dateParts[1]) - 1; // 0-based
        const day = parseInt(dateParts[2]);
        
        // ì‹œê°„ ë¶€ë¶„ (ìˆìœ¼ë©´)
        let hours = 0, minutes = 0, seconds = 0;
        if (parts.length >= 5) {
          const ampm = parts[3]; // "AM" ë˜ëŠ” "PM"
          const timeParts = parts[4].split(':');
          hours = parseInt(timeParts[0]);
          if (ampm === 'PM' && hours !== 12) hours += 12;
          if (ampm === 'AM' && hours === 12) hours = 0;
          if (timeParts.length > 1) minutes = parseInt(timeParts[1]);
          if (timeParts.length > 2) seconds = parseInt(timeParts[2]);
        }
        
        return new Date(year, month, day, hours, minutes, seconds);
      } catch (e) {
        console.error('Date parsing error:', dateStr, e);
        return null;
      }
    }
    
    // í†µê³„ ê³„ì‚°
    function calculateStatistics(requests) {
      console.log('Calculating statistics for', requests.length, 'requests');
      
      const stats = {
        total: requests.length,
        byStatus: {},
        byRegion: {},
        byUser: {},
        byItem: {},
        byDate: {},
        completed: 0,
        inProgress: 0,
        avgDays: 0
      };

      if (requests.length === 0) {
        console.log('No requests to calculate');
        return stats;
      }

      let totalDays = 0;
      let completedWithDays = 0;

      requests.forEach((req, index) => {
        console.log('Processing request', index + 1, ':', req.requestNo, '-', req.status);
        
        // ìƒíƒœë³„
        const status = req.status || 'ë¯¸ìƒ';
        stats.byStatus[status] = (stats.byStatus[status] || 0) + 1;
        
        // íŒŒíŠ¸ë³„ (ì†Œì†íŒ€ë³„)
        const team = req.team || 'ë¯¸ìƒ';
        stats.byRegion[team] = (stats.byRegion[team] || 0) + 1;
        
        // ì‹ ì²­ìë³„
        const userKey = req.requester || req.requesterName || 'ë¯¸ìƒ';
        if (!stats.byUser[userKey]) {
          stats.byUser[userKey] = { name: userKey, team: req.team || '-', count: 0 };
        }
        stats.byUser[userKey].count++;
        
        // í’ˆëª©ë³„
        const itemKey = req.itemName || 'ë¯¸ìƒ';
        if (!stats.byItem[itemKey]) {
          stats.byItem[itemKey] = { name: itemKey, count: 0, quantity: 0 };
        }
        stats.byItem[itemKey].count++;
        stats.byItem[itemKey].quantity += (parseInt(req.quantity) || 0);
        
        // ì¼ë³„
        const dateKey = req.requestDate ? req.requestDate.split(' ')[0] : 'ë¯¸ìƒ';
        stats.byDate[dateKey] = (stats.byDate[dateKey] || 0) + 1;

        // ì™„ë£Œ/ì§„í–‰ì¤‘
        if (status === 'ì²˜ë¦¬ì™„ë£Œ' || status === 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)' || status === 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)') {
          stats.completed++;
          
          // í‰ê·  ì²˜ë¦¬ì¼ ê³„ì‚°
          if (req.requestDate && req.completedDate) {
            const reqDate = parseKoreanDate(req.requestDate);
            const compDate = parseKoreanDate(req.completedDate);
            
            if (reqDate && compDate && !isNaN(reqDate.getTime()) && !isNaN(compDate.getTime())) {
              const days = Math.floor((compDate - reqDate) / (1000 * 60 * 60 * 24));
              if (days >= 0) {
                totalDays += days;
                completedWithDays++;
                console.log('Processing time for', req.requestNo, ':', days, 'days');
              }
            } else {
              console.warn('Invalid dates for', req.requestNo, '- reqDate:', req.requestDate, 'compDate:', req.completedDate);
            }
          }
        }
        
        if (status === 'ë°œì£¼ì§„í–‰' || status === 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)' || status === 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)') {
          stats.inProgress++;
        }
      });

      stats.avgDays = completedWithDays > 0 ? Math.round(totalDays / completedWithDays) : 0;

      console.log('Statistics summary:');
      console.log('- Total:', stats.total);
      console.log('- Completed:', stats.completed);
      console.log('- In Progress:', stats.inProgress);
      console.log('- By Status:', stats.byStatus);
      console.log('- By Region:', stats.byRegion);

      return stats;
    }

    // í†µê³„ í‘œì‹œ
    function displayStatistics(stats) {
      // ì „ì²´ í†µê³„
      document.getElementById('totalCount').textContent = stats.total;
      document.getElementById('completedCount').textContent = stats.completed;
      document.getElementById('inProgressCount').textContent = stats.inProgress;
      document.getElementById('avgDays').textContent = stats.avgDays;

      const completedRate = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
      const inProgressRate = stats.total > 0 ? Math.round((stats.inProgress / stats.total) * 100) : 0;
      document.getElementById('completedRate').textContent = completedRate;
      document.getElementById('inProgressRate').textContent = inProgressRate;

      // ì°¨íŠ¸ í‘œì‹œ
      renderStatusChart(stats.byStatus);
      renderRegionChart(stats.byRegion);
      renderDailyChart(stats.byDate);

      // í…Œì´ë¸” í‘œì‹œ
      renderUserStatsTable(stats.byUser);
      renderItemStatsTable(stats.byItem);
    }

    // ìƒíƒœë³„ ì°¨íŠ¸
    function renderStatusChart(byStatus) {
      const ctx = document.getElementById('statusChart');
      if (statusChart) statusChart.destroy();

      const labels = Object.keys(byStatus);
      const data = Object.values(byStatus);

      statusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: [
              '#ffc107', '#17a2b8', '#007bff', '#dc3545', 
              '#28a745', '#6c757d', '#fd7e14'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    // íŒŒíŠ¸ë³„ ì°¨íŠ¸ (ì†Œì†íŒ€ë³„)
    function renderRegionChart(byTeam) {
      const ctx = document.getElementById('regionChart');
      if (regionChart) regionChart.destroy();

      const labels = Object.keys(byTeam);
      const data = Object.values(byTeam);

      regionChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: [
              '#007bff', '#28a745', '#ffc107', '#dc3545',
              '#17a2b8', '#6c757d', '#fd7e14', '#6f42c1'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    // ì¼ë³„ ì°¨íŠ¸
    function renderDailyChart(byDate) {
      const ctx = document.getElementById('dailyChart');
      if (dailyChart) dailyChart.destroy();

      const sortedDates = Object.keys(byDate).sort();
      const data = sortedDates.map(date => byDate[date]);

      dailyChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: sortedDates,
          datasets: [{
            label: 'ì‹ ì²­ ê±´ìˆ˜',
            data: data,
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }

    // ì‹ ì²­ìë³„ í…Œì´ë¸”
    function renderUserStatsTable(byUser) {
      const tbody = document.getElementById('userStatsBody');
      tbody.innerHTML = '';

      const sorted = Object.values(byUser).sort((a, b) => b.count - a.count);

      if (sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      sorted.forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(user.name)}</td>
          <td>${escapeHtml(user.team)}</td>
          <td class="text-end"><strong>${user.count}</strong></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // í’ˆëª©ë³„ í…Œì´ë¸”
    function renderItemStatsTable(byItem) {
      const tbody = document.getElementById('itemStatsBody');
      tbody.innerHTML = '';

      const sorted = Object.values(byItem).sort((a, b) => b.count - a.count);

      if (sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      sorted.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(item.name)}</td>
          <td class="text-end"><strong>${item.count}</strong></td>
          <td class="text-end">${item.quantity}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Excel ë‹¤ìš´ë¡œë“œ
    function exportToExcel() {
      if (!statsData) {
        showToast('ë¨¼ì € í†µê³„ë¥¼ ì¡°íšŒí•˜ì„¸ìš”.', 'warning');
        return;
      }

      showToast('Excel ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.', 'info');
      // TODO: ì‹¤ì œ Excel ìƒì„± ë¡œì§ êµ¬í˜„
    }

    // ë’¤ë¡œê°€ê¸°
    async function goBack() {
      try {
        const sessionToken = getSessionToken();
        const baseUrl = await callServer('getWebAppUrl');
        if (!baseUrl) {
          window.location.href = '?page=admin-dashboard';
          return;
        }
        
        const targetUrl = baseUrl + '?page=admin-dashboard&token=' + encodeURIComponent(sessionToken);
        
        if (window.top && window.top !== window) {
          window.top.location.href = targetUrl;
        } else {
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('goBack error:', error);
        window.location.href = '?page=admin-dashboard';
      }
    }

    console.log('âœ“ AdminStatisticsPage script loaded');
  </script>
</body>
</html>

