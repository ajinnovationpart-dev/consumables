<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë‚´ ì‹ ì²­ ëª©ë¡</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <?!= include('Stylesheet'); ?>
</head>
<body>
  <!-- í—¤ë” -->
  <nav class="navbar navbar-dark bg-primary mb-3">
    <div class="container-fluid px-2">
      <span class="navbar-brand mb-0">ğŸ  ë¶€í’ˆë°œì£¼</span>
      <div class="d-flex align-items-center">
        <span class="text-white d-none d-md-inline me-2 small">
          ğŸ‘¤ <span id="headerUserName"></span> (<span id="headerUserTeam"></span>)
        </span>
        <button class="btn btn-sm btn-outline-light" onclick="goBack()">â† ë’¤ë¡œ</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid px-2 mt-2">
    <div class="d-flex align-items-center mb-3">
      <h2 class="h4 mb-0">ë‚´ ì‹ ì²­ ëª©ë¡</h2>
    </div>

    <!-- ì¡°íšŒ ì¡°ê±´ -->
    <div class="card mb-3 border-primary">
      <div class="card-header bg-light">
        <h5 class="mb-0">ğŸ” ì¡°íšŒ ì¡°ê±´</h5>
      </div>
      <div class="card-body p-2 p-md-3">
        <div class="row g-2">
          <div class="col-12 col-md-5">
            <input type="text" 
                   class="form-control" 
                   id="searchKeyword" 
                   placeholder="ğŸ” ì‹ ì²­ë²ˆí˜¸, í’ˆëª…, ê´€ë¦¬ë²ˆí˜¸ë¡œ ê²€ìƒ‰">
          </div>
          <div class="col-12 col-md-3">
            <select class="form-select" id="filterStatus">
              <option value="">ì „ì²´ ìƒíƒœ</option>
              <option value="ì ‘ìˆ˜ì¤‘">ì ‘ìˆ˜ì¤‘</option>
              <option value="ë°œì£¼ì§„í–‰">ë°œì£¼ì§„í–‰</option>
              <option value="ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)">ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)</option>
              <option value="ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)">ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)</option>
              <option value="ì²˜ë¦¬ì™„ë£Œ">ì²˜ë¦¬ì™„ë£Œ</option>
              <option value="ì ‘ìˆ˜ì·¨ì†Œ">ì ‘ìˆ˜ì·¨ì†Œ</option>
            </select>
          </div>
          <div class="col-md-2">
            <input type="date" class="form-control" id="filterDate">
          </div>
          <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="applyFilter()">
              ê²€ìƒ‰
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ìƒíƒœë³„ íƒ­ -->
    <ul class="nav nav-tabs mb-3" id="statusTabs">
      <li class="nav-item">
        <a class="nav-link active" data-status="" onclick="filterByStatus(this, '')">
          ì „ì²´ <span class="badge bg-secondary" id="countAll">0</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-status="ì ‘ìˆ˜ì¤‘" onclick="filterByStatus(this, 'ì ‘ìˆ˜ì¤‘')">
          ì ‘ìˆ˜ì¤‘ <span class="badge bg-warning" id="countRequested">0</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-status="ì§„í–‰ì¤‘" onclick="filterByStatus(this, 'ì§„í–‰ì¤‘')">
          ì§„í–‰ì¤‘ <span class="badge bg-info" id="countInProgress">0</span>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-status="ì²˜ë¦¬ì™„ë£Œ" onclick="filterByStatus(this, 'ì²˜ë¦¬ì™„ë£Œ')">
          ì™„ë£Œ <span class="badge bg-success" id="countCompleted">0</span>
        </a>
      </li>
    </ul>

    <!-- ì‹ ì²­ ëª©ë¡ í…Œì´ë¸” -->
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover" style="table-layout: auto;">
            <thead>
              <tr>
                <th onclick="sortBy('requestDate')">
                  ì‹ ì²­ì¼ <i class="bi bi-arrow-down-up"></i>
                </th>
                <th>í’ˆëª…</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>ê´€ë¦¬ë²ˆí˜¸</th>
                <th>ìƒíƒœ</th>
                <th>ë‹´ë‹¹ì</th>
                <th>ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="requestsTableBody">
              <tr>
                <td colspan="7" class="text-center text-muted">ë¡œë”© ì¤‘...</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- í˜ì´ì§• -->
        <nav>
          <ul class="pagination justify-content-center" id="pagination">
          </ul>
        </nav>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <?!= include('JavaScript'); ?>
  <script>
    // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬ - ë¹ˆ í˜ì´ì§€ ë°©ì§€
    window.addEventListener('error', function(e) {
      console.error('Global error caught:', e.error || e.message);
      const errorDiv = document.createElement('div');
      errorDiv.className = 'alert alert-danger m-4';
      errorDiv.style.position = 'fixed';
      errorDiv.style.top = '20px';
      errorDiv.style.left = '50%';
      errorDiv.style.transform = 'translateX(-50%)';
      errorDiv.style.zIndex = '9999';
      errorDiv.style.maxWidth = '600px';
      errorDiv.innerHTML = `
        <h5>âš ï¸ í˜ì´ì§€ ë¡œë”© ì˜¤ë¥˜</h5>
        <p><strong>ì˜¤ë¥˜:</strong> ${e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>
        <button class="btn btn-primary btn-sm" onclick="window.location.reload()">ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn btn-secondary btn-sm" onclick="history.back()">ë’¤ë¡œê°€ê¸°</button>
      `;
      document.body.appendChild(errorDiv);
    });

    // ì „ì—­ ë³€ìˆ˜
    let allRequests = [];
    let filteredRequests = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let currentSort = { field: 'requestDate', order: 'desc' };

    // ì„¸ì…˜ í† í° ê°€ì ¸ì˜¤ê¸°
    function getSessionToken() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('token') || sessionStorage.getItem('sessionToken');
    }

    // í˜ì´ì§€ ì´ˆê¸°í™”
    window.onload = async function() {
      try {
        const startTime = performance.now();
        console.log('âœ… MyRequestsPage: Initializing...');
        
        const sessionToken = getSessionToken();
        if (!sessionToken) {
          window.location.href = '?page=login';
          return;
        }

        showLoading('ëª©ë¡ ë¡œë”© ì¤‘...');

        // âœ… ì‚¬ìš©ì ì •ë³´ ìºì‹œ í™•ì¸
        let user = sessionStorage.getItem('currentUser');
        if (user) {
          user = JSON.parse(user);
          console.log('âœ… Using cached user info');
        } else {
          user = await callServer('getCurrentUser', sessionToken);
          if (user) {
            sessionStorage.setItem('currentUser', JSON.stringify(user));
          }
        }
        
        if (!user) {
          hideLoading();
          window.location.href = '?page=login';
          return;
        }

        document.getElementById('headerUserName').textContent = user.name || '';
        document.getElementById('headerUserTeam').textContent = user.team || '';

        // ì‹ ì²­ ë‚´ì—­ ë¡œë“œ
        const requestsResponse = await callServer('getMyRequests', {}, sessionToken);
        
        // ì‘ë‹µ íƒ€ì… ê²€ì¦
        if (!Array.isArray(requestsResponse)) {
          console.error('Invalid getMyRequests response:', requestsResponse);
          allRequests = [];
          filteredRequests = [];
        } else {
          allRequests = requestsResponse;
          filteredRequests = [...allRequests];
        }

        updateStatistics();
        renderTable();

        hideLoading();
        
        const loadTime = (performance.now() - startTime).toFixed(0);
        console.log(`âœ… MyRequestsPage loaded in ${loadTime}ms`);
      } catch (error) {
        console.error('MyRequestsPage init error:', error);
        console.error('Error stack:', error.stack);
        hideLoading();
        showToast('ëª©ë¡ ë¡œë”© ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'danger');
      }
    };

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStatistics() {
      const stats = {
        all: allRequests.length,
        requested: 0,
        inProgress: 0,
        completed: 0
      };

      allRequests.forEach(req => {
        if (req.status === 'ì ‘ìˆ˜ì¤‘') {
          stats.requested++;
        } else if (['ë°œì£¼ì§„í–‰', 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)', 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)'].includes(req.status)) {
          stats.inProgress++;
        } else if (req.status === 'ì²˜ë¦¬ì™„ë£Œ') {
          stats.completed++;
        }
      });

      document.getElementById('countAll').textContent = stats.all;
      document.getElementById('countRequested').textContent = stats.requested;
      document.getElementById('countInProgress').textContent = stats.inProgress;
      document.getElementById('countCompleted').textContent = stats.completed;
    }

    // í•„í„° ì ìš©
    function applyFilter() {
      const keyword = document.getElementById('searchKeyword').value.trim().toLowerCase();
      const status = document.getElementById('filterStatus').value;
      const date = document.getElementById('filterDate').value;

      filteredRequests = allRequests.filter(req => {
        // í‚¤ì›Œë“œ í•„í„° (ì‹ ì²­ë²ˆí˜¸ëŠ” ê²€ìƒ‰ì—ì„œë§Œ ì‚¬ìš©, í‘œì‹œëŠ” ì•ˆí•¨)
        if (keyword) {
          const matchKeyword = 
            req.requestNo.toLowerCase().includes(keyword) ||
            req.itemName.toLowerCase().includes(keyword) ||
            (req.assetNo && req.assetNo.toLowerCase().includes(keyword));
          if (!matchKeyword) return false;
        }

        // ìƒíƒœ í•„í„°
        if (status && req.status !== status) {
          return false;
        }

        // ë‚ ì§œ í•„í„°
        if (date) {
          const reqDate = new Date(req.requestDate).toISOString().split('T')[0];
          if (reqDate !== date) return false;
        }

        return true;
      });

      currentPage = 1;
      renderTable();
    }

    // ìƒíƒœë³„ í•„í„°
    function filterByStatus(element, status) {
      // íƒ­ í™œì„±í™”
      document.querySelectorAll('#statusTabs .nav-link').forEach(tab => {
        tab.classList.remove('active');
      });
      element.classList.add('active');

      // í•„í„° ì ìš©
      if (status === 'ì§„í–‰ì¤‘') {
        filteredRequests = allRequests.filter(req => 
          ['ë°œì£¼ì§„í–‰', 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)', 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)'].includes(req.status)
        );
      } else if (status) {
        filteredRequests = allRequests.filter(req => req.status === status);
      } else {
        filteredRequests = [...allRequests];
      }

      // í•„í„° ì„ íƒ ë™ê¸°í™”
      document.getElementById('filterStatus').value = status === 'ì§„í–‰ì¤‘' ? '' : status;

      currentPage = 1;
      renderTable();
    }

    // ì •ë ¬
    function sortBy(field) {
      if (currentSort.field === field) {
        currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.field = field;
        currentSort.order = 'desc';
      }

      filteredRequests.sort((a, b) => {
        let aVal = a[field];
        let bVal = b[field];

        if (field === 'requestDate') {
          aVal = new Date(aVal);
          bVal = new Date(bVal);
        }

        if (currentSort.order === 'asc') {
          return aVal > bVal ? 1 : -1;
        } else {
          return aVal < bVal ? 1 : -1;
        }
      });

      renderTable();
    }

    // í…Œì´ë¸” ë Œë”ë§
    function renderTable() {
      const tbody = document.getElementById('requestsTableBody');
      tbody.innerHTML = '';

      if (filteredRequests.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center text-muted py-5">
              <p class="mb-0">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </td>
          </tr>
        `;
        document.getElementById('pagination').innerHTML = '';
        return;
      }

      // í˜ì´ì§• ê³„ì‚°
      const totalPages = Math.ceil(filteredRequests.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, filteredRequests.length);
      const pageRequests = filteredRequests.slice(startIndex, endIndex);

      // í…Œì´ë¸” í–‰ ìƒì„±
      pageRequests.forEach(req => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDate(req.requestDate, 'MM-DD')}</td>
          <td>${escapeHtml(req.itemName)}</td>
          <td>${req.quantity}</td>
          <td>${escapeHtml(req.assetNo || '-')}</td>
          <td><span class="badge bg-${getStatusColor(req.status)}">${escapeHtml(req.status)}</span></td>
          <td>${escapeHtml(req.handler || '-')}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary" 
                    onclick="viewDetail('${req.requestNo}')">
              ìƒì„¸
            </button>
            ${getActionButtons(req)}
          </td>
        `;
        tbody.appendChild(tr);
      });

      // í˜ì´ì§• ë Œë”ë§
      renderPagination(totalPages);
    }

    // ì•¡ì…˜ ë²„íŠ¼ ìƒì„±
    function getActionButtons(req) {
      let buttons = '';

      if (req.status === 'ì ‘ìˆ˜ì¤‘') {
        buttons += `
          <button class="btn btn-sm btn-outline-danger ms-1" 
                  onclick="cancelRequest('${req.requestNo}')">
            ì·¨ì†Œ
          </button>
        `;
      }

      if (req.status === 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)' || req.status === 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)') {
        buttons += `
          <button class="btn btn-sm btn-success ms-1" 
                  onclick="confirmReceipt('${req.requestNo}')">
            ìˆ˜ë ¹í™•ì¸
          </button>
        `;
      }

      return buttons;
    }

    // í˜ì´ì§• ë Œë”ë§
    function renderPagination(totalPages) {
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';

      if (totalPages <= 1) return;

      // ì´ì „ ë²„íŠ¼
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `
        <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
          â† ì´ì „
        </a>
      `;
      pagination.appendChild(prevLi);

      // í˜ì´ì§€ ë²ˆí˜¸
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);

      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `
          <a class="page-link" href="#" onclick="changePage(${i}); return false;">
            ${i}
          </a>
        `;
        pagination.appendChild(li);
      }

      // ë‹¤ìŒ ë²„íŠ¼
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      nextLi.innerHTML = `
        <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
          ë‹¤ìŒ â†’
        </a>
      `;
      pagination.appendChild(nextLi);
    }

    // í˜ì´ì§€ ë³€ê²½
    function changePage(page) {
      currentPage = page;
      renderTable();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ìƒíƒœë³„ ìƒ‰ìƒ
    function getStatusColor(status) {
      const colors = {
        'ì ‘ìˆ˜ì¤‘': 'warning',
        'ë°œì£¼ì§„í–‰': 'primary',
        'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)': 'success',
        'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)': 'info',
        'ì²˜ë¦¬ì™„ë£Œ': 'success',
        'ì ‘ìˆ˜ì·¨ì†Œ': 'secondary'
      };
      return colors[status] || 'secondary';
    }

    // ë‚ ì§œ í¬ë§·íŒ…
    function formatDate(dateString, format = 'YYYY-MM-DD') {
      if (!dateString) return '';
      const date = new Date(dateString);
      if (format === 'MM-DD') {
        return (date.getMonth() + 1).toString().padStart(2, '0') + '-' + 
               date.getDate().toString().padStart(2, '0');
      }
      return date.toISOString().split('T')[0];
    }

    // ì‹ ì²­ ì·¨ì†Œ
    async function cancelRequest(requestNo) {
      if (!confirm('ì •ë§ ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      try {
        const sessionToken = getSessionToken();
        showLoading('ì·¨ì†Œ ì²˜ë¦¬ ì¤‘...');

        const result = await callServer('cancelRequest', requestNo, sessionToken);

        if (result.success) {
          showToast('ì‹ ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          allRequests = await callServer('getMyRequests', {}, sessionToken);
          filteredRequests = [...allRequests];
          updateStatistics();
          renderTable();
        } else {
          showToast('ì·¨ì†Œ ì‹¤íŒ¨: ' + result.message, 'danger');
        }

      } catch (error) {
        showToast('ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'danger');
      } finally {
        hideLoading();
      }
    }

    // ìˆ˜ë ¹ í™•ì¸
    async function confirmReceipt(requestNo) {
      if (!confirm('ë¶€í’ˆì„ ìˆ˜ë ¹í•˜ì…¨ìŠµë‹ˆê¹Œ?\nìˆ˜ë ¹ í™•ì¸ í›„ì—ëŠ” ì²˜ë¦¬ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½ë©ë‹ˆë‹¤.')) {
        return;
      }

      try {
        const sessionToken = getSessionToken();
        showLoading('ìˆ˜ë ¹ í™•ì¸ ì²˜ë¦¬ ì¤‘...');

        const result = await callServer('confirmReceipt', requestNo, sessionToken);

        if (result.success) {
          showToast('ìˆ˜ë ¹ í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          allRequests = await callServer('getMyRequests', {}, sessionToken);
          filteredRequests = [...allRequests];
          updateStatistics();
          renderTable();
        } else {
          showToast('ìˆ˜ë ¹ í™•ì¸ ì‹¤íŒ¨: ' + result.message, 'danger');
        }

      } catch (error) {
        showToast('ìˆ˜ë ¹ í™•ì¸ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'danger');
      } finally {
        hideLoading();
      }
    }

    // ìƒì„¸ ë³´ê¸°
    async function viewDetail(requestNo) {
      try {
        console.log('viewDetail called with requestNo:', requestNo);
        const sessionToken = getSessionToken();
        console.log('Session token:', sessionToken ? 'Present' : 'Missing');
        
        // âœ… sessionStorageì— íŒŒë¼ë¯¸í„° ì €ì¥ (OAuth ë¦¬ë‹¤ì´ë ‰ì…˜ ëŒ€ë¹„)
        sessionStorage.setItem('pendingRequestNo', requestNo);
        sessionStorage.setItem('pendingPage', 'detail');
        console.log('Saved to sessionStorage:', { requestNo, page: 'detail' });
        
        const baseUrl = await callServer('getWebAppUrl');
        console.log('Base URL:', baseUrl);
        
        if (!baseUrl) {
          showToast('í˜ì´ì§€ ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
          return;
        }
        
        const targetUrl = baseUrl + '?page=detail&requestNo=' + encodeURIComponent(requestNo) + '&token=' + encodeURIComponent(sessionToken);
        console.log('Target URL:', targetUrl);
        console.log('Navigating to detail page...');
        
        if (window.top && window.top !== window) {
          window.top.location.href = targetUrl;
        } else {
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('viewDetail error:', error);
        showToast('í˜ì´ì§€ ì´ë™ ì‹¤íŒ¨: ' + error.message, 'danger');
      }
    }

    async function goBack() {
      try {
        const sessionToken = getSessionToken();
        const baseUrl = await callServer('getWebAppUrl');
        if (!baseUrl) return;
        
        const targetUrl = baseUrl + '?page=dashboard&token=' + encodeURIComponent(sessionToken);
        
        if (window.top && window.top !== window) {
          window.top.location.href = targetUrl;
        } else {
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('goBack error:', error);
        window.location.href = '?page=login';
      }
    }

    // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ í™•ì¸
    console.log('âœ“ MyRequestsPage script loaded');
  </script>
</body>
</html>

