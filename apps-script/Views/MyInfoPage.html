<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë‚´ ì •ë³´</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <?!= include('Stylesheet'); ?>
</head>
<body>
  <!-- í—¤ë” -->
  <nav class="navbar navbar-dark bg-primary mb-3">
    <div class="container-fluid px-2">
      <span class="navbar-brand mb-0">ğŸ  ë¶€í’ˆë°œì£¼</span>
      <div class="d-flex align-items-center">
        <span class="text-white d-none d-md-inline me-2 small">
          ğŸ‘¤ <span id="headerUserName"></span> (<span id="headerUserTeam"></span>)
        </span>
        <button class="btn btn-sm btn-outline-light" onclick="goBack()">â† ë’¤ë¡œ</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid px-2">
    <!-- ê¸°ë³¸ ì •ë³´ -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">ê¸°ë³¸ ì •ë³´</h5>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label fw-bold">ì‚¬ìš©ì ID</label>
            <input type="text" class="form-control" id="userId" readonly>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-bold">ì´ë¦„</label>
            <input type="text" class="form-control" id="userName" readonly>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-bold">ê¸°ì‚¬ì½”ë“œ</label>
            <input type="text" class="form-control" id="employeeCode" readonly>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-bold">ì†Œì†íŒ€</label>
            <input type="text" class="form-control" id="userTeam" readonly>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label fw-bold">ì§€ì—­</label>
            <input type="text" class="form-control" id="userRegion" readonly>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-bold">ì—­í• </label>
            <input type="text" class="form-control" id="userRole" readonly>
          </div>
        </div>
      </div>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h5>
      </div>
      <div class="card-body">
        <form id="passwordChangeForm" onsubmit="handlePasswordChange(event)">
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="currentPassword" class="form-label fw-bold">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
              <input type="password" class="form-control" id="currentPassword" required>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="newPassword" class="form-label fw-bold">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
              <input type="password" class="form-control" id="newPassword" minlength="6" required>
              <div class="form-text">ìµœì†Œ 6ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="confirmPassword" class="form-label fw-bold">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
              <input type="password" class="form-control" id="confirmPassword" minlength="6" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <button type="submit" class="btn btn-primary btn-lg w-100" id="changePasswordBtn">
                ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <?!= include('JavaScript'); ?>
  <script>
    // ì„¸ì…˜ í† í° ê°€ì ¸ì˜¤ê¸°
    function getSessionToken() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('token') || sessionStorage.getItem('sessionToken');
    }

    // ë’¤ë¡œ ê°€ê¸°
    function goBack() {
      const sessionToken = getSessionToken();
      const page = 'dashboard';
      const targetUrl = '?page=' + page + (sessionToken ? '&token=' + encodeURIComponent(sessionToken) : '');
      
      if (window.top && window.top !== window) {
        window.top.location.href = targetUrl;
      } else {
        window.location.href = targetUrl;
      }
    }

    // í˜ì´ì§€ ì´ˆê¸°í™”
    window.onload = async function() {
      try {
        const sessionToken = getSessionToken();
        if (!sessionToken) {
          window.location.href = '?page=login';
          return;
        }

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        const user = await callServer('getCurrentUser', sessionToken);
        if (!user) {
          window.location.href = '?page=login';
          return;
        }

        // ê¸°ë³¸ ì •ë³´ í‘œì‹œ
        document.getElementById('headerUserName').textContent = user.name || '';
        document.getElementById('headerUserTeam').textContent = user.team || '';
        document.getElementById('userId').value = user.userId || '';
        document.getElementById('userName').value = user.name || '';
        document.getElementById('employeeCode').value = user.employeeCode || '';
        document.getElementById('userTeam').value = user.team || '';
        document.getElementById('userRegion').value = user.region || '';
        document.getElementById('userRole').value = user.role || '';

        console.log('MyInfoPage initialized successfully');
      } catch (error) {
        console.error('MyInfoPage init error:', error);
        showToast('í˜ì´ì§€ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
      }
    };

    // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì²˜ë¦¬
    async function handlePasswordChange(event) {
      event.preventDefault();
      
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const btn = document.getElementById('changePasswordBtn');
      
      // ìœ íš¨ì„± ê²€ì¦
      if (!currentPassword) {
        showToast('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }
      
      if (newPassword.length < 6) {
        showToast('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'warning');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showToast('ìƒˆ ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'warning');
        return;
      }
      
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ë³€ê²½ ì¤‘...';
      
      try {
        const sessionToken = getSessionToken();
        if (!sessionToken) {
          showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
          window.location.href = '?page=login';
          return;
        }
        
        console.log('Calling changePassword API...');
        const result = await callServer('changePassword', currentPassword, newPassword, sessionToken);
        console.log('changePassword result:', result);
        
        if (result.success) {
          showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          // í¼ ì´ˆê¸°í™”
          document.getElementById('passwordChangeForm').reset();
        } else {
          showToast(result.message || 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
        }
      } catch (error) {
        console.error('Password change error:', error);
        showToast('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½';
      }
    }

    // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ í™•ì¸
    console.log('âœ“ MyInfoPage script loaded');
  </script>
</body>
</html>
