<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* ê´€ë¦¬ì í˜ì´ì§€ëŠ” PC ì „ìš© ìŠ¤íƒ€ì¼ ì ìš© */
    body {
      font-size: 14px !important;
    }
    
    .container-fluid {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ ì œê±° */
    @media (max-width: 768px) {
      body {
        font-size: 14px !important;
      }
      
      input, .form-control, .form-select, textarea {
        font-size: 14px !important;
        min-height: auto !important;
        padding: 0.375rem 0.75rem !important;
      }
      
      button, .btn {
        font-size: 14px !important;
        min-height: auto !important;
        padding: 0.375rem 0.75rem !important;
      }
    }
  </style>
</head>
<body>
  <!-- í—¤ë”: ê´€ë¦¬ì ê³µí†µ ë„¤ë¹„ -->
  <nav class="navbar navbar-dark bg-primary mb-3">
    <div class="container-fluid px-2">
      <span class="navbar-brand mb-0">ğŸ  ë¶€í’ˆë°œì£¼ì‹œìŠ¤í…œ</span>
      <div class="d-flex align-items-center flex-wrap gap-1">
        <a href="#" class="text-white text-decoration-none small me-2 fw-bold" onclick="navigateToDashboard(); return false;">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</a>
        <span class="text-white opacity-75 d-none d-md-inline">|</span>
        <a href="#" class="text-white text-decoration-none small me-2" onclick="navigateToAllRequests(); return false;">ì „ì²´ ì‹ ì²­</a>
        <span class="text-white opacity-75 d-none d-md-inline">|</span>
        <a href="#" class="text-white text-decoration-none small me-2" onclick="navigateToStatistics(); return false;">í†µê³„ ë° ë¦¬í¬íŠ¸</a>
        <span class="text-white opacity-75 d-none d-md-inline">|</span>
        <a href="#" class="text-white text-decoration-none small me-2" onclick="navigateToMaster(); return false;">âš™ï¸ ê¸°ì¤€ì •ë³´ ë“±ë¡/ê´€ë¦¬</a>
        <span class="text-white d-none d-md-inline me-2 small">ğŸ‘¤ <span id="headerUserName"></span></span>
        <button class="btn btn-sm btn-outline-light" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid px-2 mt-2">
    <h2 class="h4 mb-3">ğŸ“Š ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
    
    <!-- ì¡°íšŒ ê¸°ê°„ -->
    <div class="card mb-4 border-primary">
      <div class="card-header bg-light">
        <h5 class="mb-0">ğŸ” ì¡°íšŒ ê¸°ê°„</h5>
      </div>
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label fw-semibold">ì¡°íšŒ ê¸°ê°„</label>
            <select class="form-select" id="periodSelect" onchange="changePeriod()">
              <option value="today">ì˜¤ëŠ˜</option>
              <option value="week">ì´ë²ˆ ì£¼</option>
              <option value="month" selected>ì´ë²ˆ ë‹¬</option>
              <option value="custom">ì§ì ‘ ì„ íƒ</option>
            </select>
          </div>
          <div class="col-md-3" id="customDateFrom" style="display:none;">
            <label class="form-label">ì‹œì‘ì¼</label>
            <input type="date" class="form-control" id="startDate">
          </div>
          <div class="col-md-3" id="customDateTo" style="display:none;">
            <label class="form-label">ì¢…ë£Œì¼</label>
            <input type="date" class="form-control" id="endDate">
          </div>
          <div class="col-md-3">
            <button class="btn btn-primary w-100" onclick="loadDashboardData()">
              ğŸ” ì¡°íšŒ
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ë””ë²„ê¹… ì •ë³´ (ê°œë°œ ì¤‘ì—ë§Œ í‘œì‹œ) -->
    <div id="debugInfo" class="alert alert-info" style="display:none;">
      <strong>ë””ë²„ê¹… ì •ë³´:</strong>
      <div id="debugContent"></div>
    </div>

    <!-- í˜„í™© -->
    <div class="row mb-4">
      <div class="col-md-2">
        <div class="card text-center border-primary" style="cursor: pointer;" onclick="navigateToStatusFilter('')" title="ì „ì²´ ì‹ ì²­ ëª©ë¡ ë³´ê¸°">
          <div class="card-body">
            <h6>ì‹ ê·œ</h6>
            <h2 class="text-primary" id="periodNew">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card text-center border-warning" style="cursor: pointer;" onclick="navigateToStatusFilter('ì ‘ìˆ˜ì¤‘')" title="ì ‘ìˆ˜ì¤‘ ìƒíƒœ ì‹ ì²­ ë³´ê¸°">
          <div class="card-body">
            <h6>ì ‘ìˆ˜ì¤‘</h6>
            <h2 class="text-warning" id="periodRequested">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card text-center border-info" style="cursor: pointer;" onclick="navigateToStatusFilter('ë°œì£¼ì§„í–‰')" title="ë°œì£¼ì§„í–‰ ìƒíƒœ ì‹ ì²­ ë³´ê¸°">
          <div class="card-body">
            <h6>ì§„í–‰ì¤‘</h6>
            <h2 class="text-info" id="periodInProgress">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card text-center border-info" style="cursor: pointer;" onclick="navigateToStatusFilter('ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)')" title="ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •) ìƒíƒœ ì‹ ì²­ ë³´ê¸°">
          <div class="card-body">
            <h6>ì§€ì—°</h6>
            <h2 class="text-danger" id="periodDelayed">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card text-center border-success" style="cursor: pointer;" onclick="navigateToStatusFilter('ì²˜ë¦¬ì™„ë£Œ')" title="ì²˜ë¦¬ì™„ë£Œ ìƒíƒœ ì‹ ì²­ ë³´ê¸°">
          <div class="card-body">
            <h6>ì™„ë£Œ</h6>
            <h2 class="text-success" id="periodCompleted">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="card text-center" style="cursor: pointer;" onclick="navigateToStatusFilter('')" title="ì „ì²´ ì‹ ì²­ ëª©ë¡ ë³´ê¸°">
          <div class="card-body">
            <h6>ì „ì²´</h6>
            <h2 id="periodTotal">0</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- ê¸´ê¸‰ ì²˜ë¦¬ í•„ìš” -->
    <div class="card mb-4">
      <div class="card-header bg-danger text-white">
        <h5 class="mb-0">ğŸ”´ ê¸´ê¸‰ ì²˜ë¦¬ í•„ìš”</h5>
      </div>
      <div class="card-body">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>ì‹ ì²­ë²ˆí˜¸</th>
              <th>í’ˆëª…</th>
              <th>ìƒíƒœ</th>
              <th>ì‹ ì²­ì</th>
              <th>ì‹ ì²­ì¼</th>
              <th>ì•¡ì…˜</th>
            </tr>
          </thead>
          <tbody id="urgentRequestsBody">
            <tr>
              <td colspan="6" class="text-center text-muted">ê¸´ê¸‰ ì²˜ë¦¬ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ë°œì£¼ ì§€ì—° ê±´ -->
    <div class="card mb-4">
      <div class="card-header bg-warning">
        <h5 class="mb-0">âš ï¸ ë°œì£¼ ì§€ì—° ê±´</h5>
      </div>
      <div class="card-body">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>ì‹ ì²­ë²ˆí˜¸</th>
              <th>í’ˆëª…</th>
              <th>ì§€ì—° ì¼ìˆ˜</th>
              <th>ì‹ ì²­ì</th>
              <th>ë‹´ë‹¹ì</th>
              <th>ì•¡ì…˜</th>
            </tr>
          </thead>
          <tbody id="delayedRequestsBody">
            <tr>
              <td colspan="6" class="text-center text-muted">ì§€ì—° ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ë¹ ë¥¸ ì•¡ì…˜ -->
    <div class="text-center mb-4">
      <button class="btn btn-primary btn-lg" onclick="navigateToAllRequests()">
        ğŸ“‹ ì „ì²´ ì‹ ì²­ ëª©ë¡
      </button>
      <button class="btn btn-outline-primary btn-lg ms-2" onclick="navigateToStatistics()">
        ğŸ“ˆ í†µê³„ ë° ë¦¬í¬íŠ¸
      </button>
      <button class="btn btn-outline-secondary btn-lg ms-2" onclick="navigateToMaster()">
        âš™ï¸ ê¸°ì¤€ì •ë³´ ê´€ë¦¬
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <?!= include('JavaScript'); ?>
  <script>
    // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬ - ë¹ˆ í˜ì´ì§€ ë°©ì§€
    window.addEventListener('error', function(e) {
      console.error('Global error caught:', e.error || e.message);
      const errorDiv = document.createElement('div');
      errorDiv.className = 'alert alert-danger m-4';
      errorDiv.style.position = 'fixed';
      errorDiv.style.top = '20px';
      errorDiv.style.left = '50%';
      errorDiv.style.transform = 'translateX(-50%)';
      errorDiv.style.zIndex = '9999';
      errorDiv.style.maxWidth = '600px';
      errorDiv.innerHTML = `
        <h5>âš ï¸ í˜ì´ì§€ ë¡œë”© ì˜¤ë¥˜</h5>
        <p><strong>ì˜¤ë¥˜:</strong> ${e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>
        <button class="btn btn-primary btn-sm" onclick="window.location.reload()">ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn btn-secondary btn-sm" onclick="window.location.href='?page=login'">ë¡œê·¸ì¸</button>
      `;
      document.body.appendChild(errorDiv);
    });

    // ì„¸ì…˜ í† í° ê°€ì ¸ì˜¤ê¸°
    function getSessionToken() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('token') || sessionStorage.getItem('sessionToken');
    }

    // í˜ì´ì§€ ì´ˆê¸°í™”
    window.onload = async function() {
      try {
        const startTime = performance.now();
        console.log('âœ… AdminDashboard: Initializing...');
        
        const sessionToken = getSessionToken();
        if (!sessionToken) {
          window.location.href = '?page=login';
          return;
        }

        showLoading('ëŒ€ì‹œë³´ë“œ ë¡œë”© ì¤‘...');

        // âœ… ì‚¬ìš©ì ì •ë³´ ìºì‹œ í™•ì¸
        let user = sessionStorage.getItem('currentUser');
        if (user) {
          user = JSON.parse(user);
          console.log('âœ… Using cached user info');
        } else {
          user = await callServer('getCurrentUser', sessionToken);
          if (user) {
            sessionStorage.setItem('currentUser', JSON.stringify(user));
          }
        }
        
        if (!user || user.role !== 'ê´€ë¦¬ì') {
          hideLoading();
          window.location.href = '?page=login';
          return;
        }

        document.getElementById('headerUserName').textContent = user.name || 'ê´€ë¦¬ì';

        // ê¸°ë³¸ ê¸°ê°„: ì´ë²ˆ ë‹¬
        changePeriod();
        await loadDashboardData();

        hideLoading();
        
        const loadTime = (performance.now() - startTime).toFixed(0);
        console.log(`âœ… AdminDashboard loaded in ${loadTime}ms`);
      } catch (error) {
        console.error('Dashboard init error:', error);
        console.error('Error stack:', error.stack);
        hideLoading();
        
        // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger m-4';
        errorDiv.innerHTML = `
          <h5>ëŒ€ì‹œë³´ë“œ ë¡œë”© ì‹¤íŒ¨</h5>
          <p><strong>ì˜¤ë¥˜:</strong> ${escapeHtml(error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')}</p>
          <p><small>ì½˜ì†”ì„ í™•ì¸í•˜ì—¬ ìì„¸í•œ ì˜¤ë¥˜ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</small></p>
          <button class="btn btn-primary" onclick="window.location.reload()">ìƒˆë¡œê³ ì¹¨</button>
          <button class="btn btn-secondary" onclick="window.location.href='?page=login'">ë¡œê·¸ì¸ìœ¼ë¡œ</button>
        `;
        document.body.insertBefore(errorDiv, document.body.firstChild);
        
        if (typeof showToast === 'function') {
          showToast('ëŒ€ì‹œë³´ë“œ ë¡œë”© ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'danger');
        }
      }
    };
    
    // í•œêµ­ì–´ ë‚ ì§œ í˜•ì‹ì„ Date ê°ì²´ë¡œ ë³€í™˜
    function parseKoreanDate(dateStr) {
      if (!dateStr) return null;
      
      try {
        // "2026. 1. 7 PM 05:04:45" â†’ Date ê°ì²´
        const parts = dateStr.split(' ');
        if (parts.length < 3) return null;
        
        // ë‚ ì§œ ë¶€ë¶„: "2026.", "1.", "7"
        const dateParts = [parts[0], parts[1], parts[2]].join('').split('.').map(p => p.trim()).filter(p => p);
        if (dateParts.length < 3) return null;
        
        const year = parseInt(dateParts[0]);
        const month = parseInt(dateParts[1]) - 1; // 0-based
        const day = parseInt(dateParts[2]);
        
        // ì‹œê°„ ë¶€ë¶„ (ìˆìœ¼ë©´)
        let hours = 0, minutes = 0, seconds = 0;
        if (parts.length >= 5) {
          const ampm = parts[3]; // "AM" ë˜ëŠ” "PM"
          const timeParts = parts[4].split(':');
          hours = parseInt(timeParts[0]);
          if (ampm === 'PM' && hours !== 12) hours += 12;
          if (ampm === 'AM' && hours === 12) hours = 0;
          if (timeParts.length > 1) minutes = parseInt(timeParts[1]);
          if (timeParts.length > 2) seconds = parseInt(timeParts[2]);
        }
        
        return new Date(year, month, day, hours, minutes, seconds);
      } catch (e) {
        console.error('Date parsing error:', dateStr, e);
        return null;
      }
    }
    
    // ê¸°ê°„ ì„ íƒ ë³€ê²½
    function changePeriod() {
      const period = document.getElementById('periodSelect').value;
      const customDateFrom = document.getElementById('customDateFrom');
      const customDateTo = document.getElementById('customDateTo');
      
      if (period === 'custom') {
        customDateFrom.style.display = 'block';
        customDateTo.style.display = 'block';
      } else {
        customDateFrom.style.display = 'none';
        customDateTo.style.display = 'none';
        
        const today = new Date();
        const startDate = new Date();
        
        switch(period) {
          case 'today':
            // ì˜¤ëŠ˜
            break;
          case 'week':
            // ì´ë²ˆ ì£¼ (ì›”ìš”ì¼ ~ ì¼ìš”ì¼)
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1);
            startDate.setDate(diff);
            break;
          case 'month':
            // ì´ë²ˆ ë‹¬ (1ì¼ ~ ë§ì¼)
            startDate.setDate(1);
            break;
        }
        
        document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
      }
    }
    
    // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
    async function loadDashboardData() {
      try {
        showLoading('ë°ì´í„° ë¡œë”© ì¤‘...');
        const sessionToken = getSessionToken();
        
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        console.log('Loading dashboard data for period:', startDate, '~', endDate);
        
        // ì „ì²´ ë°ì´í„° ì¡°íšŒ
        console.log('Calling getAllRequests with sessionToken:', sessionToken);
        const allRequests = await callServer('getAllRequests', {}, sessionToken);
        console.log('getAllRequests response type:', typeof allRequests);
        console.log('getAllRequests is Array:', Array.isArray(allRequests));
        console.log('getAllRequests is null:', allRequests === null);
        console.log('getAllRequests is undefined:', allRequests === undefined);
        console.log('getAllRequests value:', allRequests);
        
        if (allRequests) {
          console.log('All requests length:', allRequests.length);
          if (allRequests.length > 0) {
            console.log('First item:', JSON.stringify(allRequests[0]));
          }
        }
        
        if (!allRequests || !Array.isArray(allRequests)) {
          console.error('Invalid response from getAllRequests');
          console.error('Response:', allRequests);
          console.error('Expected: Array, Got:', typeof allRequests);
          displayStats({ period: {} });
          displayUrgentRequests([]);
          displayDelayedRequests([]);
          hideLoading();
          showToast('ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'danger');
          return;
        }
        
        console.log('âœ… getAllRequests returned', allRequests.length, 'items');
        
        // ê¸°ê°„ í•„í„°ë§
        const filtered = allRequests.filter(req => {
          if (!req.requestDate) {
            console.log('Request has no date:', req.requestNo);
            return false;
          }
          
          // ë‚ ì§œ ë¶€ë¶„ë§Œ ì¶”ì¶œ: "2026. 1. 7 PM 05:04:45" â†’ "2026. 1. 7"
          let reqDateStr = req.requestDate.split(' ')[0] + '.' + req.requestDate.split(' ')[1] + '.' + req.requestDate.split(' ')[2];
          console.log('Original date:', req.requestDate);
          console.log('Extracted date:', reqDateStr);
          
          // "2026. 1. 7" â†’ "2026-01-07"
          if (reqDateStr.includes('.')) {
            const parts = reqDateStr.split('.').map(p => p.trim()).filter(p => p);
            console.log('Date parts:', parts);
            if (parts.length >= 3) {
              reqDateStr = parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');
              console.log('Normalized date:', reqDateStr);
            }
          }
          
          const matches = reqDateStr >= startDate && reqDateStr <= endDate;
          console.log('Date comparison:', reqDateStr, '>=', startDate, '&&', reqDateStr, '<=', endDate, '=', matches);
          return matches;
        });
        
        console.log('Filtered requests:', filtered.length);
        
        // í†µê³„ ê³„ì‚°
        const stats = {
          period: {
            new: 0,
            requested: 0,
            inProgress: 0,
            delayed: 0,
            completed: 0,
            total: filtered.length
          }
        };
        
        filtered.forEach(req => {
          if (req.status === 'ì ‘ìˆ˜ì¤‘') stats.period.requested++;
          else if (['ë°œì£¼ì§„í–‰', 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)', 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)'].includes(req.status)) stats.period.inProgress++;
          else if (req.status === 'ì²˜ë¦¬ì™„ë£Œ') stats.period.completed++;
        });
        
        displayStats(stats);
        
        // ê¸´ê¸‰ ì²˜ë¦¬ ê±´
        const urgent = allRequests.filter(req => {
          if (req.status !== 'ì ‘ìˆ˜ì¤‘' || !req.requestDate) return false;
          let reqDateStr = req.requestDate.split(' ')[0];
          if (reqDateStr.includes('.')) {
            const parts = reqDateStr.split('.').map(p => p.trim());
            if (parts.length >= 3) {
              reqDateStr = parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');
            }
          }
          const oneDayAgo = new Date();
          oneDayAgo.setDate(oneDayAgo.getDate() - 1);
          const oneDayAgoStr = oneDayAgo.toISOString().split('T')[0];
          return reqDateStr < oneDayAgoStr;
        });
        displayUrgentRequests(urgent);
        
        // ì§€ì—° ê±´
        const delayed = allRequests.filter(req => {
          if (req.status !== 'ë°œì£¼ì§„í–‰' || !req.orderDate) return false;
          let orderDateStr = req.orderDate.split(' ')[0];
          if (orderDateStr.includes('.')) {
            const dateParts = req.orderDate.split(' ');
            if (dateParts.length >= 3) {
              orderDateStr = dateParts[0] + '.' + dateParts[1] + '.' + dateParts[2];
            }
            const parts = orderDateStr.split('.').map(p => p.trim()).filter(p => p);
            if (parts.length >= 3) {
              orderDateStr = parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');
            }
          }
          const threeDaysAgo = new Date();
          threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
          const threeDaysAgoStr = threeDaysAgo.toISOString().split('T')[0];
          return orderDateStr < threeDaysAgoStr;
        }).map(req => {
          const orderDate = parseKoreanDate(req.orderDate);
          const delayDays = orderDate && !isNaN(orderDate.getTime()) 
            ? Math.floor((new Date() - orderDate) / (1000 * 60 * 60 * 24))
            : 0;
          return {
            ...req,
            delayDays: delayDays
          };
        });
        displayDelayedRequests(delayed);
        
        hideLoading();
      } catch (error) {
        console.error('loadDashboardData error:', error);
        hideLoading();
        showToast('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ' + error.message, 'danger');
      }
    }

    // í†µê³„ í‘œì‹œ
    function displayStats(stats) {
      const period = stats.period || stats.today || {};
      document.getElementById('periodNew').textContent = period.new || 0;
      document.getElementById('periodRequested').textContent = period.requested || 0;
      document.getElementById('periodInProgress').textContent = period.inProgress || 0;
      document.getElementById('periodDelayed').textContent = period.delayed || 0;
      document.getElementById('periodCompleted').textContent = period.completed || 0;
      document.getElementById('periodTotal').textContent = period.total || 0;
    }

    // ê¸´ê¸‰ ì²˜ë¦¬ ê±´ í‘œì‹œ
    function displayUrgentRequests(requests) {
      const tbody = document.getElementById('urgentRequestsBody');
      tbody.innerHTML = '';

      if (!requests || requests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">ê¸´ê¸‰ ì²˜ë¦¬ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      requests.forEach(req => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${escapeHtml(req.requestNo)}</strong></td>
          <td>${escapeHtml(req.itemName)}</td>
          <td><span class="badge bg-${getStatusColor(req.status)}">${escapeHtml(req.status)}</span></td>
          <td>${escapeHtml(req.requesterName)}</td>
          <td>${formatDate(req.requestDate, 'MM-DD')}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="processRequest('${req.requestNo}')">
              ì²˜ë¦¬
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ì§€ì—° ê±´ í‘œì‹œ
    function displayDelayedRequests(requests) {
      const tbody = document.getElementById('delayedRequestsBody');
      tbody.innerHTML = '';

      if (!requests || requests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">ì§€ì—° ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      requests.forEach(req => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${escapeHtml(req.requestNo)}</strong></td>
          <td>${escapeHtml(req.itemName)}</td>
          <td><span class="badge bg-danger">${req.delayDays}ì¼</span></td>
          <td>${escapeHtml(req.requesterName)}</td>
          <td>${escapeHtml(req.handler || '-')}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick="updateDelayStatus('${req.requestNo}')">
              ìƒíƒœ ë³€ê²½
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ìƒíƒœë³„ ìƒ‰ìƒ
    function getStatusColor(status) {
      const colors = {
        'ì ‘ìˆ˜ì¤‘': 'warning',
        'ë°œì£¼ì§„í–‰': 'primary',
        'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)': 'success',
        'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)': 'info',
        'ì²˜ë¦¬ì™„ë£Œ': 'success',
        'ì ‘ìˆ˜ì·¨ì†Œ': 'secondary'
      };
      return colors[status] || 'secondary';
    }

    function formatDate(dateString, format = 'YYYY-MM-DD') {
      if (!dateString) return '';
      const date = new Date(dateString);
      if (format === 'MM-DD') {
        return (date.getMonth() + 1).toString().padStart(2, '0') + '-' + 
               date.getDate().toString().padStart(2, '0');
      }
      return date.toISOString().split('T')[0];
    }

    // API í˜¸ì¶œ í•¨ìˆ˜ë“¤
    async function getDashboardStats(sessionToken) {
      try {
        const result = await callServer('getDashboardStats', sessionToken);
        // ErrorHandlerê°€ ë°˜í™˜í•œ ê°ì²´ì¸ì§€ í™•ì¸
        if (result && result.success === false) {
          console.warn('getDashboardStats returned error:', result.message);
          return { today: {} };
        }
        return result || { today: {} };
      } catch (error) {
        console.error('getDashboardStats error:', error);
        return { today: {} };
      }
    }

    async function getUrgentRequests(sessionToken) {
      try {
        const result = await callServer('getUrgentRequests', sessionToken);
        // ErrorHandlerê°€ ë°˜í™˜í•œ ê°ì²´ì¸ì§€ í™•ì¸
        if (result && result.success === false) {
          console.warn('getUrgentRequests returned error:', result.message);
          return [];
        }
        // ë°°ì—´ì¸ì§€ í™•ì¸
        return Array.isArray(result) ? result : [];
      } catch (error) {
        console.error('getUrgentRequests error:', error);
        return [];
      }
    }

    async function getDelayedRequests(sessionToken) {
      try {
        const result = await callServer('getDelayedRequests', sessionToken);
        // ErrorHandlerê°€ ë°˜í™˜í•œ ê°ì²´ì¸ì§€ í™•ì¸
        if (result && result.success === false) {
          console.warn('getDelayedRequests returned error:', result.message);
          return [];
        }
        // ë°°ì—´ì¸ì§€ í™•ì¸
        return Array.isArray(result) ? result : [];
      } catch (error) {
        console.error('getDelayedRequests error:', error);
        return [];
      }
    }

    async function processRequest(requestNo) {
      try {
        console.log('processRequest called with requestNo:', requestNo);
        const sessionToken = getSessionToken();
        
        // âœ… sessionStorageì— íŒŒë¼ë¯¸í„° ì €ì¥ (OAuth ë¦¬ë‹¤ì´ë ‰ì…˜ ëŒ€ë¹„)
        sessionStorage.setItem('pendingRequestNo', requestNo);
        sessionStorage.setItem('pendingPage', 'admin-detail');
        console.log('Saved to sessionStorage:', { requestNo, page: 'admin-detail' });
        
        const baseUrl = await callServer('getWebAppUrl');
        console.log('Base URL:', baseUrl);
        
        if (!baseUrl) {
          showToast('í˜ì´ì§€ ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
          return;
        }
        
        const targetUrl = baseUrl + '?page=admin-detail&requestNo=' + encodeURIComponent(requestNo) + '&token=' + encodeURIComponent(sessionToken);
        console.log('Target URL:', targetUrl);
        console.log('Navigating to detail page...');
        
        if (window.top && window.top !== window) {
          window.top.location.href = targetUrl;
        } else {
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('processRequest error:', error);
        showToast('í˜ì´ì§€ ì´ë™ ì‹¤íŒ¨: ' + error.message, 'danger');
      }
    }

    async function updateDelayStatus(requestNo) {
      try {
        const sessionToken = getSessionToken();
        const baseUrl = await callServer('getWebAppUrl');
        if (!baseUrl) return;
        
        const targetUrl = baseUrl + '?page=admin-detail&requestNo=' + encodeURIComponent(requestNo) + '&token=' + encodeURIComponent(sessionToken);
        
        if (window.top && window.top !== window) {
          window.top.location.href = targetUrl;
        } else {
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('updateDelayStatus error:', error);
      }
    }

    async function navigateToDashboard() {
      try {
        const sessionToken = getSessionToken();
        const baseUrl = await callServer('getWebAppUrl');
        if (!baseUrl) { window.location.href = '?page=admin-dashboard'; return; }
        const targetUrl = baseUrl + '?page=admin-dashboard&token=' + encodeURIComponent(sessionToken);
        if (window.top && window.top !== window) window.top.location.href = targetUrl;
        else window.location.href = targetUrl;
      } catch (e) { window.location.href = '?page=admin-dashboard'; }
    }
    async function navigateToAllRequests() {
      try {
        const sessionToken = getSessionToken();
        const baseUrl = await callServer('getWebAppUrl');
        if (!baseUrl) return;
        
        const targetUrl = baseUrl + '?page=admin-requests&token=' + encodeURIComponent(sessionToken);
        
        if (window.top && window.top !== window) {
          window.top.location.href = targetUrl;
        } else {
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('navigateToAllRequests error:', error);
      }
    }

    async function navigateToStatistics() {
      try {
        const sessionToken = getSessionToken();
        const baseUrl = await callServer('getWebAppUrl');
        if (!baseUrl) return;
        
        const targetUrl = baseUrl + '?page=admin-statistics&token=' + encodeURIComponent(sessionToken);
        
        if (window.top && window.top !== window) {
          window.top.location.href = targetUrl;
        } else {
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('navigateToStatistics error:', error);
      }
    }

    async function navigateToMaster() {
      try {
        const sessionToken = getSessionToken();
        const baseUrl = await callServer('getWebAppUrl');
        if (!baseUrl) return;
        
        const targetUrl = baseUrl + '?page=admin-master&token=' + encodeURIComponent(sessionToken);
        
        if (window.top && window.top !== window) {
          window.top.location.href = targetUrl;
        } else {
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('navigateToMaster error:', error);
      }
    }

    // ìƒíƒœë³„ í•„í„°ë¡œ ì „ì²´ ì‹ ì²­ ëª©ë¡ ì´ë™
    async function navigateToStatusFilter(status) {
      try {
        const sessionToken = getSessionToken();
        const baseUrl = await callServer('getWebAppUrl');
        if (!baseUrl) return;
        
        let targetUrl = baseUrl + '?page=admin-requests&token=' + encodeURIComponent(sessionToken);
        if (status) {
          // ìƒíƒœë¥¼ URL íŒŒë¼ë¯¸í„°ì™€ sessionStorageì— ëª¨ë‘ ì €ì¥
          targetUrl += '&status=' + encodeURIComponent(status);
          sessionStorage.setItem('adminStatusFilter', status);
        }
        
        if (window.top && window.top !== window) {
          window.top.location.href = targetUrl;
        } else {
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('navigateToStatusFilter error:', error);
        showToast('í˜ì´ì§€ ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
      }
    }

    function logout() {
      if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        try {
          const sessionToken = getSessionToken();
          // ì„œë²„ ë¡œê·¸ì•„ì›ƒ í˜¸ì¶œ (ì‹¤íŒ¨í•´ë„ í´ë¼ì´ì–¸íŠ¸ ì •ë¦¬ ì§„í–‰)
          callServer('logout', sessionToken).then(() => {
            console.log('Logout successful');
          }).catch(error => {
            console.error('Logout server error:', error);
          }).finally(() => {
            // í´ë¼ì´ì–¸íŠ¸ ì„¸ì…˜ ì •ë¦¬
            sessionStorage.removeItem('sessionToken');
            sessionStorage.removeItem('currentUser');
            sessionStorage.removeItem('pendingRequestNo');
            sessionStorage.removeItem('pendingPage');
            sessionStorage.removeItem('adminStatusFilter');
            
            // iframe í™˜ê²½ ê³ ë ¤í•œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            const loginUrl = '?page=login';
            if (window.top && window.top !== window) {
              // iframe ë‚´ë¶€ì¸ ê²½ìš°
              window.top.location.href = loginUrl;
            } else {
              // ì¼ë°˜ í˜ì´ì§€ì¸ ê²½ìš°
              window.location.href = loginUrl;
            }
          });
        } catch (error) {
          console.error('Logout error:', error);
          // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ í´ë¼ì´ì–¸íŠ¸ ì •ë¦¬ ë° ë¦¬ë‹¤ì´ë ‰íŠ¸
          sessionStorage.removeItem('sessionToken');
          sessionStorage.removeItem('currentUser');
          sessionStorage.removeItem('pendingRequestNo');
          sessionStorage.removeItem('pendingPage');
          sessionStorage.removeItem('adminStatusFilter');
          
          const loginUrl = '?page=login';
          if (window.top && window.top !== window) {
            window.top.location.href = loginUrl;
          } else {
            window.location.href = loginUrl;
          }
        }
      }
    }

    // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ í™•ì¸
    console.log('âœ“ AdminDashboardPage script loaded');
  </script>
</body>
</html>

