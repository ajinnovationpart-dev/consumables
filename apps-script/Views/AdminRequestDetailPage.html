<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‹ ì²­ ìƒì„¸ ê´€ë¦¬</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* ê´€ë¦¬ì í˜ì´ì§€ëŠ” PC ì „ìš© ìŠ¤íƒ€ì¼ ì ìš© */
    body {
      font-size: 14px !important;
    }
    
    .container-fluid {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ ì œê±° */
    @media (max-width: 768px) {
      body {
        font-size: 14px !important;
      }
      
      input, .form-control, .form-select, textarea {
        font-size: 14px !important;
        min-height: auto !important;
        padding: 0.375rem 0.75rem !important;
      }
      
      button, .btn {
        font-size: 14px !important;
        min-height: auto !important;
        padding: 0.375rem 0.75rem !important;
      }
    }
    
    /* ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •) ìƒíƒœ ë°°ì§€ ìŠ¤íƒ€ì¼ */
    .badge.bg-success[data-status="ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)"] {
      background-color: #D4EDDA !important;
      color: #155724 !important;
      border: 1px solid #C3E6CB !important;
    }
  </style>
</head>
<body>
  <!-- í—¤ë” -->
  <nav class="navbar navbar-dark bg-primary mb-3">
    <div class="container-fluid px-2">
      <span class="navbar-brand mb-0">ğŸ  ë¶€í’ˆë°œì£¼ (ê´€ë¦¬ì)</span>
      <div class="d-flex align-items-center">
        <span class="text-white d-none d-md-inline me-2 small">
          ğŸ‘¤ <span id="headerUserName"></span>
        </span>
        <button class="btn btn-sm btn-outline-light" onclick="goBack()">â† ë’¤ë¡œ</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid px-2 mt-2">
    <div class="d-flex align-items-center mb-3">
      <h2 class="h4 mb-0">ì‹ ì²­ ìƒì„¸ ê´€ë¦¬ - <span id="detailRequestNo"></span></h2>
    </div>

    <!-- ê´€ë¦¬ì ì•¡ì…˜ ì˜ì—­ -->
    <div class="card mb-4 border-primary">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì ì•¡ì…˜</h5>
      </div>
      <div class="card-body">
        <form id="adminActionForm" onsubmit="saveAdminChanges(event)">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">ìƒíƒœ ë³€ê²½</label>
              <select class="form-select" id="adminStatus">
                <option value="ì ‘ìˆ˜ì¤‘">ì ‘ìˆ˜ì¤‘</option>
                <option value="ë°œì£¼ì§„í–‰">ë°œì£¼ì§„í–‰</option>
                <option value="ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)">ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)</option>
                <option value="ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)">ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)</option>
                <option value="ì²˜ë¦¬ì™„ë£Œ">ì²˜ë¦¬ì™„ë£Œ</option>
                <option value="ì ‘ìˆ˜ì·¨ì†Œ">ì ‘ìˆ˜ì·¨ì†Œ</option>
              </select>
            </div>
            
            <div class="col-md-6 mb-3">
              <label class="form-label">ë‹´ë‹¹ì ë°°ì •</label>
              <select class="form-select" id="adminHandler">
                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              </select>
            </div>
            
            <div class="col-md-6 mb-3">
              <label class="form-label">ì˜ˆìƒ ë‚©ê¸°ì¼</label>
              <input type="date" class="form-control" id="adminExpectedDeliveryDate">
            </div>
            
            <div class="col-md-12 mb-3">
              <label class="form-label">ë‹´ë‹¹ì ë¹„ê³ </label>
              <textarea class="form-control" id="adminHandlerRemarks" rows="3"></textarea>
            </div>
          </div>
          
          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button type="submit" class="btn btn-primary">
              ğŸ’¾ ì €ì¥
            </button>
            <button type="button" class="btn btn-danger" onclick="forceCancel()">
              âœ• ê°•ì œ ì·¨ì†Œ
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ì‹ ì²­ ì •ë³´ (RequestDetailPageì™€ ë™ì¼í•œ êµ¬ì¡°) -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">ğŸ“‹ ì‹ ì²­ ì •ë³´</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <strong>ì‹ ì²­ë²ˆí˜¸</strong>
            <p id="requestNo"></p>
          </div>
          <div class="col-md-6 mb-3">
            <strong>ì‹ ì²­ì¼ì‹œ</strong>
            <p id="requestDate"></p>
          </div>
          <div class="col-md-6 mb-3">
            <strong>ì‹ ì²­ì</strong>
            <p id="requester"></p>
          </div>
          <div class="col-md-6 mb-3">
            <strong>í˜„ì¬ ìƒíƒœ</strong>
            <p><span id="currentStatus" class="badge"></span></p>
          </div>
        </div>
      </div>
    </div>

    <!-- ë¶€í’ˆ ì •ë³´ -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">ğŸ”§ ë¶€í’ˆ ì •ë³´</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <strong>í’ˆëª…</strong>
            <p id="itemName"></p>
          </div>
          <div class="col-md-6 mb-3">
            <strong>ìˆ˜ëŸ‰</strong>
            <p id="quantity"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- ìˆ˜ë ¹ ì •ë³´ -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">ğŸ“¦ ìˆ˜ë ¹ ì •ë³´</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <strong>ë°°ì†¡ì§€</strong>
            <p id="deliveryPlace"></p>
          </div>
          <div class="col-md-6 mb-3">
            <strong>ì—°ë½ì²˜</strong>
            <p id="phone"></p>
          </div>
          <div class="col-md-6 mb-3">
            <strong>ì—…ì²´ëª…</strong>
            <p id="company"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- ì²¨ë¶€ ì‚¬ì§„ -->
    <div class="card mb-4" id="photoCard">
      <div class="card-header">
        <h5 class="mb-0">ğŸ“· ì²¨ë¶€ ì‚¬ì§„</h5>
      </div>
      <div class="card-body text-center">
        <img id="photoPreview" class="img-thumbnail mb-2" style="max-width: 500px; display: none; cursor: pointer;" 
             onclick="copyImageToClipboard(event)" 
             oncontextmenu="copyImageToClipboard(event); return false;" 
             title="í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ë³µì‚¬ (ì¢Œí´ë¦­/ìš°í´ë¦­)">
        <br>
        <a id="photoLink" href="#" target="_blank" class="btn btn-outline-primary" style="display: none;">
          ğŸ” ì›ë³¸ ë³´ê¸°
        </a>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <?!= include('JavaScript'); ?>
  <script>
    // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬ - ë¹ˆ í˜ì´ì§€ ë°©ì§€
    window.addEventListener('error', function(e) {
      console.error('Global error caught:', e.error || e.message);
      const errorDiv = document.createElement('div');
      errorDiv.className = 'alert alert-danger m-4';
      errorDiv.style.position = 'fixed';
      errorDiv.style.top = '20px';
      errorDiv.style.left = '50%';
      errorDiv.style.transform = 'translateX(-50%)';
      errorDiv.style.zIndex = '9999';
      errorDiv.style.maxWidth = '600px';
      errorDiv.innerHTML = `
        <h5>âš ï¸ í˜ì´ì§€ ë¡œë”© ì˜¤ë¥˜</h5>
        <p><strong>ì˜¤ë¥˜:</strong> ${e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>
        <button class="btn btn-primary btn-sm" onclick="window.location.reload()">ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn btn-secondary btn-sm" onclick="window.location.href='?page=admin-requests'">ëª©ë¡ìœ¼ë¡œ</button>
      `;
      document.body.appendChild(errorDiv);
    });

    let currentRequest = null;

    // ì„¸ì…˜ í† í° ê°€ì ¸ì˜¤ê¸°
    function getSessionToken() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('token') || sessionStorage.getItem('sessionToken');
    }
    
    // ì‹ ì²­ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
    function getRequestNo() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('requestNo');
    }

    // í˜ì´ì§€ ì´ˆê¸°í™”
    window.onload = async function() {
      try {
        console.log('AdminRequestDetailPage: Initializing...');
        console.log('Current URL:', window.location.href);
        console.log('URL search params:', window.location.search);
        
        const sessionToken = getSessionToken();
        console.log('Session token:', sessionToken ? 'Present' : 'Missing');
        
        if (!sessionToken) {
          console.warn('No session token, redirecting to login');
          window.location.href = '?page=login';
          return;
        }

        const urlParams = new URLSearchParams(window.location.search);
        console.log('All URL params:', Array.from(urlParams.entries()));
        
        // âœ… URL íŒŒë¼ë¯¸í„° ë¨¼ì € ì‹œë„, ì—†ìœ¼ë©´ sessionStorageì—ì„œ ì½ê¸°
        let requestNo = urlParams.get('requestNo');
        
        if (!requestNo) {
          console.log('No requestNo in URL, checking sessionStorage...');
          requestNo = sessionStorage.getItem('pendingRequestNo');
          console.log('Found in sessionStorage:', requestNo);
          
          // ì‚¬ìš© í›„ ì‚­ì œ
          if (requestNo) {
            sessionStorage.removeItem('pendingRequestNo');
            sessionStorage.removeItem('pendingPage');
          }
        }
        
        console.log('Request No:', requestNo);
        console.log('Request No type:', typeof requestNo);
        console.log('Request No length:', requestNo ? requestNo.length : 0);

        if (!requestNo) {
          console.warn('No request number provided');
          showErrorModal('ì‹ ì²­ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤. ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.');
          return;
        }

        const startTime = performance.now();
        showLoading('ìƒì„¸ ì •ë³´ ë¡œë”© ì¤‘...');

        // âœ… ì‚¬ìš©ì ì •ë³´ ìºì‹œ í™•ì¸
        let user = sessionStorage.getItem('currentUser');
        if (user) {
          user = JSON.parse(user);
          console.log('âœ… Using cached user info');
        } else {
          user = await callServer('getCurrentUser', sessionToken);
          if (user) {
            sessionStorage.setItem('currentUser', JSON.stringify(user));
          }
        }
        
        if (!user || user.role !== 'ê´€ë¦¬ì') {
          hideLoading();
          window.location.href = '?page=login';
          return;
        }

        document.getElementById('headerUserName').textContent = user.name || '';

        currentRequest = await callServer('getRequest', requestNo, sessionToken);
        
        if (!currentRequest) {
          console.warn('Request not found');
          hideLoading();
          showErrorModal('ì‹ ì²­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.');
          return;
        }
        
        // ì—ëŸ¬ ì‘ë‹µ ì²´í¬ (ErrorHandlerì—ì„œ ë°˜í™˜ëœ ê²½ìš°)
        if (currentRequest.success === false) {
          console.error('Request loading failed:', currentRequest.message);
          hideLoading();
          showErrorModal('ì‹ ì²­ ì •ë³´ ë¡œë”© ì‹¤íŒ¨:<br>' + currentRequest.message);
          return;
        }

        displayRequestDetail(currentRequest);

        hideLoading();
        
        const loadTime = (performance.now() - startTime).toFixed(0);
        console.log(`âœ… AdminRequestDetailPage loaded in ${loadTime}ms`);
      } catch (error) {
        console.error('AdminRequestDetailPage init error:', error);
        console.error('Error stack:', error.stack);
        hideLoading();
        showToast('ìƒì„¸ ì •ë³´ ë¡œë”© ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'danger');
      }
    };

    // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
    async function reloadRequestData() {
      try {
        const sessionToken = getSessionToken();
        const requestNo = currentRequest ? currentRequest.requestNo : getRequestNo();
        
        if (!requestNo) return;
        
        showLoading('ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì¤‘...');
        currentRequest = await callServer('getRequest', requestNo, sessionToken);
        
        if (currentRequest && currentRequest.success !== false) {
          displayRequestDetail(currentRequest);
        }
        hideLoading();
      } catch (error) {
        console.error('reloadRequestData error:', error);
        hideLoading();
      }
    }

    // ìƒì„¸ ì •ë³´ í‘œì‹œ
    function displayRequestDetail(req) {
      document.getElementById('detailRequestNo').textContent = req.requestNo;
      document.getElementById('requestNo').textContent = req.requestNo;
      document.getElementById('requestDate').textContent = formatDateTime(req.requestDate);
      document.getElementById('requester').textContent = `${req.requesterName || ''} (${req.team || ''})`;
      document.getElementById('itemName').textContent = req.itemName || '-';
      document.getElementById('quantity').textContent = req.quantity || '-';
      
      // ìˆ˜ë ¹ ì •ë³´
      document.getElementById('deliveryPlace').textContent = req.deliveryPlace || '-';
      document.getElementById('phone').textContent = req.phone || '-';
      document.getElementById('company').textContent = req.company || '-';

      const statusBadge = document.getElementById('currentStatus');
      statusBadge.textContent = req.status;
      statusBadge.className = `badge bg-${getStatusColor(req.status)}`;
      // ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •) ìƒíƒœì— ëŒ€í•œ ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì ìš©
      if (req.status === 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)') {
        statusBadge.setAttribute('data-status', 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)');
        applyStatusColor(statusBadge, req.status);
      }

      // ê´€ë¦¬ì ì•¡ì…˜ í¼ ê°’ ì„¤ì •
      document.getElementById('adminStatus').value = req.status || 'ì ‘ìˆ˜ì¤‘';
      document.getElementById('adminHandler').value = req.handler || '';
      document.getElementById('adminExpectedDeliveryDate').value = req.expectedDeliveryDate ? 
        new Date(req.expectedDeliveryDate).toISOString().split('T')[0] : '';
      document.getElementById('adminHandlerRemarks').value = req.handlerRemarks || '';

      // ì‚¬ì§„ í‘œì‹œ
      if (req.photoUrl) {
        const imgElement = document.getElementById('photoPreview');
        imgElement.setAttribute('data-original-url', req.photoUrl); // ì›ë³¸ URL ì €ì¥
        document.getElementById('photoLink').href = req.photoUrl;
        document.getElementById('photoLink').style.display = 'inline-block';
        
        // Google Drive ì´ë¯¸ì§€ì¸ ê²½ìš° ì„œë²„ë¥¼ í†µí•´ ê°€ì ¸ì™€ì„œ í‘œì‹œ
        if (req.photoUrl.includes('drive.google.com')) {
          showLoading('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
          const sessionToken = getSessionToken();
          
          callServer('getImageAsBase64', req.photoUrl, sessionToken)
            .then(result => {
              if (result && result.success && result.dataUrl) {
                // Base64 Data URLë¡œ ì´ë¯¸ì§€ í‘œì‹œ
                imgElement.src = result.dataUrl;
                imgElement.style.display = 'block';
                console.log('Image loaded successfully from server');
                
                // ì´ë¯¸ì§€ ë¯¸ë¦¬ ë¡œë“œ (ë³µì‚¬ ì¤€ë¹„)
                preloadImageForCopy(req.photoUrl).catch(err => {
                  console.log('Image preload failed (non-critical):', err);
                });
              } else {
                throw new Error(result?.error || 'ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
              }
            })
            .catch(error => {
              console.error('Failed to load image:', error);
              // ì‹¤íŒ¨ ì‹œ ì›ë³¸ URLë¡œ ì‹œë„
              imgElement.src = req.photoUrl;
              imgElement.style.display = 'block';
              showToast('ì´ë¯¸ì§€ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì›ë³¸ ë§í¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.', 'warning');
            })
            .finally(() => {
              hideLoading();
            });
        } else {
          // ì¼ë°˜ ì´ë¯¸ì§€ URLì¸ ê²½ìš° ì§ì ‘ í‘œì‹œ
          imgElement.src = req.photoUrl;
          imgElement.style.display = 'block';
          
          // ì´ë¯¸ì§€ ë¯¸ë¦¬ ë¡œë“œ (ë³µì‚¬ ì¤€ë¹„)
          preloadImageForCopy(req.photoUrl).catch(err => {
            console.log('Image preload failed (non-critical):', err);
          });
        }
      } else {
        document.getElementById('photoCard').style.display = 'none';
      }
    }

    function getStatusColor(status) {
      const colors = {
        'ì ‘ìˆ˜ì¤‘': 'warning',
        'ë°œì£¼ì§„í–‰': 'primary',
        'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)': 'success',
        'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)': 'success', // ìƒ‰ìƒì½”ë“œ #D4EDDAì— ë§ì¶° successë¡œ ë³€ê²½
        'ì²˜ë¦¬ì™„ë£Œ': 'success',
        'ì ‘ìˆ˜ì·¨ì†Œ': 'secondary'
      };
      return colors[status] || 'secondary';
    }
    
    // ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •) ìƒíƒœì— ëŒ€í•œ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ì ìš©
    function applyStatusColor(element, status) {
      if (status === 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)') {
        element.style.backgroundColor = '#D4EDDA';
        element.style.color = '#155724';
        element.style.borderColor = '#C3E6CB';
      }
    }

    function formatDateTime(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleString('ko-KR');
    }

    // ê´€ë¦¬ì ë³€ê²½ì‚¬í•­ ì €ì¥
    async function saveAdminChanges(event) {
      event.preventDefault();

      if (!confirm('ë³€ê²½ì‚¬í•­ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      try {
        const sessionToken = getSessionToken();
        showLoading('ì €ì¥ ì¤‘...');

        const updates = {
          status: document.getElementById('adminStatus').value,
          handler: document.getElementById('adminHandler').value,
          expectedDeliveryDate: document.getElementById('adminExpectedDeliveryDate').value,
          handlerRemarks: document.getElementById('adminHandlerRemarks').value
        };

        const result = await callServer('updateRequestStatus', 
          currentRequest.requestNo, 
          updates.status, 
          updates.handlerRemarks, 
          sessionToken,
          updates.handler,
          updates.expectedDeliveryDate);

        hideLoading();

        if (result.success) {
          // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
          await reloadRequestData();
          
          // ì„±ê³µ ëª¨ë‹¬ í‘œì‹œ
          const modal = document.createElement('div');
          modal.className = 'modal fade show';
          modal.style.display = 'block';
          modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
          modal.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header bg-success text-white">
                  <h5 class="modal-title">âœ… ì €ì¥ ì™„ë£Œ</h5>
                </div>
                <div class="modal-body text-center">
                  <p><strong>ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</strong></p>
                </div>
                <div class="modal-footer justify-content-center">
                  <button type="button" class="btn btn-primary" onclick="this.closest('.modal').remove()">í™•ì¸</button>
                </div>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        } else {
          showToast('ì €ì¥ ì‹¤íŒ¨: ' + result.message, 'danger');
        }

      } catch (error) {
        hideLoading();
        showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'danger');
      }
    }

    // ê°•ì œ ì·¨ì†Œ
    async function forceCancel() {
      const reason = prompt('ì·¨ì†Œ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (!reason) return;

      if (!confirm('ì •ë§ ì´ ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      try {
        const sessionToken = getSessionToken();
        showLoading('ì·¨ì†Œ ì²˜ë¦¬ ì¤‘...');

        const result = await callServer('updateRequestStatus', 
          currentRequest.requestNo, 
          'ì ‘ìˆ˜ì·¨ì†Œ', 
          reason, 
          sessionToken);

        hideLoading();

        if (result.success) {
          // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
          await reloadRequestData();
          
          // ì„±ê³µ ëª¨ë‹¬ í‘œì‹œ
          const modal = document.createElement('div');
          modal.className = 'modal fade show';
          modal.style.display = 'block';
          modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
          modal.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header bg-success text-white">
                  <h5 class="modal-title">âœ… ì·¨ì†Œ ì™„ë£Œ</h5>
                </div>
                <div class="modal-body text-center">
                  <p><strong>ì‹ ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.</strong></p>
                </div>
                <div class="modal-footer justify-content-center">
                  <button type="button" class="btn btn-primary" onclick="this.closest('.modal').remove(); goBack()">ëª©ë¡ìœ¼ë¡œ</button>
                </div>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        } else {
          showToast('ì·¨ì†Œ ì‹¤íŒ¨: ' + result.message, 'danger');
        }

      } catch (error) {
        hideLoading();
        showToast('ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'danger');
      }
    }

    // ì—ëŸ¬ ëª¨ë‹¬ í‘œì‹œ (SecurityError ë°©ì§€)
    function showErrorModal(message) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; text-align: center;">
          <h4 style="color: #dc3545; margin-bottom: 20px;">âš ï¸ ì•Œë¦¼</h4>
          <p style="margin-bottom: 30px;">${message}</p>
          <button class="btn btn-primary btn-lg" onclick="this.closest('div').parentElement.remove(); goBack();">
            ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
          </button>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    // Google Drive URLì„ ì´ë¯¸ì§€ë¡œ í‘œì‹œ ê°€ëŠ¥í•œ URLë¡œ ë³€í™˜
    function convertDriveUrlToImage(url) {
      if (!url || !url.includes('drive.google.com')) {
        return url;
      }
      
      // íŒŒì¼ ID ì¶”ì¶œ
      let fileId = null;
      
      // í˜•ì‹ 1: /file/d/FILE_ID/view
      const match1 = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
      if (match1) {
        fileId = match1[1];
      }
      
      // í˜•ì‹ 2: ?id=FILE_ID
      if (!fileId) {
        const match2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
        if (match2) {
          fileId = match2[1];
        }
      }
      
      if (fileId) {
        // ì´ë¯¸ì§€ë¡œ í‘œì‹œ ê°€ëŠ¥í•œ URLë¡œ ë³€í™˜
        return 'https://drive.google.com/uc?export=view&id=' + fileId;
      }
      
      return url;
    }
    
    // Google Drive URLì„ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ URLë¡œ ë³€í™˜
    function convertDriveUrlToDownload(url) {
      if (!url || !url.includes('drive.google.com')) {
        return url;
      }
      
      // íŒŒì¼ ID ì¶”ì¶œ
      let fileId = null;
      
      // í˜•ì‹ 1: /file/d/FILE_ID/view
      const match1 = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
      if (match1) {
        fileId = match1[1];
      }
      
      // í˜•ì‹ 2: ?id=FILE_ID
      if (!fileId) {
        const match2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
        if (match2) {
          fileId = match2[1];
        }
      }
      
      if (fileId) {
        // ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ URLë¡œ ë³€í™˜
        return 'https://drive.google.com/uc?export=download&id=' + fileId;
      }
      
      return url;
    }

    // ì´ë¯¸ì§€ Blob ìºì‹œ
    let cachedImageBlob = null;
    let cachedImageUrl = null;
    
    // ì´ë¯¸ì§€ ë¯¸ë¦¬ ë¡œë“œ (ì›ë³¸ URLì„ ë°›ì•„ì„œ ì²˜ë¦¬)
    async function preloadImageForCopy(originalUrl) {
      try {
        const sessionToken = getSessionToken();
        
        // Google Drive ì´ë¯¸ì§€ì¸ ê²½ìš° ì„œë²„ë¥¼ í†µí•´ ê°€ì ¸ì˜¤ê¸°
        if (originalUrl && originalUrl.includes('drive.google.com')) {
          const result = await callServer('getImageAsBase64', originalUrl, sessionToken);
          
          if (!result || !result.success) {
            throw new Error(result?.error || 'ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
          
          // Base64 Data URLì„ Blobìœ¼ë¡œ ë³€í™˜
          const response = await fetch(result.dataUrl);
          cachedImageBlob = await response.blob();
          cachedImageUrl = originalUrl;
          console.log('Image preloaded successfully for copy');
          return cachedImageBlob;
        }
        
        // ì¼ë°˜ ì´ë¯¸ì§€ URLì¸ ê²½ìš° ì§ì ‘ fetch
        const response = await fetch(originalUrl, {
          mode: 'cors',
          credentials: 'omit'
        });
        
        if (!response.ok) {
          throw new Error('HTTP error! status: ' + response.status);
        }
        
        cachedImageBlob = await response.blob();
        cachedImageUrl = originalUrl;
        
        if (!cachedImageBlob.type.startsWith('image/')) {
          throw new Error('Not an image file');
        }
        
        return cachedImageBlob;
        
      } catch (error) {
        console.error('Image preload failed:', error);
        cachedImageBlob = null;
        cachedImageUrl = null;
        return null;
      }
    }
    
    // ì´ë¯¸ì§€ í´ë¦­ ë³µì‚¬ ê¸°ëŠ¥ (ì¢Œí´ë¦­/ìš°í´ë¦­ ëª¨ë‘ ì§€ì›)
    async function copyImageToClipboard(event) {
      event.preventDefault();
      event.stopPropagation();
      
      const img = event.target;
      if (!img || !img.src) {
        showToast('ë³µì‚¬í•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
      }
      
      // ì›ë³¸ URL ì°¾ê¸° (photoLinkì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ imgì˜ data-original-url ì†ì„± ì‚¬ìš©)
      let originalUrl = img.getAttribute('data-original-url');
      if (!originalUrl) {
        // photoLinkì—ì„œ ì›ë³¸ URL ê°€ì ¸ì˜¤ê¸°
        const photoLink = document.getElementById('photoLink');
        if (photoLink && photoLink.href) {
          originalUrl = photoLink.href;
        } else {
          originalUrl = img.src;
        }
      }
      
      // ìºì‹œëœ ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ URLì´ ë³€ê²½ëœ ê²½ìš° ë¯¸ë¦¬ ë¡œë“œ
      if (!cachedImageBlob || cachedImageUrl !== originalUrl) {
        showToast('ì´ë¯¸ì§€ë¥¼ ì¤€ë¹„í•˜ëŠ” ì¤‘...', 'info');
        const blob = await preloadImageForCopy(originalUrl);
        if (!blob) {
          showToast('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
          return;
        }
      }
      
      // ì‚¬ìš©ì ì œìŠ¤ì²˜ì™€ ì§ì ‘ ì—°ê²°ëœ í´ë¦½ë³´ë“œ ì ‘ê·¼
      try {
        // í´ë¦½ë³´ë“œ ì ‘ê·¼ì„ ì‚¬ìš©ì ì œìŠ¤ì²˜ì™€ ì§ì ‘ ì—°ê²°
        const item = new ClipboardItem({ [cachedImageBlob.type]: cachedImageBlob });
        await navigator.clipboard.write([item]);
        
        showToast('ì´ë¯¸ì§€ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        
      } catch (error) {
        console.error('Clipboard write failed:', error);
        
        // ëŒ€ì²´ ë°©ë²•: ì´ë¯¸ì§€ URL ë³µì‚¬
        try {
          await navigator.clipboard.writeText(originalUrl);
          showToast('ì´ë¯¸ì§€ URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        } catch (urlError) {
          console.error('URL copy also failed:', urlError);
          showToast('ì´ë¯¸ì§€ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ í´ë¦­í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
        }
      }
    }

    async function goBack() {
      try {
        const sessionToken = getSessionToken();
        const baseUrl = await callServer('getWebAppUrl');
        if (!baseUrl) {
          window.location.href = '?page=admin-dashboard';
          return;
        }
        
        const targetUrl = baseUrl + '?page=admin-requests&token=' + encodeURIComponent(sessionToken);
        
        if (window.top && window.top !== window) {
          window.top.location.href = targetUrl;
        } else {
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('goBack error:', error);
        window.location.href = '?page=admin-dashboard';
      }
    }

    // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ í™•ì¸
    console.log('âœ“ AdminRequestDetailPage script loaded');
  </script>
</body>
</html>

