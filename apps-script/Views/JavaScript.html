<script>
  // ==========================================
  // ì„±ëŠ¥ ìµœì í™”: ë©”ëª¨ë¦¬ ìºì‹œ ê´€ë¦¬ì
  // ==========================================
  
  class MemoryCache {
    constructor(maxSize = 100, ttl = 300000) { // ê¸°ë³¸ 5ë¶„
      this.cache = new Map();
      this.maxSize = maxSize;
      this.defaultTTL = ttl;
    }
    
    get(key) {
      const item = this.cache.get(key);
      if (!item) return null;
      
      if (Date.now() > item.expiry) {
        this.cache.delete(key);
        return null;
      }
      
      return item.value;
    }
    
    set(key, value, ttl = this.defaultTTL) {
      // ìºì‹œ í¬ê¸° ì œí•œ
      if (this.cache.size >= this.maxSize) {
        const firstKey = this.cache.keys().next().value;
        this.cache.delete(firstKey);
      }
      
      this.cache.set(key, {
        value: value,
        expiry: Date.now() + ttl
      });
    }
    
    remove(key) {
      this.cache.delete(key);
    }
    
    clear() {
      this.cache.clear();
    }
  }
  
  // ì „ì—­ ë©”ëª¨ë¦¬ ìºì‹œ ì¸ìŠ¤í„´ìŠ¤
  const memoryCache = new MemoryCache(200, 60000); // 200ê°œ í•­ëª©, 1ë¶„ TTL
  
  // ==========================================
  // ì„±ëŠ¥ ìµœì í™”: ë””ë°”ìš´ì‹± & ì“°ë¡œí‹€ë§
  // ==========================================
  
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
  
  function throttle(func, limit) {
    let inThrottle;
    return function(...args) {
      if (!inThrottle) {
        func.apply(this, args);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    };
  }
  
  // ==========================================
  // ì„±ëŠ¥ ìµœì í™”: ë°°ì¹˜ ìš”ì²­ ê´€ë¦¬ì
  // ==========================================
  
  class BatchRequestManager {
    constructor(batchDelay = 50) {
      this.pendingRequests = new Map();
      this.batchDelay = batchDelay;
      this.batchTimer = null;
    }
    
    addRequest(key, requestFn) {
      this.pendingRequests.set(key, requestFn);
      
      if (!this.batchTimer) {
        this.batchTimer = setTimeout(() => {
          this.executeBatch();
        }, this.batchDelay);
      }
    }
    
    async executeBatch() {
      const requests = Array.from(this.pendingRequests.values());
      this.pendingRequests.clear();
      this.batchTimer = null;
      
      if (requests.length > 0) {
        return Promise.all(requests.map(fn => fn()));
      }
    }
  }
  
  const batchManager = new BatchRequestManager();
  
  // ==========================================
  // Google Apps Script ë¹„ë™ê¸° í˜¸ì¶œ ë˜í¼ (ìµœì í™”)
  // ==========================================
  
  // ìš”ì²­ ìºì‹±ì„ ìœ„í•œ ë§µ
  const pendingRequests = new Map();
  
  function callServer(functionName, ...args) {
    // ìºì‹œ í‚¤ ìƒì„±
    const cacheKey = `${functionName}_${JSON.stringify(args)}`;
    
    // ë©”ëª¨ë¦¬ ìºì‹œ í™•ì¸
    const cached = memoryCache.get(cacheKey);
    if (cached !== null) {
      return Promise.resolve(cached);
    }
    
    // ë™ì¼í•œ ìš”ì²­ì´ ì§„í–‰ ì¤‘ì´ë©´ ê¸°ì¡´ Promise ë°˜í™˜
    if (pendingRequests.has(cacheKey)) {
      return pendingRequests.get(cacheKey);
    }
    
    // ìƒˆ ìš”ì²­ ìƒì„±
    const promise = new Promise((resolve, reject) => {
      const startTime = performance.now();
      
      google.script.run
        .withSuccessHandler((result) => {
          const duration = performance.now() - startTime;
          console.log(`âœ… ${functionName} completed in ${duration.toFixed(0)}ms`);
          
          // ë©”ëª¨ë¦¬ ìºì‹œì— ì €ì¥ (1ë¶„)
          memoryCache.set(cacheKey, result, 60000);
          
          // ì§„í–‰ ì¤‘ì¸ ìš”ì²­ ì œê±°
          pendingRequests.delete(cacheKey);
          
          resolve(result);
        })
        .withFailureHandler((error) => {
          console.error(`âŒ ${functionName} failed:`, error);
          pendingRequests.delete(cacheKey);
          reject(error);
        })
        [functionName](...args);
    });
    
    pendingRequests.set(cacheKey, promise);
    return promise;
  }
  
  // ==========================================
  // ë¡œë”© UI ê´€ë¦¬ (ìµœì í™”)
  // ==========================================
  
  let loadingCount = 0;
  
  function showLoading(message = 'ì²˜ë¦¬ ì¤‘...') {
    loadingCount++;
    
    let overlay = document.getElementById('loadingOverlay');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.id = 'loadingOverlay';
      overlay.className = 'loading-overlay fade-in';
      document.body.appendChild(overlay);
    }
    
    overlay.innerHTML = `
      <div class="text-center text-white">
        <div class="spinner-border mb-2" role="status"></div>
        <div>${escapeHtml(message)}</div>
      </div>
    `;
    overlay.style.display = 'flex';
  }
  
  function hideLoading() {
    loadingCount = Math.max(0, loadingCount - 1);
    
    if (loadingCount === 0) {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.style.display = 'none';
      }
    }
  }
  
  // ==========================================
  // í† ìŠ¤íŠ¸ ì•Œë¦¼ (ìµœì í™”)
  // ==========================================
  
  const toastContainer = (function() {
    let container = document.getElementById('toastContainer');
    if (!container) {
      container = document.createElement('div');
      container.id = 'toastContainer';
      container.className = 'position-fixed top-0 end-0 p-3';
      container.style.zIndex = '10000';
      document.body.appendChild(container);
    }
    return container;
  })();
  
  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show shadow-lg`;
    toast.style.minWidth = '300px';
    toast.style.maxWidth = '400px';
    toast.style.marginBottom = '0.5rem';
    toast.innerHTML = `
      ${escapeHtml(message)}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    toastContainer.appendChild(toast);
    
    // ìë™ ì œê±°
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }
  
  // ==========================================
  // XSS ë°©ì§€ - HTML ì´ìŠ¤ì¼€ì´í”„ (ìµœì í™”)
  // ==========================================
  
  const escapeHtmlCache = new Map();
  
  function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    
    // ìºì‹œ í™•ì¸
    if (escapeHtmlCache.has(text)) {
      return escapeHtmlCache.get(text);
    }
    
    const div = document.createElement('div');
    div.textContent = text;
    const escaped = div.innerHTML;
    
    // ìºì‹œ ì €ì¥ (ìµœëŒ€ 1000ê°œ)
    if (escapeHtmlCache.size < 1000) {
      escapeHtmlCache.set(text, escaped);
    }
    
    return escaped;
  }
  
  // ==========================================
  // ë‚ ì§œ í¬ë§·íŒ… (ìµœì í™”)
  // ==========================================
  
  const dateFormatCache = new Map();
  
  function formatDate(dateString) {
    if (!dateString) return '';
    
    // ìºì‹œ í™•ì¸
    if (dateFormatCache.has(dateString)) {
      return dateFormatCache.get(dateString);
    }
    
    try {
      const date = new Date(dateString);
      const formatted = date.toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      // ìºì‹œ ì €ì¥ (ìµœëŒ€ 500ê°œ)
      if (dateFormatCache.size < 500) {
        dateFormatCache.set(dateString, formatted);
      }
      
      return formatted;
    } catch (e) {
      return dateString;
    }
  }
  
  // ==========================================
  // íŒŒì¼ ì—…ë¡œë“œ (ìµœì í™”)
  // ==========================================
  
  async function uploadPhoto(fileInput) {
    const file = fileInput.files[0];
    
    if (!file) {
      throw new Error('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    }
    
    // íŒŒì¼ í¬ê¸° ì²´í¬ (5MB ì œí•œ)
    if (file.size > 5 * 1024 * 1024) {
      throw new Error('íŒŒì¼ í¬ê¸°ëŠ” 5MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• (ìµœì í™”)
    const resizedImage = await resizeImage(file, 1920, 1080);
    
    // Base64 ì¸ì½”ë”©
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => resolve(e.target.result);
      reader.error = reject;
      reader.readAsDataURL(resizedImage);
    });
  }
  
  // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• (Canvas API í™œìš©, ìµœì í™”)
  function resizeImage(file, maxWidth, maxHeight) {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        // ë¹„ìœ¨ ê³„ì‚°
        if (width > height) {
          if (width > maxWidth) {
            height *= maxWidth / width;
            width = maxWidth;
          }
        } else {
          if (height > maxHeight) {
            width *= maxHeight / height;
            height = maxHeight;
          }
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        
        // ì´ë¯¸ì§€ í’ˆì§ˆ ìµœì í™”
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, 0, 0, width, height);
        
        // JPEG í’ˆì§ˆ 85%ë¡œ ì••ì¶•
        canvas.toBlob(resolve, 'image/jpeg', 0.85);
      };
      img.src = URL.createObjectURL(file);
    });
  }
  
  // ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° (ìµœì í™”)
  function showPhotoPreview(fileInput, previewId) {
    const file = fileInput.files[0];
    if (!file) return;
    
    const preview = document.getElementById(previewId);
    if (!preview) return;
    
    // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì§• í›„ ë¯¸ë¦¬ë³´ê¸°
    resizeImage(file, 800, 600).then(blob => {
      const reader = new FileReader();
      reader.onload = (e) => {
        preview.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(blob);
    });
  }
  
  // ==========================================
  // ìƒíƒœ ë°°ì§€ ìƒì„± (ìµœì í™”)
  // ==========================================
  
  const badgeCache = new Map();
  
  function createStatusBadge(status) {
    if (badgeCache.has(status)) {
      return badgeCache.get(status);
    }
    
    const badge = `<span class="badge badge-${escapeHtml(status)}">${escapeHtml(status)}</span>`;
    
    // ìºì‹œ ì €ì¥
    if (badgeCache.size < 100) {
      badgeCache.set(status, badge);
    }
    
    return badge;
  }
  
  // ==========================================
  // ì—ëŸ¬ ì²˜ë¦¬ (ìµœì í™”)
  // ==========================================
  
  function handleError(error) {
    console.error('Error:', error);
    const message = error.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
    showToast(message, 'danger');
  }
  
  // ==========================================
  // ì„¸ì…˜ ê´€ë¦¬ (ìµœì í™”)
  // ==========================================
  
  function getSessionToken() {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token') || sessionStorage.getItem('sessionToken');
    
    if (token) {
      sessionStorage.setItem('sessionToken', token);
    }
    
    return token;
  }
  
  // ==========================================
  // ë„¤ë¹„ê²Œì´ì…˜ (ìµœì í™”)
  // ==========================================
  
  const navigateTo = debounce(async function(page) {
    try {
      const sessionToken = getSessionToken();
      if (!sessionToken) {
        window.location.href = '?page=login';
        return;
      }
      
      const baseUrl = await callServer('getWebAppUrl');
      const targetUrl = baseUrl + '?page=' + page + '&token=' + encodeURIComponent(sessionToken);
      
      if (window.top && window.top !== window) {
        window.top.location.href = targetUrl;
      } else {
        window.location.href = targetUrl;
      }
    } catch (error) {
      console.error('Navigation error:', error);
      handleError(error);
    }
  }, 300);
  
  // ==========================================
  // ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
  // ==========================================
  
  if (typeof performance !== 'undefined' && performance.mark) {
    // í˜ì´ì§€ ë¡œë“œ ì‹œê°„ ì¸¡ì •
    window.addEventListener('load', () => {
      const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
      console.log(`ğŸ“Š Page load time: ${loadTime}ms`);
    });
  }
  
  // ==========================================
  // ë©”ëª¨ë¦¬ ì •ë¦¬ (ì£¼ê¸°ì )
  // ==========================================
  
  setInterval(() => {
    // ì˜¤ë˜ëœ ìºì‹œ ì •ë¦¬
    if (escapeHtmlCache.size > 500) {
      const keysToDelete = Array.from(escapeHtmlCache.keys()).slice(0, 250);
      keysToDelete.forEach(key => escapeHtmlCache.delete(key));
    }
    
    if (dateFormatCache.size > 250) {
      const keysToDelete = Array.from(dateFormatCache.keys()).slice(0, 125);
      keysToDelete.forEach(key => dateFormatCache.delete(key));
    }
  }, 60000); // 1ë¶„ë§ˆë‹¤
  
  // ==========================================
  // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬ (Google Apps Script ë‚´ë¶€ ì—ëŸ¬ ë¬´ì‹œ)
  // ==========================================
  
  // document.write ê´€ë ¨ ì—ëŸ¬ ë¬´ì‹œ (Google Apps Script ë‚´ë¶€ ìŠ¤í¬ë¦½íŠ¸ ë¡œë”ì—ì„œ ë°œìƒ)
  window.addEventListener('error', function(event) {
    // Google Apps Script ë‚´ë¶€ ìŠ¤í¬ë¦½íŠ¸ ë¡œë”ì—ì„œ ë°œìƒí•˜ëŠ” document.write ì—ëŸ¬ëŠ” ë¬´ì‹œ
    if (event.message && event.message.includes("Failed to execute 'write' on 'Document'")) {
      event.preventDefault();
      console.warn('Google Apps Script internal script loader error (ignored):', event.message);
      return false;
    }
    // ë‹¤ë¥¸ ì—ëŸ¬ëŠ” ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬
    return true;
  }, true);
  
  // Unhandled promise rejection ì²˜ë¦¬
  window.addEventListener('unhandledrejection', function(event) {
    // Google Apps Script ê´€ë ¨ ì—ëŸ¬ëŠ” ë¬´ì‹œ
    if (event.reason && typeof event.reason === 'string' && 
        event.reason.includes("Failed to execute 'write'")) {
      event.preventDefault();
      console.warn('Google Apps Script internal error (ignored):', event.reason);
      return false;
    }
    return true;
  });
</script>
