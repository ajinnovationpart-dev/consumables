<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë¶€í’ˆë°œì£¼ì‹œìŠ¤í…œ - ëŒ€ì‹œë³´ë“œ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <?!= include('Stylesheet'); ?>
</head>
<body>
  <!-- í—¤ë” -->
  <nav class="navbar navbar-dark bg-primary mb-3">
    <div class="container-fluid px-2">
      <span class="navbar-brand mb-0">ğŸ  ë¶€í’ˆë°œì£¼</span>
      <div class="d-flex align-items-center flex-wrap gap-1">
        <span class="text-white d-none d-md-inline me-2 small">
          ğŸ‘¤ <span id="userName"></span> (<span id="userTeam"></span>)
        </span>
        <button class="btn btn-sm btn-light position-relative" onclick="showNotifications()">
          ğŸ””
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationCount">0</span>
        </button>
        <button class="btn btn-sm btn-outline-light" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid px-2">
    <!-- ìš”ì•½ ì¹´ë“œ -->
    <div class="row g-2 mb-3">
      <div class="col-6 col-md-3">
        <div class="card text-center border-warning h-100">
          <div class="card-body p-3 p-md-3">
            <h6 class="card-title mb-2 mb-md-2 fw-bold">ì ‘ìˆ˜ì¤‘</h6>
            <h2 class="text-warning mb-0 fw-bold" id="countRequested">0</h2>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card text-center border-info h-100">
          <div class="card-body p-3 p-md-3">
            <h6 class="card-title mb-2 mb-md-2 fw-bold">ì§„í–‰ì¤‘</h6>
            <h2 class="text-info mb-0 fw-bold" id="countInProgress">0</h2>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card text-center border-success h-100">
          <div class="card-body p-3 p-md-3">
            <h6 class="card-title mb-2 mb-md-2 fw-bold">ì™„ë£Œ</h6>
            <h2 class="text-success mb-0 fw-bold" id="countCompleted">0</h2>
          </div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card text-center border-primary h-100">
          <div class="card-body p-3 p-md-3">
            <h6 class="card-title mb-2 mb-md-2 fw-bold">ì „ì²´</h6>
            <h2 class="text-primary mb-0 fw-bold" id="countTotal">0</h2>
          </div>
        </div>
      </div>
    </div>

    <!-- ë¹ ë¥¸ ì•¡ì…˜ -->
    <div class="d-grid gap-2 d-md-block mb-3">
      <button class="btn btn-primary btn-lg w-100 w-md-auto" onclick="navigateToNewRequest()">
        â• ìƒˆ ì‹ ì²­ ë“±ë¡
      </button>
      <button class="btn btn-outline-primary btn-lg w-100 w-md-auto ms-md-2 mt-2 mt-md-0" onclick="navigateToMyRequests()">
        ğŸ“‹ ë‚´ ì‹ ì²­ ëª©ë¡
      </button>
      <button class="btn btn-outline-secondary btn-lg w-100 w-md-auto ms-md-2 mt-2 mt-md-0" onclick="navigateToMyInfo()">
        âš™ï¸ ë‚´ ì •ë³´
      </button>
    </div>

    <!-- ìµœê·¼ ì‹ ì²­ ë‚´ì—­ -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">ğŸ“‹ ìµœê·¼ ì‹ ì²­ ë‚´ì—­</h5>
        <a href="#" onclick="navigateToMyRequests(); return false;">ì „ì²´ ë³´ê¸° â†’</a>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover" style="table-layout: auto;">
            <thead>
              <tr>
                <th>ì‹ ì²­ë²ˆí˜¸</th>
                <th>í’ˆëª…</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>ìƒíƒœ</th>
                <th>ì‹ ì²­ì¼</th>
                <th>ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="recentRequestsBody">
              <tr>
                <td colspan="6" class="text-center text-muted">ë¡œë”© ì¤‘...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ì¤‘ìš” ì•Œë¦¼ -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">ğŸ”” ì¤‘ìš” ì•Œë¦¼</h5>
      </div>
      <div class="card-body">
        <div id="notificationsList">
          <p class="text-muted">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <?!= include('JavaScript'); ?>
  <script>
    // ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬ - ë¹ˆ í˜ì´ì§€ ë°©ì§€
    window.addEventListener('error', function(e) {
      console.error('Global error caught:', e.error || e.message);
      const errorDiv = document.createElement('div');
      errorDiv.className = 'alert alert-danger m-4';
      errorDiv.style.position = 'fixed';
      errorDiv.style.top = '20px';
      errorDiv.style.left = '50%';
      errorDiv.style.transform = 'translateX(-50%)';
      errorDiv.style.zIndex = '9999';
      errorDiv.style.maxWidth = '600px';
      errorDiv.innerHTML = `
        <h5>âš ï¸ í˜ì´ì§€ ë¡œë”© ì˜¤ë¥˜</h5>
        <p><strong>ì˜¤ë¥˜:</strong> ${e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>
        <button class="btn btn-primary btn-sm" onclick="window.location.reload()">ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn btn-secondary btn-sm" onclick="window.location.href='?page=login'">ë¡œê·¸ì¸</button>
      `;
      document.body.appendChild(errorDiv);
    });

    // ì „ì—­ ë³€ìˆ˜: ì›¹ ì•± URL ìºì‹±
    let cachedWebAppUrl = null;

    // ì„¸ì…˜ í† í° ê°€ì ¸ì˜¤ê¸°
    function getSessionToken() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('token') || sessionStorage.getItem('sessionToken');
    }

    // ì›¹ ì•± URL ê°€ì ¸ì˜¤ê¸° (ì„œë²„ì—ì„œ)
    async function getWebAppUrl() {
      if (cachedWebAppUrl) {
        return cachedWebAppUrl;
      }
      
      try {
        const url = await callServer('getWebAppUrl');
        cachedWebAppUrl = url;
        console.log('Web App URL from server:', url);
        return url;
      } catch (error) {
        console.error('Failed to get web app URL:', error);
        return null;
      }
    }

    // í˜ì´ì§€ ì´ˆê¸°í™”
    window.onload = async function() {
      try {
        const startTime = performance.now();
        console.log('âœ… UserDashboard: Initializing...');
        
        const sessionToken = getSessionToken();
        if (!sessionToken) {
          window.location.href = '?page=login';
          return;
        }

        showLoading('ëŒ€ì‹œë³´ë“œ ë¡œë”© ì¤‘...');

        // âœ… ì‚¬ìš©ì ì •ë³´ ìºì‹œ í™•ì¸
        let user = sessionStorage.getItem('currentUser');
        if (user) {
          user = JSON.parse(user);
          console.log('âœ… Using cached user info');
        } else {
          user = await callServer('getCurrentUser', sessionToken);
          if (user) {
            sessionStorage.setItem('currentUser', JSON.stringify(user));
          }
        }
        
        if (!user) {
          hideLoading();
          window.location.href = '?page=login';
          return;
        }

        displayUserInfo(user);

        // âœ… ë°°ì¹˜ API ì‚¬ìš© (1íšŒ í˜¸ì¶œë¡œ ëª¨ë“  ë°ì´í„° ì¡°íšŒ)
        console.log('â±ï¸ Loading dashboard data via batch API...');
        const dashboardData = await callServer('getDashboardData', sessionToken);
        
        if (dashboardData && dashboardData.success) {
          // í†µê³„ í‘œì‹œ
          if (dashboardData.stats && typeof dashboardData.stats === 'object') {
            displayStats(dashboardData.stats);
          } else {
            console.error('Invalid stats response:', dashboardData.stats);
            displayStats({ requested: 0, inProgress: 0, completed: 0, total: 0 });
          }
          
          // ìµœê·¼ ì‹ ì²­ ë‚´ì—­ í‘œì‹œ
          if (Array.isArray(dashboardData.recentRequests)) {
            displayRecentRequests(dashboardData.recentRequests);
          } else {
            console.error('Invalid recentRequests response:', dashboardData.recentRequests);
            displayRecentRequests([]);
          }
          
          // ì•Œë¦¼ í‘œì‹œ
          if (Array.isArray(dashboardData.notifications)) {
            displayNotifications(dashboardData.notifications);
          } else {
            console.error('Invalid notifications response:', dashboardData.notifications);
            displayNotifications([]);
          }
        } else {
          console.error('Dashboard data load failed:', dashboardData);
          displayStats({ requested: 0, inProgress: 0, completed: 0, total: 0 });
          displayRecentRequests([]);
          displayNotifications([]);
        }

        hideLoading();
        
        const loadTime = (performance.now() - startTime).toFixed(0);
        console.log(`âœ… UserDashboard loaded in ${loadTime}ms`);
      } catch (error) {
        console.error('UserDashboard init error:', error);
        console.error('Error stack:', error.stack);
        hideLoading();
        showToast('ëŒ€ì‹œë³´ë“œ ë¡œë”© ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'danger');
      }
    };

    // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
    function displayUserInfo(user) {
      document.getElementById('userName').textContent = user.name;
      document.getElementById('userTeam').textContent = user.team;
    }

    // í†µê³„ í‘œì‹œ
    function displayStats(stats) {
      document.getElementById('countRequested').textContent = stats.requested || 0;
      document.getElementById('countInProgress').textContent = stats.inProgress || 0;
      document.getElementById('countCompleted').textContent = stats.completed || 0;
      document.getElementById('countTotal').textContent = stats.total || 0;
    }

    // ìµœê·¼ ì‹ ì²­ ë‚´ì—­ í‘œì‹œ
    function displayRecentRequests(requests) {
      const tbody = document.getElementById('recentRequestsBody');
      tbody.innerHTML = '';

      if (!requests || requests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      requests.forEach(req => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${escapeHtml(req.requestNo)}</strong></td>
          <td>${escapeHtml(req.itemName)}</td>
          <td>${req.quantity}</td>
          <td><span class="badge bg-${getStatusColor(req.status)}">${escapeHtml(req.status)}</span></td>
          <td>${escapeHtml(req.requestDate)}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="viewDetail('${req.requestNo}')">
              ìƒì„¸
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ì•Œë¦¼ í‘œì‹œ
    function displayNotifications(notifications) {
      const container = document.getElementById('notificationsList');
      container.innerHTML = '';

      if (!notifications || notifications.length === 0) {
        container.innerHTML = '<p class="text-muted">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        document.getElementById('notificationCount').textContent = '0';
        return;
      }

      notifications.forEach(notif => {
        const div = document.createElement('div');
        div.className = 'alert alert-info alert-dismissible fade show mb-2';
        div.innerHTML = `
          ${escapeHtml(notif.message)}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        container.appendChild(div);
      });

      document.getElementById('notificationCount').textContent = notifications.length;
    }

    // ìƒíƒœë³„ ìƒ‰ìƒ
    function getStatusColor(status) {
      const colors = {
        'ì ‘ìˆ˜ì¤‘': 'warning',
        'ë°œì£¼ì§„í–‰': 'primary',
        'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)': 'success',
        'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)': 'info',
        'ì²˜ë¦¬ì™„ë£Œ': 'success',
        'ì ‘ìˆ˜ì·¨ì†Œ': 'secondary'
      };
      return colors[status] || 'secondary';
    }

    // ìš”ì•½ í†µê³„ ì¡°íšŒ
    async function getRequestStats(sessionToken) {
      try {
        const requests = await callServer('getMyRequests', {}, sessionToken);
        
        const stats = {
          requested: 0,
          inProgress: 0,
          completed: 0,
          total: requests.length
        };

        requests.forEach(req => {
          if (req.status === 'ì ‘ìˆ˜ì¤‘') {
            stats.requested++;
          } else if (['ë°œì£¼ì§„í–‰', 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)', 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)'].includes(req.status)) {
            stats.inProgress++;
          } else if (req.status === 'ì²˜ë¦¬ì™„ë£Œ') {
            stats.completed++;
          }
        });

        return stats;
      } catch (error) {
        console.error('getRequestStats error:', error);
        return { requested: 0, inProgress: 0, completed: 0, total: 0 };
      }
    }

    // ì•Œë¦¼ ì¡°íšŒ
    async function getNotifications(sessionToken) {
      try {
        const requests = await callServer('getMyRequests', {}, sessionToken);
        const notifications = [];

        requests.forEach(req => {
          if (req.status === 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°í™•ì¸)' || req.status === 'ë°œì£¼ì™„ë£Œ(ë‚©ê¸°ë¯¸ì •)') {
            notifications.push({
              type: 'success',
              message: `[ì‹ ì²­ë²ˆí˜¸ ${req.requestNo}] ë°œì£¼ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë ¹ í™•ì¸ì„ ë¶€íƒë“œë¦½ë‹ˆë‹¤.`,
              requestNo: req.requestNo
            });
          }
          // ë°œì£¼ì§€ì—° ìƒíƒœëŠ” ì œê±°ë¨
          if (false) {
            notifications.push({
              type: 'warning',
              message: `[ì‹ ì²­ë²ˆí˜¸ ${req.requestNo}] ë°œì£¼ê°€ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤.`,
              requestNo: req.requestNo
            });
          }
        });

        return notifications.slice(0, 5);
      } catch (error) {
        console.error('getNotifications error:', error);
        return [];
      }
    }

    // í™”ë©´ ì „í™˜
    async function navigateToNewRequest() {
      try {
        console.log('navigateToNewRequest: Starting...');
        const sessionToken = getSessionToken();
        console.log('Session token for navigation:', sessionToken ? 'Present' : 'Missing');
        
        if (!sessionToken) {
          console.error('No session token, redirecting to login');
          window.location.href = '?page=login';
          return;
        }
        
        // ì„œë²„ì—ì„œ ì‹¤ì œ ì›¹ ì•± URL ê°€ì ¸ì˜¤ê¸°
        const baseUrl = await getWebAppUrl();
        
        if (!baseUrl) {
          console.error('Failed to get web app URL');
          showToast('í˜ì´ì§€ ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
          return;
        }
        
        const targetUrl = baseUrl + '?page=new-request&token=' + encodeURIComponent(sessionToken);
        console.log('Base URL from server:', baseUrl);
        console.log('Full target URL:', targetUrl);
        
        // iframe ë‚´ë¶€ì—ì„œ ì‹¤í–‰ ì¤‘ì´ë©´ ìµœìƒìœ„ ì°½ì„ ë¦¬ë‹¤ì´ë ‰íŠ¸
        if (window.top && window.top !== window) {
          console.log('Inside iframe, redirecting parent window');
          window.top.location.href = targetUrl;
        } else {
          console.log('Not in iframe, direct redirect');
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('navigateToNewRequest error:', error);
        showToast('í˜ì´ì§€ ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
      }
    }

    async function navigateToMyRequests() {
      try {
        const sessionToken = getSessionToken();
        const baseUrl = await getWebAppUrl();
        if (!baseUrl) return;
        
        const targetUrl = baseUrl + '?page=my-requests&token=' + encodeURIComponent(sessionToken);
        
        if (window.top && window.top !== window) {
          window.top.location.href = targetUrl;
        } else {
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('navigateToMyRequests error:', error);
      }
    }

    async function navigateToMyInfo() {
      try {
        const sessionToken = getSessionToken();
        const baseUrl = await getWebAppUrl();
        if (!baseUrl) return;
        
        const targetUrl = baseUrl + '?page=my-info&token=' + encodeURIComponent(sessionToken);
        
        if (window.top && window.top !== window) {
          window.top.location.href = targetUrl;
        } else {
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('navigateToMyInfo error:', error);
      }
    }

    async function viewDetail(requestNo) {
      try {
        console.log('viewDetail called with requestNo:', requestNo);
        const sessionToken = getSessionToken();
        console.log('Session token:', sessionToken ? 'Present' : 'Missing');
        
        // âœ… sessionStorageì— íŒŒë¼ë¯¸í„° ì €ì¥ (OAuth ë¦¬ë‹¤ì´ë ‰ì…˜ ëŒ€ë¹„)
        sessionStorage.setItem('pendingRequestNo', requestNo);
        sessionStorage.setItem('pendingPage', 'detail');
        console.log('Saved to sessionStorage:', { requestNo, page: 'detail' });
        
        const baseUrl = await getWebAppUrl();
        console.log('Base URL:', baseUrl);
        
        if (!baseUrl) {
          showToast('í˜ì´ì§€ ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
          return;
        }
        
        const targetUrl = baseUrl + '?page=detail&requestNo=' + encodeURIComponent(requestNo) + '&token=' + encodeURIComponent(sessionToken);
        console.log('Target URL:', targetUrl);
        console.log('Navigating to detail page...');
        
        if (window.top && window.top !== window) {
          window.top.location.href = targetUrl;
        } else {
          window.location.href = targetUrl;
        }
      } catch (error) {
        console.error('viewDetail error:', error);
        showToast('í˜ì´ì§€ ì´ë™ ì‹¤íŒ¨: ' + error.message, 'danger');
      }
    }

    function showNotifications() {
      // ì•Œë¦¼ ëª¨ë‹¬ í‘œì‹œ (ì¶”í›„ êµ¬í˜„)
      alert('ì•Œë¦¼ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
    }

    function logout() {
      if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        try {
          const sessionToken = getSessionToken();
          // ì„œë²„ ë¡œê·¸ì•„ì›ƒ í˜¸ì¶œ (ì‹¤íŒ¨í•´ë„ í´ë¼ì´ì–¸íŠ¸ ì •ë¦¬ ì§„í–‰)
          callServer('logout', sessionToken).then(() => {
            console.log('Logout successful');
          }).catch(error => {
            console.error('Logout server error:', error);
          }).finally(() => {
            // í´ë¼ì´ì–¸íŠ¸ ì„¸ì…˜ ì •ë¦¬
            sessionStorage.removeItem('sessionToken');
            sessionStorage.removeItem('currentUser');
            sessionStorage.removeItem('pendingRequestNo');
            sessionStorage.removeItem('pendingPage');
            sessionStorage.removeItem('adminStatusFilter');
            
            // iframe í™˜ê²½ ê³ ë ¤í•œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            const loginUrl = '?page=login';
            if (window.top && window.top !== window) {
              // iframe ë‚´ë¶€ì¸ ê²½ìš°
              window.top.location.href = loginUrl;
            } else {
              // ì¼ë°˜ í˜ì´ì§€ì¸ ê²½ìš°
              window.location.href = loginUrl;
            }
          });
        } catch (error) {
          console.error('Logout error:', error);
          // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ í´ë¼ì´ì–¸íŠ¸ ì •ë¦¬ ë° ë¦¬ë‹¤ì´ë ‰íŠ¸
          sessionStorage.removeItem('sessionToken');
          sessionStorage.removeItem('currentUser');
          sessionStorage.removeItem('pendingRequestNo');
          sessionStorage.removeItem('pendingPage');
          sessionStorage.removeItem('adminStatusFilter');
          
          const loginUrl = '?page=login';
          if (window.top && window.top !== window) {
            window.top.location.href = loginUrl;
          } else {
            window.location.href = loginUrl;
          }
        }
      }
    }

    // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ í™•ì¸
    console.log('âœ“ UserDashboard script loaded');
  </script>
</body>
</html>

