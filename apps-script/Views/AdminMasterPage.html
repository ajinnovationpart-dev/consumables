<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê¸°ì¤€ì •ë³´ ê´€ë¦¬</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* ê´€ë¦¬ì í˜ì´ì§€ëŠ” PC ì „ìš© ìŠ¤íƒ€ì¼ ì ìš© */
    body {
      font-size: 14px !important;
    }
    
    .container-fluid {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ ì œê±° */
    @media (max-width: 768px) {
      body {
        font-size: 14px !important;
      }
      
      input, .form-control, .form-select, textarea {
        font-size: 14px !important;
        min-height: auto !important;
        padding: 0.375rem 0.75rem !important;
      }
      
      button, .btn {
        font-size: 14px !important;
        min-height: auto !important;
        padding: 0.375rem 0.75rem !important;
      }
    }
  </style>
</head>
<body>
  <!-- í—¤ë”: ê´€ë¦¬ì ê³µí†µ ë„¤ë¹„ -->
  <nav class="navbar navbar-dark bg-primary mb-3">
    <div class="container-fluid px-2">
      <span class="navbar-brand mb-0">ğŸ  ë¶€í’ˆë°œì£¼ì‹œìŠ¤í…œ</span>
      <div class="d-flex align-items-center flex-wrap gap-1">
        <a href="#" class="text-white text-decoration-none small me-2" onclick="navigateTo('admin-dashboard'); return false;">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</a>
        <span class="text-white opacity-75 d-none d-md-inline">|</span>
        <a href="#" class="text-white text-decoration-none small me-2" onclick="navigateTo('admin-requests'); return false;">ì „ì²´ ì‹ ì²­</a>
        <span class="text-white opacity-75 d-none d-md-inline">|</span>
        <a href="#" class="text-white text-decoration-none small me-2" onclick="navigateTo('admin-statistics'); return false;">í†µê³„ ë° ë¦¬í¬íŠ¸</a>
        <span class="text-white opacity-75 d-none d-md-inline">|</span>
        <a href="#" class="text-white text-decoration-none small me-2 fw-bold" onclick="return false;">âš™ï¸ ê¸°ì¤€ì •ë³´ ë“±ë¡/ê´€ë¦¬</a>
        <span class="text-white d-none d-md-inline me-2 small">ğŸ‘¤ <span id="headerUserName"></span></span>
        <button class="btn btn-sm btn-outline-light" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid px-2 mt-2">
    <h2 class="h4 mb-3">ğŸ“‹ ê¸°ì¤€ì •ë³´ ê´€ë¦¬</h2>
    
    <!-- íƒ­ ë©”ë‰´ -->
    <ul class="nav nav-tabs mb-4" id="masterTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
          ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="delivery-tab" data-bs-toggle="tab" data-bs-target="#delivery" type="button" role="tab">
          ğŸšš ë°°ì†¡ì§€ ê´€ë¦¬
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="excel-tab" data-bs-toggle="tab" data-bs-target="#excel" type="button" role="tab">
          ğŸ“¥ Excel ë§ˆìŠ¤í„° íŒŒì¼
        </button>
      </li>
    </ul>

    <!-- íƒ­ ì½˜í…ì¸  -->
    <div class="tab-content" id="masterTabContent">
      <!-- ì‚¬ìš©ì ê´€ë¦¬ íƒ­ -->
      <div class="tab-pane fade show active" id="users" role="tabpanel">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ì‚¬ìš©ì ëª©ë¡</h5>
            <button class="btn btn-primary btn-sm" onclick="showUserForm()">
              â• ì‚¬ìš©ì ë“±ë¡
            </button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>ì‚¬ìš©ìID</th>
                    <th>ì´ë¦„</th>
                    <th>ê¸°ì‚¬ì½”ë“œ</th>
                    <th>ì†Œì†íŒ€</th>
                    <th>ì§€ì—­</th>
                    <th>ì—­í• </th>
                    <th>í™œì„±í™”</th>
                    <th>ì•¡ì…˜</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody">
                  <tr>
                    <td colspan="8" class="text-center">ë¡œë”© ì¤‘...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ë°°ì†¡ì§€ ê´€ë¦¬ íƒ­ -->
      <div class="tab-pane fade" id="delivery" role="tabpanel">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ë°°ì†¡ì§€ ëª©ë¡</h5>
            <button class="btn btn-primary btn-sm" onclick="showDeliveryForm()">
              â• ë°°ì†¡ì§€ ë“±ë¡
            </button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>ë°°ì†¡ì§€ëª…</th>
                    <th>ì†Œì†íŒ€</th>
                    <th>ì£¼ì†Œ</th>
                    <th>ì—°ë½ì²˜</th>
                    <th>ë‹´ë‹¹ì</th>
                    <th>í™œì„±í™”</th>
                    <th>ì•¡ì…˜</th>
                  </tr>
                </thead>
                <tbody id="deliveryTableBody">
                  <tr>
                    <td colspan="7" class="text-center">ë¡œë”© ì¤‘...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Excel ë§ˆìŠ¤í„° íŒŒì¼ íƒ­ -->
      <div class="tab-pane fade" id="excel" role="tabpanel">
        <div class="row">
          <!-- CSV ë°°ì†¡ì§€ ì—…ë¡œë“œ -->
          <div class="col-md-6 mb-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">ğŸ“¤ CSV ë°°ì†¡ì§€ ì—…ë¡œë“œ</h5>
              </div>
              <div class="card-body">
                <p class="text-muted">
                  CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë°°ì†¡ì§€ ì •ë³´ë¥¼ ì¼ê´„ ë“±ë¡í•©ë‹ˆë‹¤.<br>
                  íŒŒì¼ í˜•ì‹: ë°°ì†¡ì§€ëª…,ì†Œì†íŒ€,ì£¼ì†Œ,ì—°ë½ì²˜,ë‹´ë‹¹ì,í™œì„±í™”,ë¹„ê³ 
                </p>
                <div class="mb-3">
                  <label class="form-label">CSV íŒŒì¼ ì„ íƒ</label>
                  <input type="file" class="form-control" id="csvFileInput" accept=".csv" onchange="handleCSVFileSelect(event)">
                  <div class="form-text">í…œí”Œë¦¿: templates/ë°°ì†¡ì§€ê´€ë¦¬.csv ì°¸ê³ </div>
                </div>
                <button class="btn btn-primary" onclick="uploadCSVFile()" id="uploadCSVBtn" disabled>
                  ğŸ“¥ CSV íŒŒì¼ ì—…ë¡œë“œ
                </button>
                <div id="csvUploadResult" class="mt-3"></div>
              </div>
            </div>
          </div>
          
          <!-- Excel ë§ˆìŠ¤í„° íŒŒì¼ ìƒì„± -->
          <div class="col-md-6 mb-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">ğŸ“¥ Excel ë§ˆìŠ¤í„° íŒŒì¼ ìƒì„±</h5>
              </div>
              <div class="card-body">
                <p class="text-muted">
                  ì „ì²´ ë°ì´í„°ë¥¼ í¬í•¨í•œ Excel ë§ˆìŠ¤í„° íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.<br>
                  ê¸°ì¡´ íŒŒì¼ì€ ê°™ì€ ë‚ ì§œì˜ íŒŒì¼ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤.
                </p>
                <button class="btn btn-success" onclick="generateMasterExcel()">
                  ğŸ“¥ Excel ë§ˆìŠ¤í„° íŒŒì¼ ìƒì„±
                </button>
                <div id="excelResult" class="mt-3"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì‚¬ìš©ì ë“±ë¡ ëª¨ë‹¬ -->
  <div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="userModalTitle">ì‚¬ìš©ì ë“±ë¡</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="userForm">
            <div class="mb-3">
              <label class="form-label">ì‚¬ìš©ìID <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="userId" required>
            </div>
            <div class="mb-3">
              <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
              <input type="password" class="form-control" id="userPassword" placeholder="ê¸°ë³¸: 1234">
              <div class="form-text">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸(1234)ê°€ ì„¤ì •ë©ë‹ˆë‹¤.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">ì´ë¦„ <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="userName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">ê¸°ì‚¬ì½”ë“œ</label>
              <input type="text" class="form-control" id="userEmployeeCode">
            </div>
            <div class="mb-3">
              <label class="form-label">ì†Œì†íŒ€</label>
              <input type="text" class="form-control" id="userTeam">
            </div>
            <div class="mb-3">
              <label class="form-label">ì§€ì—­</label>
              <input type="text" class="form-control" id="userRegion">
            </div>
            <div class="mb-3">
              <label class="form-label">ì—­í• </label>
              <select class="form-select" id="userRole">
                <option value="ì‹ ì²­ì">ì‹ ì²­ì</option>
                <option value="ê´€ë¦¬ì">ê´€ë¦¬ì</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">í™œì„±í™”</label>
              <select class="form-select" id="userActive">
                <option value="Y">í™œì„±í™”</option>
                <option value="N">ë¹„í™œì„±í™”</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" onclick="submitUser()" id="userSubmitBtn">ë“±ë¡</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ë°°ì†¡ì§€ ë“±ë¡ ëª¨ë‹¬ -->
  <div class="modal fade" id="deliveryModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deliveryModalTitle">ë°°ì†¡ì§€ ë“±ë¡</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="deliveryForm">
            <div class="mb-3">
              <label class="form-label">ë°°ì†¡ì§€ëª… <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="deliveryName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">ì†Œì†íŒ€ <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="deliveryTeam" required>
            </div>
            <div class="mb-3">
              <label class="form-label">ì£¼ì†Œ</label>
              <input type="text" class="form-control" id="deliveryAddress">
            </div>
            <div class="mb-3">
              <label class="form-label">ì—°ë½ì²˜</label>
              <input type="text" class="form-control" id="deliveryContact">
            </div>
            <div class="mb-3">
              <label class="form-label">ë‹´ë‹¹ì</label>
              <input type="text" class="form-control" id="deliveryManager">
            </div>
            <div class="mb-3">
              <label class="form-label">í™œì„±í™”</label>
              <select class="form-select" id="deliveryActive">
                <option value="Y">í™œì„±í™”</option>
                <option value="N">ë¹„í™œì„±í™”</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">ë¹„ê³ </label>
              <textarea class="form-control" id="deliveryRemarks" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-primary" onclick="submitDelivery()" id="deliverySubmitBtn">ë“±ë¡</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <?!= include('JavaScript'); ?>
  <script>
    // ì„¸ì…˜ í† í° ê°€ì ¸ì˜¤ê¸°
    function getSessionToken() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('token') || sessionStorage.getItem('sessionToken');
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.onload = async function() {
      try {
        const sessionToken = getSessionToken();
        if (!sessionToken) {
          window.location.href = '?page=login';
          return;
        }

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        const user = await callServer('getCurrentUser', sessionToken);
        if (!user || user.role !== 'ê´€ë¦¬ì') {
          showToast('ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'danger');
          window.location.href = '?page=admin-dashboard&token=' + sessionToken;
          return;
        }

        document.getElementById('headerUserName').textContent = user.name;

        // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
        await loadUsers();
        // ë°°ì†¡ì§€ ëª©ë¡ ë¡œë“œ
        await loadDeliveryPlaces();
      } catch (error) {
        console.error('Initialization error:', error);
        handleError(error);
      }
    };

    // ìºì‹œ (ìˆ˜ì • ì‹œ ì‚¬ìš©)
    let usersCache = [];
    let deliveryPlacesCache = [];
    let userEditMode = { mode: 'create', userId: null };
    let deliveryEditMode = { mode: 'create', originalName: null, originalTeam: null };

    // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
    async function loadUsers() {
      try {
        const sessionToken = getSessionToken();
        const users = await callServer('getAllUsers', sessionToken);
        usersCache = Array.isArray(users) ? users : [];
        renderUsersTable(users);
      } catch (error) {
        handleError(error);
      }
    }

    // ì‚¬ìš©ì í…Œì´ë¸” ë Œë”ë§
    function renderUsersTable(users) {
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '';

      if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      users.forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(user.userId)}</td>
          <td>${escapeHtml(user.name)}</td>
          <td>${escapeHtml(user.employeeCode || '-')}</td>
          <td>${escapeHtml(user.team || '-')}</td>
          <td>${escapeHtml(user.region || '-')}</td>
          <td>${escapeHtml(user.role)}</td>
          <td>${user.active === 'Y' ? '<span class="badge bg-success">í™œì„±</span>' : '<span class="badge bg-secondary">ë¹„í™œì„±</span>'}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick="editUser('${escapeHtml(user.userId)}')">ìˆ˜ì •</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ë°°ì†¡ì§€ ëª©ë¡ ë¡œë“œ
    async function loadDeliveryPlaces() {
      try {
        const sessionToken = getSessionToken();
        const places = await callServer('getAllDeliveryPlaces', sessionToken);
        deliveryPlacesCache = Array.isArray(places) ? places : [];
        
        // ë°°ì—´ì¸ì§€ í™•ì¸
        if (!Array.isArray(places)) {
          console.error('getAllDeliveryPlaces returned non-array:', places);
          renderDeliveryTable([]);
          return;
        }
        
        renderDeliveryTable(places);
      } catch (error) {
        console.error('loadDeliveryPlaces error:', error);
        handleError(error);
        renderDeliveryTable([]);
      }
    }

    // ë°°ì†¡ì§€ í…Œì´ë¸” ë Œë”ë§
    function renderDeliveryTable(places) {
      const tbody = document.getElementById('deliveryTableBody');
      tbody.innerHTML = '';

      console.log('renderDeliveryTable - places:', places, 'isArray:', Array.isArray(places));

      // ë°°ì—´ì´ ì•„ë‹Œ ê²½ìš° ì²˜ë¦¬
      if (!Array.isArray(places)) {
        console.error('renderDeliveryTable: places is not an array:', places);
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      // ë¹ˆ ë°°ì—´ì¸ ê²½ìš°
      if (places.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">ë“±ë¡ëœ ë°°ì†¡ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      if (places.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">ë“±ë¡ëœ ë°°ì†¡ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      places.forEach(place => {
        const key = encodeURIComponent((place['ì†Œì†íŒ€'] || '') + '|' + (place['ë°°ì†¡ì§€ëª…'] || ''));
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(place['ë°°ì†¡ì§€ëª…'] || '-')}</td>
          <td>${escapeHtml(place['ì†Œì†íŒ€'] || '-')}</td>
          <td>${escapeHtml(place['ì£¼ì†Œ'] || '-')}</td>
          <td>${escapeHtml(place['ì—°ë½ì²˜'] || '-')}</td>
          <td>${escapeHtml(place['ë‹´ë‹¹ì'] || '-')}</td>
          <td>${place['í™œì„±í™”'] === 'Y' ? '<span class="badge bg-success">í™œì„±</span>' : '<span class="badge bg-secondary">ë¹„í™œì„±</span>'}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick="editDelivery('${key}')">ìˆ˜ì •</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ì‚¬ìš©ì ë“±ë¡ í¼ í‘œì‹œ
    function showUserForm() {
      document.getElementById('userForm').reset();
      userEditMode = { mode: 'create', userId: null };
      document.getElementById('userModalTitle').textContent = 'ì‚¬ìš©ì ë“±ë¡';
      document.getElementById('userSubmitBtn').textContent = 'ë“±ë¡';
      document.getElementById('userId').disabled = false;
      document.getElementById('userPassword').value = '';
      document.getElementById('userPassword').placeholder = 'ê¸°ë³¸: 1234';
      const modal = new bootstrap.Modal(document.getElementById('userModal'));
      modal.show();
    }

    // ì‚¬ìš©ì ë“±ë¡
    async function submitUser() {
      try {
        const sessionToken = getSessionToken();
        const userData = {
          userId: document.getElementById('userId').value,
          password: document.getElementById('userPassword').value,
          name: document.getElementById('userName').value,
          employeeCode: document.getElementById('userEmployeeCode').value,
          team: document.getElementById('userTeam').value,
          region: document.getElementById('userRegion').value,
          role: document.getElementById('userRole').value,
          active: document.getElementById('userActive').value
        };

        const isEdit = userEditMode.mode === 'edit';
        showLoading(isEdit ? 'ì‚¬ìš©ì ìˆ˜ì • ì¤‘...' : 'ì‚¬ìš©ì ë“±ë¡ ì¤‘...');
        const result = isEdit
          ? await callServer('updateUser', userData, sessionToken)
          : await callServer('createUser', userData, sessionToken);
        hideLoading();

        if (result.success) {
          showToast(result.message, 'success');
          bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
          await loadUsers();
        } else {
          showToast(result.message || 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
        }
      } catch (error) {
        hideLoading();
        handleError(error);
      }
    }

    // ë°°ì†¡ì§€ ë“±ë¡ í¼ í‘œì‹œ
    function showDeliveryForm() {
      document.getElementById('deliveryForm').reset();
      deliveryEditMode = { mode: 'create', originalName: null, originalTeam: null };
      document.getElementById('deliveryModalTitle').textContent = 'ë°°ì†¡ì§€ ë“±ë¡';
      document.getElementById('deliverySubmitBtn').textContent = 'ë“±ë¡';
      const modal = new bootstrap.Modal(document.getElementById('deliveryModal'));
      modal.show();
    }

    // ë°°ì†¡ì§€ ë“±ë¡
    async function submitDelivery() {
      try {
        const sessionToken = getSessionToken();
        const placeData = {
          name: document.getElementById('deliveryName').value,
          team: document.getElementById('deliveryTeam').value,
          address: document.getElementById('deliveryAddress').value,
          contact: document.getElementById('deliveryContact').value,
          manager: document.getElementById('deliveryManager').value,
          active: document.getElementById('deliveryActive').value,
          remarks: document.getElementById('deliveryRemarks').value
        };

        const isEdit = deliveryEditMode.mode === 'edit';
        if (isEdit) {
          placeData.originalName = deliveryEditMode.originalName;
          placeData.originalTeam = deliveryEditMode.originalTeam;
        }

        showLoading(isEdit ? 'ë°°ì†¡ì§€ ìˆ˜ì • ì¤‘...' : 'ë°°ì†¡ì§€ ë“±ë¡ ì¤‘...');
        const result = isEdit
          ? await callServer('updateDeliveryPlace', placeData, sessionToken)
          : await callServer('createDeliveryPlace', placeData, sessionToken);
        hideLoading();

        if (result.success) {
          showToast(result.message, 'success');
          bootstrap.Modal.getInstance(document.getElementById('deliveryModal')).hide();
          await loadDeliveryPlaces();
        } else {
          showToast(result.message || 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
        }
      } catch (error) {
        hideLoading();
        handleError(error);
      }
    }

    // CSV íŒŒì¼ ì„ íƒ ì²˜ë¦¬
    let selectedCSVFile = null;
    
    function handleCSVFileSelect(event) {
      const file = event.target.files[0];
      if (!file) {
        selectedCSVFile = null;
        document.getElementById('uploadCSVBtn').disabled = true;
        return;
      }
      
      if (!file.name.endsWith('.csv')) {
        showToast('CSV íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'warning');
        event.target.value = '';
        selectedCSVFile = null;
        document.getElementById('uploadCSVBtn').disabled = true;
        return;
      }
      
      selectedCSVFile = file;
      document.getElementById('uploadCSVBtn').disabled = false;
      showToast('íŒŒì¼ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤: ' + file.name, 'success');
    }

    // CSV íŒŒì¼ ì—…ë¡œë“œ
    async function uploadCSVFile() {
      if (!selectedCSVFile) {
        showToast('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }
      
      try {
        const sessionToken = getSessionToken();
        
        if (!confirm('CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë°°ì†¡ì§€ ì •ë³´ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê¸°ì¡´ ë°ì´í„°ì™€ ì¤‘ë³µë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) return;
        
        showLoading('CSV íŒŒì¼ì„ ì½ëŠ” ì¤‘...');
        
        // íŒŒì¼ì„ í…ìŠ¤íŠ¸ë¡œ ì½ê¸°
        const reader = new FileReader();
        reader.onload = async function(e) {
          try {
            const csvContent = e.target.result;
            
            // ì„œë²„ë¡œ ì „ì†¡
            const result = await callServer('importDeliveryPlacesFromCSV', csvContent, sessionToken);
            hideLoading();
            
            const resultDiv = document.getElementById('csvUploadResult');
            if (result.success) {
              resultDiv.innerHTML = `
                <div class="alert alert-success">
              <strong>ì—…ë¡œë“œ ì™„ë£Œ!</strong><br>
              ${result.message}<br>
              <ul class="mt-2 mb-0">
                ${result.imported.users !== undefined ? `<li>ë“±ë¡ëœ ì‚¬ìš©ì: ${result.imported.users}ëª…</li>` : ''}
                <li>ë“±ë¡ëœ ë°°ì†¡ì§€: ${result.imported.deliveryPlaces}ê°œ</li>
                ${result.imported.skippedUsers > 0 ? `<li>ì¤‘ë³µ ì‚¬ìš©ì: ${result.imported.skippedUsers}ëª…</li>` : ''}
                ${result.imported.skippedPlaces > 0 ? `<li>ì¤‘ë³µ ë°°ì†¡ì§€: ${result.imported.skippedPlaces}ê°œ</li>` : ''}
              </ul>
                </div>
              `;
              showToast('CSV íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
              
              // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
              document.getElementById('csvFileInput').value = '';
              selectedCSVFile = null;
              document.getElementById('uploadCSVBtn').disabled = true;
              
              // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
              setTimeout(() => {
                loadUsers();
                loadDeliveryPlaces();
              }, 1000);
            } else {
              resultDiv.innerHTML = `
                <div class="alert alert-danger">
                  <strong>ì—…ë¡œë“œ ì‹¤íŒ¨</strong><br>
                  ${escapeHtml(result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')}
                  ${result.technical ? `<div class="mt-2 small text-muted">(${escapeHtml(result.technical)})</div>` : ''}
                </div>
              `;
              showToast(result.message || 'ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
          } catch (error) {
            hideLoading();
            handleError(error);
          }
        };
        
        reader.onerror = function() {
          hideLoading();
          showToast('íŒŒì¼ ì½ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
        };
        
        reader.readAsText(selectedCSVFile, 'UTF-8');
        
      } catch (error) {
        hideLoading();
        handleError(error);
      }
    }

    // Excel ë§ˆìŠ¤í„° íŒŒì¼ ìƒì„±
    async function generateMasterExcel() {
      try {
        if (!confirm('Excel ë§ˆìŠ¤í„° íŒŒì¼ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const sessionToken = getSessionToken();
        showLoading('Excel íŒŒì¼ ìƒì„± ì¤‘...');
        const result = await callServer('exportMasterExcel', sessionToken);
        hideLoading();

        if (result.success) {
          const resultDiv = document.getElementById('excelResult');
          resultDiv.innerHTML = `
            <div class="alert alert-success">
              <strong>ìƒì„± ì™„ë£Œ!</strong><br>
              íŒŒì¼ëª…: ${escapeHtml(result.fileName)}<br>
              <a href="${result.fileUrl}" target="_blank" class="btn btn-sm btn-primary mt-2">íŒŒì¼ ì—´ê¸°</a>
            </div>
          `;
          showToast('Excel íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } else {
          showToast(result.message || 'íŒŒì¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
        }
      } catch (error) {
        hideLoading();
        handleError(error);
      }
    }

    // ì‚¬ìš©ì ìˆ˜ì •
    function editUser(userId) {
      const u = (usersCache || []).find(x => String(x.userId) === String(userId));
      if (!u) {
        showToast('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
      }

      userEditMode = { mode: 'edit', userId: u.userId };
      document.getElementById('userModalTitle').textContent = 'ì‚¬ìš©ì ìˆ˜ì •';
      document.getElementById('userSubmitBtn').textContent = 'ì €ì¥';

      document.getElementById('userId').value = u.userId || '';
      document.getElementById('userId').disabled = true; // í‚¤ ë³€ê²½ ë°©ì§€
      document.getElementById('userPassword').value = '';
      document.getElementById('userPassword').placeholder = 'ë¹„ì›Œë‘ë©´ ë¹„ë°€ë²ˆí˜¸ ìœ ì§€';
      document.getElementById('userName').value = u.name || '';
      document.getElementById('userEmployeeCode').value = u.employeeCode || '';
      document.getElementById('userTeam').value = u.team || '';
      document.getElementById('userRegion').value = u.region || '';
      document.getElementById('userRole').value = u.role || 'ì‹ ì²­ì';
      document.getElementById('userActive').value = u.active || 'Y';

      const modal = new bootstrap.Modal(document.getElementById('userModal'));
      modal.show();
    }

    // ë°°ì†¡ì§€ ìˆ˜ì •
    function editDelivery(encodedKey) {
      const decoded = decodeURIComponent(encodedKey || '');
      const parts = decoded.split('|');
      const team = (parts[0] || '').trim();
      const name = (parts.slice(1).join('|') || '').trim();

      const p = (deliveryPlacesCache || []).find(x =>
        String(x['ì†Œì†íŒ€'] || '').trim() === team &&
        String(x['ë°°ì†¡ì§€ëª…'] || '').trim() === name
      );

      if (!p) {
        showToast('ë°°ì†¡ì§€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
      }

      deliveryEditMode = { mode: 'edit', originalName: name, originalTeam: team };
      document.getElementById('deliveryModalTitle').textContent = 'ë°°ì†¡ì§€ ìˆ˜ì •';
      document.getElementById('deliverySubmitBtn').textContent = 'ì €ì¥';

      document.getElementById('deliveryName').value = p['ë°°ì†¡ì§€ëª…'] || '';
      document.getElementById('deliveryTeam').value = p['ì†Œì†íŒ€'] || '';
      document.getElementById('deliveryAddress').value = p['ì£¼ì†Œ'] || '';
      document.getElementById('deliveryContact').value = p['ì—°ë½ì²˜'] || '';
      document.getElementById('deliveryManager').value = p['ë‹´ë‹¹ì'] || '';
      document.getElementById('deliveryActive').value = p['í™œì„±í™”'] || 'Y';
      document.getElementById('deliveryRemarks').value = p['ë¹„ê³ '] || '';

      const modal = new bootstrap.Modal(document.getElementById('deliveryModal'));
      modal.show();
    }

    function navigateTo(page) {
      const sessionToken = getSessionToken();
      window.location.href = '?page=' + page + (sessionToken ? '&token=' + encodeURIComponent(sessionToken) : '');
    }
    function goBack() {
      navigateTo('admin-dashboard');
    }

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
      if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        try {
          const sessionToken = getSessionToken();
          // ì„œë²„ ë¡œê·¸ì•„ì›ƒ í˜¸ì¶œ (ì‹¤íŒ¨í•´ë„ í´ë¼ì´ì–¸íŠ¸ ì •ë¦¬ ì§„í–‰)
          if (sessionToken) {
            callServer('logout', sessionToken).then(() => {
              console.log('Logout successful');
            }).catch(error => {
              console.error('Logout server error:', error);
            });
          }
          
          // í´ë¼ì´ì–¸íŠ¸ ì„¸ì…˜ ì •ë¦¬
          sessionStorage.removeItem('sessionToken');
          sessionStorage.removeItem('currentUser');
          sessionStorage.removeItem('pendingRequestNo');
          sessionStorage.removeItem('pendingPage');
          sessionStorage.removeItem('adminStatusFilter');
          
          // iframe í™˜ê²½ ê³ ë ¤í•œ ë¦¬ë‹¤ì´ë ‰íŠ¸
          const loginUrl = '?page=login';
          if (window.top && window.top !== window) {
            // iframe ë‚´ë¶€ì¸ ê²½ìš°
            window.top.location.href = loginUrl;
          } else {
            // ì¼ë°˜ í˜ì´ì§€ì¸ ê²½ìš°
            window.location.href = loginUrl;
          }
        } catch (error) {
          console.error('Logout error:', error);
          // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ í´ë¼ì´ì–¸íŠ¸ ì •ë¦¬ ë° ë¦¬ë‹¤ì´ë ‰íŠ¸
          sessionStorage.removeItem('sessionToken');
          sessionStorage.removeItem('currentUser');
          sessionStorage.removeItem('pendingRequestNo');
          sessionStorage.removeItem('pendingPage');
          sessionStorage.removeItem('adminStatusFilter');
          
          const loginUrl = '?page=login';
          if (window.top && window.top !== window) {
            window.top.location.href = loginUrl;
          } else {
            window.location.href = loginUrl;
          }
        }
      }
    }
  </script>
</body>
</html>

