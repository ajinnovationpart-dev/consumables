<!--
  목적: Apps Script / Google Sheets 기반 부품발주 웹앱 및 관련 환경에서 발생하는
        접근 권한, 시트/데이터, 통계 페이지 로딩 문제 해결 가이드.
  대상: Apps Script 웹앱 사용 시. React+Node(로컬 Excel) 구성은 SYSTEM_INFRASTRUCTURE.md, CHECKLIST.md 참고.
-->

# 문제 해결 가이드

<!-- 목차: 접근 권한 → 기타 일반 오류 → 통계 페이지 데이터 로딩 → 디버깅 체크리스트 -->

## 접근 권한 오류 해결

### 증상
"접근 권한이 없습니다" 오류 화면이 표시됨

### 원인
1. **사용자가 사용자관리 시트에 등록되지 않음**
2. **사용자의 활성화 상태가 'N'**
3. **이메일 주소가 정확히 일치하지 않음**

### 해결 방법

#### 1단계: 현재 로그인한 이메일 확인

1. Apps Script 에디터에서 **실행** → **doGet** 선택
2. **실행** 버튼 클릭
3. **로그 보기**에서 현재 사용자 이메일 확인
   - 예: `Current user email: user@company.com`

#### 2단계: 사용자관리 시트에 사용자 추가

1. 스프레드시트의 **사용자관리** 시트 열기
2. 새 행 추가 (헤더 아래)
3. 다음 형식으로 입력:

```
이메일 | 이름 | 기사코드 | 소속팀 | 지역 | 역할 | 활성화
user@company.com | 홍길동 | 1234567 | 서울1팀 | 서울 | 신청자 | Y
```

**중요 사항**:
- **이메일**: 로그인한 Google 계정 이메일과 정확히 일치해야 함
- **활성화**: 반드시 `Y`로 설정
- **역할**: `신청자` 또는 `관리자`

#### 3단계: 시트 구조 확인

**사용자관리 시트** 헤더가 정확한지 확인:

| A | B | C | D | E | F | G |
|---|---|---|---|---|---|---|
| 이메일 | 이름 | 기사코드 | 소속팀 | 지역 | 역할 | 활성화 |

#### 4단계: 데이터 형식 확인

- **이메일 (A열)**: 전체 이메일 주소 (예: `user@company.com`)
- **활성화 (G열)**: 대문자 `Y` 또는 `N` (소문자 불가)

#### 5단계: 웹 앱 재접속

1. 브라우저에서 웹 앱 URL 다시 접속
2. 또는 **다시 시도** 버튼 클릭

### 디버깅 팁

#### 로그 확인 방법

1. Apps Script 에디터에서 **실행** → **로그 보기**
2. 다음 메시지 확인:
   - `Current user email: [이메일]`
   - `User found: Yes/No`
   - `User role: [역할], Active: [활성화]`

#### 일반적인 실수

1. **이메일 불일치**
   - 로그인한 이메일: `user@gmail.com`
   - 시트에 등록된 이메일: `user@company.com`
   - → 정확히 일치해야 함

2. **활성화 상태 오류**
   - `Y` (대문자)만 허용
   - `y`, `yes`, `1` 등은 인식 안 됨

3. **빈 행 문제**
   - 헤더와 데이터 사이에 빈 행이 있으면 안 됨
   - 데이터는 헤더 바로 아래부터 시작

4. **시트 이름 오류**
   - 시트 이름이 정확히 `사용자관리`여야 함
   - 공백이나 오타 확인

### 테스트 방법

#### 테스트 사용자 추가

1. **사용자관리** 시트에 테스트 계정 추가:
```
test@company.com | 테스트 | - | 본사 | 천안 | 관리자 | Y
```

2. 테스트 계정으로 로그인하여 접속 확인

#### 관리자 계정 확인

최소 1명의 관리자 계정이 필요:
```
admin@company.com | 관리자 | - | 본사 | 천안 | 관리자 | Y
```

### 추가 확인 사항

1. **시트가 비어있지 않은지 확인**
   - 헤더만 있고 데이터가 없으면 오류 발생

2. **CONFIG 설정 확인**
   - `Config.gs`에서 `SHEETS.USERS` 값이 `'사용자관리'`인지 확인

3. **권한 문제**
   - 스프레드시트에 대한 읽기 권한이 있는지 확인
   - 웹 앱 배포 시 권한 설정 확인

### 여전히 해결되지 않는 경우

1. **Apps Script 실행 로그 전체 확인**
   - 에러 메시지 확인
   - 스택 트레이스 확인

2. **시트 직접 확인**
   - 사용자관리 시트가 정상적으로 열리는지
   - 데이터가 올바르게 입력되어 있는지

3. **초기 설정 재실행**
   - `initialSetup()` 함수 재실행
   - 시트 구조 재생성

4. **관리자에게 문의**
   - 사용자 등록 요청
   - 시스템 접근 권한 확인

---

## 기타 일반적인 오류

### 오류: "시트를 찾을 수 없습니다"

**원인**: 시트 이름이 정확하지 않음

**해결**:
1. 시트 이름 확인 (대소문자 구분)
2. `initialSetup()` 함수 재실행

### 오류: "사용자 정보를 찾을 수 없습니다"

**원인**: 사용자관리 시트에 사용자 미등록

**해결**: 위의 "접근 권한 오류 해결" 참조

### 오류: "권한이 필요합니다"

**원인**: Apps Script 권한 미승인

**해결**:
1. Apps Script 에디터에서 권한 재승인
2. 웹 앱 재배포

### 오류: 사진 업로드 실패

**원인**: Drive 폴더 미설정

**해결**:
1. `initializeProperties()` 함수 실행
2. Drive 폴더 생성 확인

---

## 통계 페이지 데이터 로딩 문제 해결

<!-- React+Node 구성의 통계 문제는 docs/CHECKLIST.md "프론트 데이터 로딩 점검" 참고. 아래는 Apps Script/Sheets 기준. -->

### 증상

```
getAllRequests result: null
No requests found
```

### 확인 사항

#### 1. Apps Script 실행 로그 확인

**방법:**
1. Apps Script Editor 열기
2. 왼쪽 메뉴에서 "실행" 클릭
3. 최근 실행 로그 확인

**찾아볼 로그:**
- **정상**: `getAllRequests: START`, `getAllRequests: user = admin (관리자)`, `RequestModel.findAll: Sheet has 150 rows`, `getAllRequests: SUCCESS - Returning 149 requests`
- **에러 1 (권한)**: `getAllRequests: ERROR - Not admin, role = 사용자` → 관리자 권한 없음
- **에러 2 (시트 없음)**: `RequestModel.findAll: ERROR - Cannot read property 'getDataRange'` → '신청내역' 시트 없음/이름 다름
- **에러 3 (데이터 없음)**: `RequestModel.findAll: No data rows found` → 시트에 헤더만 있고 데이터 없음

#### 2. Google Sheets 데이터 확인

1. Google Sheets 문서 열기
2. '신청내역' 시트 선택
3. 헤더 행(1행) 및 데이터 행(2행 이하) 존재 여부 확인

#### 3. 시트 이름 확인

`Config.gs`의 `SHEETS.REQUESTS` 값이 `'신청내역'`이고, 실제 시트 탭 이름과 일치해야 함. 공백/오타 없을 것.

### 해결 방법

1. **테스트 데이터 추가**: 신청 등록 페이지에서 테스트 신청 1~2건 등록 후 관리자 대시보드 → 통계 재조회
2. **initialSetup 실행**: 시트가 없거나 구조가 잘못된 경우 Triggers.gs에서 `initialSetup()` 실행
3. **관리자 권한 확인**: '사용자관리' 시트에서 현재 계정의 역할이 "관리자", 활성여부 "Y"인지 확인
4. **상세 로그**: F12 콘솔에서 `getAllRequests result` 확인, Apps Script 실행 로그에서 `getAllRequests`/`RequestModel.findAll` 메시지 확인

### 정상 작동 시 예상 로그 (참고)

- **브라우저**: `getAllRequests result: 150 items`, `Filtered requests: 50 out of 150` 등
- **Apps Script**: `getAllRequests: SUCCESS - Returning 150 requests`

### 긴급 임시 조치

데이터가 전혀 없을 때: Google Sheets '신청내역' 시트 2행에 샘플 행 수동 입력 후 통계 페이지 새로고침.

### 통계 페이지 최종 체크리스트

- [ ] '신청내역' 시트 존재
- [ ] 시트에 헤더 행 및 데이터 행 1개 이상
- [ ] 현재 계정이 '사용자관리'에 등록, 역할 "관리자", 활성 "Y"
- [ ] Apps Script 최신 배포, 브라우저 캐시 삭제 (Ctrl+Shift+R)

---

## 디버깅 체크리스트

- [ ] 사용자 이메일이 사용자관리 시트에 등록되어 있음
- [ ] 활성화 상태가 'Y'로 설정됨
- [ ] 시트 이름이 정확함 ('사용자관리')
- [ ] 헤더 행이 올바름
- [ ] 빈 행이 없음
- [ ] 이메일 주소가 정확히 일치함
- [ ] Apps Script 권한이 승인됨
- [ ] 웹 앱이 올바르게 배포됨
